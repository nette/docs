Â¿CÃ³mo funcionan las aplicaciones?
*********************************
<div class=perex>


EstÃ¡ leyendo el documento bÃ¡sico de la documentaciÃ³n de Nette. AprenderÃ¡ todo el principio de las aplicaciones web. Nette de la A a la Z, desde el momento del nacimiento hasta el Ãºltimo suspiro del script PHP. DespuÃ©s de leer usted sabrÃ¡:

- cÃ³mo funciona todo
- quÃ© es Bootstrap, Presenter y DI container
- cÃ³mo es la estructura de directorios

</div>


Estructura del directorio .[#toc-directory-structure]
=====================================================

Abra un esqueleto de ejemplo de una aplicaciÃ³n web llamada [WebProject |https://github.com/nette/web-project] y podrÃ¡ observar los archivos sobre los que se escribe.

La estructura de directorios se parece a esto

/--pre
<b>web-project/</b>
â”œâ”€â”€ <b>app/</b>                      â† directorio con la aplicaciÃ³n
â”‚   â”œâ”€â”€ <b>Presenters/</b>           â† clases para presentadores
â”‚   â”‚   â”œâ”€â”€ <b>HomepagePresenter.php</b>  â† Homepage de inicio de la clase de presentador
â”‚   â”‚   â””â”€â”€ <b>templates/</b>        â† directorio de plantillas
â”‚   â”‚       â”œâ”€â”€ <b>@layout.latte</b> â† plantilla de diseÃ±o compartida
â”‚   â”‚       â””â”€â”€ <b>Homepage/</b>     â† plantillas para Homepage presentador de inicio
â”‚   â”‚           â””â”€â”€ <b>default.latte</b>  â† plantilla para la acciÃ³n `default`
â”‚   â”œâ”€â”€ <b>Router/</b>               â† configuraciÃ³n de direcciones URL
â”‚   â””â”€â”€ <b>Bootstrap.php</b>         â† clase de arranque Bootstrap
â”œâ”€â”€ <b>bin/</b>                      â† scripts para la lÃ­nea de comandos
â”œâ”€â”€ <b>config/</b>                   â† archivos de configuraciÃ³n
â”‚   â”œâ”€â”€ <b>common.neon</b>
â”‚   â””â”€â”€ <b>local.neon</b>
â”œâ”€â”€ <b>log/</b>                      â† registros de errores
â”œâ”€â”€ <b>temp/</b>                     â† archivos temporales, cachÃ©, ...
â”œâ”€â”€ <b>vendor/</b>                   â† libraries installed by Composer
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ <b>autoload.php</b>          â† carga automÃ¡tica de librerÃ­as instaladas por Composer
â”œâ”€â”€ <b>www/</b>                      â† directorio pÃºblico, raÃ­z documental del proyecto
â”‚   â”œâ”€â”€ <b>.htaccess</b>             â† reglas mod_rewrite, etc.
â”‚   â””â”€â”€ <b>index.php</b>             â† archivo inicial que lanza la aplicaciÃ³n
â””â”€â”€ <b>.htaccess</b>                 â† prohÃ­be el acceso a todos los directorios excepto www
\--

Puedes cambiar la estructura de directorios de cualquier forma, renombrar o mover carpetas, y entonces sÃ³lo tienes que editar las rutas a `log/` y `temp/` en el archivo `Bootstrap.php` y la ruta a este archivo en `composer.json` en la secciÃ³n `autoload`. Nada mÃ¡s, sin reconfiguraciones complicadas ni cambios constantes. Nette tiene una [autodetecciÃ³n inteligente |bootstrap#development-vs-production-mode].

Para aplicaciones un poco mÃ¡s grandes, podemos dividir las carpetas con presentadores y plantillas en subdirectorios (en el disco) y en espacios de nombres (en el cÃ³digo), que llamamos [mÃ³dulos |modules].

El directorio `www/` es el directorio pÃºblico o raÃ­z documental del proyecto. Puedes renombrarlo sin tener que configurar nada mÃ¡s en el lado de la aplicaciÃ³n. Solo necesitas [configurar el hosting |nette:troubleshooting#How to change or remove www directory from URL] para que el document-root vaya a este directorio.

TambiÃ©n puede descargar el WebProject directamente, incluyendo Nette, utilizando [Composer |best-practices:composer]:

```shell
composer create-project nette/web-project
```

En Linux o macOS, establezca los [permisos de escritura |nette:troubleshooting#Setting directory permissions] para los directorios `log/` y `temp/`.

La aplicaciÃ³n WebProject estÃ¡ lista para ejecutarse, no es necesario configurar nada mÃ¡s y puede verla directamente en el navegador accediendo a la carpeta `www/`.


PeticiÃ³n HTTP .[#toc-http-request]
==================================

Todo comienza cuando un usuario abre la pÃ¡gina en un navegador y Ã©ste llama al servidor con una peticiÃ³n HTTP. La peticiÃ³n va a un fichero PHP situado en el directorio pÃºblico `www/`, que es `index.php`. Supongamos que se trata de una peticiÃ³n a `https://example.com/product/123` y se ejecutarÃ¡.

Su tarea es:

1) inicializar el entorno
2) obtener la fÃ¡brica
3) lanzar la aplicaciÃ³n Nette que gestiona la solicitud

Â¿QuÃ© tipo de fÃ¡brica? No fabricamos tractores, Â¡sino pÃ¡ginas web! Espere, se lo explicaremos enseguida.

Por "inicializar el entorno" entendemos, por ejemplo, que se activa [Tracy |tracy:], que es una herramienta increÃ­ble para registrar o visualizar errores. Registra los errores en el servidor de producciÃ³n y los muestra directamente en el servidor de desarrollo. Por lo tanto, la inicializaciÃ³n tambiÃ©n necesita decidir si el sitio se estÃ¡ ejecutando en modo de producciÃ³n o de desarrollo. Para ello, Nette utiliza la autodetecciÃ³n: si ejecuta el sitio en localhost, se ejecuta en modo desarrollador. No hay que configurar nada y la aplicaciÃ³n estÃ¡ lista tanto para el desarrollo como para el despliegue en producciÃ³n. Estos pasos se realizan y describen en detalle en el capÃ­tulo sobre la [clase Bootstrap |bootstrap].

El tercer punto (sÃ­, nos hemos saltado el segundo, pero volveremos a Ã©l) es iniciar la aplicaciÃ³n. El manejo de las peticiones HTTP en Nette lo realiza la clase `Nette\Application\Application` (en adelante `Application`), por lo que cuando decimos "ejecutar una aplicaciÃ³n", nos referimos a llamar a un mÃ©todo con el nombre `run()` sobre un objeto de esta clase.

Nette es un mentor que te guÃ­a para escribir aplicaciones limpias mediante metodologÃ­as probadas. Y la mÃ¡s probada se llama **inyecciÃ³n de dependencia**, abreviada DI. De momento no queremos agobiarte explicando DI, ya que hay un [capÃ­tulo |dependency-injection:introduction] aparte, lo importante aquÃ­ es que los objetos clave normalmente serÃ¡n creados por una fÃ¡brica de objetos llamada **contenedor DI** (abreviado DIC). SÃ­, esta es la fÃ¡brica que se mencionÃ³ hace un rato. Y tambiÃ©n crea el objeto `Application` por nosotros, asÃ­ que primero necesitamos un contenedor. Lo obtenemos usando la clase `Configurator` y dejamos que produzca el objeto `Application`, llamamos al mÃ©todo `run()` y esto inicia la aplicaciÃ³n Nette. Esto es exactamente lo que sucede en el archivo [index.php |bootstrap#index.php].


AplicaciÃ³n Nette .[#toc-nette-application]
==========================================

La clase AplicaciÃ³n tiene una Ãºnica tarea: responder a una peticiÃ³n HTTP.

Las aplicaciones escritas en Nette se dividen en muchos de los llamados presentadores (en otros frameworks se puede encontrar con el tÃ©rmino controlador, que es lo mismo), que son clases que representan una pÃ¡gina web especÃ­fica: por ejemplo, pÃ¡gina de inicio; producto en e-shop; formulario de registro; feed sitemap, etc. La aplicaciÃ³n puede tener de uno a miles de presentadores.

La aplicaciÃ³n comienza pidiendo al llamado enrutador que decida a cuÃ¡l de los presentadores debe pasar la peticiÃ³n actual para su procesamiento. El enrutador decide de quiÃ©n es la responsabilidad. Mira la URL de entrada `https://example.com/product/123`, que quiere `show` un producto con `id: 123` como acciÃ³n. Es una buena costumbre escribir pares de presentador + acciÃ³n separados por dos puntos como `Product:show`.

AsÃ­ que el enrutador transforma la URL en un par `Presenter:action` + parÃ¡metros, en nuestro caso `Product:show` + `id: 123`. Puedes ver el aspecto de un enrutador en el archivo `app/Router/RouterFactory.php` y lo describiremos en detalle en el capÃ­tulo [Enrutamiento |Routing].

Sigamos. La aplicaciÃ³n ya conoce el nombre del presentador y puede continuar. Creando un objeto `ProductPresenter`, que es el cÃ³digo del presentador `Product`. MÃ¡s concretamente, le pide al contenedor DI que cree el presentador, porque producir objetos es su trabajo.

El presentador podrÃ­a tener este aspecto:

```php
class ProductPresenter extends Nette\Application\UI\Presenter
{
	public function __construct(
		private ProductRepository $repository,
	) {
	}

	public function renderShow(int $id): void
	{
		// obtenemos datos del modelo y los pasamos a la plantilla
		$this->template->product = $this->repository->getProduct($id);
	}
}
```

El presentador gestiona la solicitud. Y la tarea estÃ¡ clara: hacer la acciÃ³n `show` con `id: 123`. Lo que en el lenguaje de los presentadores significa que se llama al mÃ©todo `renderShow()` y en el parÃ¡metro `$id` se obtiene `123`.

Un presentador puede manejar mÃºltiples acciones, es decir, tener mÃºltiples mÃ©todos `render<Action>()`. Pero recomendamos diseÃ±ar los presentadores con una o las menos acciones posibles.

AsÃ­, se llamÃ³ al mÃ©todo `renderShow(123)`, cuyo cÃ³digo es ficticio ejemplo, pero se puede ver en Ã©l cÃ³mo los datos se pasan a la plantilla, es decir, escribiendo a `$this->template`.

Posteriormente, el presentador devuelve la respuesta. Esta puede ser una pÃ¡gina HTML, una imagen, un documento XML, el envÃ­o de un fichero desde disco, JSON o la redirecciÃ³n a otra pÃ¡gina. Es importante destacar que, si no decimos explÃ­citamente cÃ³mo responder (que es el caso de `ProductPresenter`), la respuesta serÃ¡ renderizar la plantilla con una pÃ¡gina HTML. Â¿Por quÃ©? Pues porque en el 99% de los casos queremos dibujar una plantilla, asÃ­ que el presentador toma este comportamiento por defecto y quiere facilitarnos el trabajo. Ese es el punto de Nette.

Ni siquiera tenemos que indicar quÃ© plantilla dibujar, Ã©l deriva la ruta hacia ella segÃºn una lÃ³gica simple. En el caso del presentador `Product` y la acciÃ³n `show`, intenta ver si uno de estos archivos de plantilla existe en relaciÃ³n al directorio donde se encuentra la clase `ProductPresenter`:

- `templates/Product/show.latte`
- `templates/Product.show.latte`

TambiÃ©n intentarÃ¡ encontrar el diseÃ±o en el archivo `@layout.latte` y luego renderizarÃ¡ la plantilla. Ahora se completa la tarea del presentador y de toda la aplicaciÃ³n. Si la plantilla no existe, se devolverÃ¡ una pÃ¡gina con el error 404. Puedes leer mÃ¡s sobre los presentadores en la pÃ¡gina de [Presentadores |Presenters].

[* request-flow.svg *]

SÃ³lo para estar seguros, intentemos recapitular todo el proceso con una URL ligeramente diferente:

1) la URL serÃ¡ `https://example.com`
2) arrancamos la aplicaciÃ³n, creamos un contenedor y ejecutamos `Application::run()`
3) el router decodifica la URL como un par `Homepage:default`
4) se crea un objeto `HomepagePresenter`
5) se llama al mÃ©todo `renderDefault()` (si existe)
6) se renderiza una plantilla `templates/Homepage/default.latte` con un diseÃ±o `templates/@layout.latte`


Puede que ahora te hayas encontrado con un montÃ³n de conceptos nuevos, pero creemos que tienen sentido. Crear aplicaciones en Nette es pan comido.


Plantillas .[#toc-templates]
============================

Cuando se trata de las plantillas, Nette utiliza el sistema de plantillas [Latte |latte:]. Es por eso que los archivos con plantillas terminan con `.latte`. Se usa Latte porque es el sistema de plantillas mÃ¡s seguro para PHP, y al mismo tiempo el sistema mÃ¡s intuitivo. No tienes que aprender mucho nuevo, sÃ³lo necesitas saber PHP y algunas etiquetas Latte. EncontrarÃ¡s todo [en la documentaciÃ³n |latte:].

En la plantilla [creamos enlaces |creating-links] a otros presentadores y acciones de la siguiente manera:

```latte
<a n:href="Product:show $productId">product detail</a>
```

Basta con escribir el conocido par `Presenter:action` en lugar de la URL real e incluir cualquier parÃ¡metro. El truco es `n:href`, que dice que este atributo serÃ¡ procesado por Nette. Y lo generarÃ¡:

```latte
<a href="/product/456">product detail</a>
```

El enrutador antes mencionado es el encargado de generar la URL. De hecho, los routers en Nette son Ãºnicos en el sentido de que pueden realizar no sÃ³lo transformaciones de una URL a un par presentador:acciÃ³n, sino tambiÃ©n viceversa generar una URL a partir del nombre del presentador + acciÃ³n + parÃ¡metros.
Gracias a esto, en Nette se puede cambiar completamente la forma de la URL en toda la aplicaciÃ³n terminada sin cambiar ni un solo carÃ¡cter de la plantilla o presentador sÃ³lo modificando el enrutador.
Y gracias a esto, funciona la llamada canonizaciÃ³n, que es otra caracterÃ­stica Ãºnica de Nette, que mejora el SEO (optimizaciÃ³n de la buscabilidad en internet) evitando automÃ¡ticamente la existencia de contenido duplicado en diferentes URLs.
A muchos programadores esto les parece asombroso.


Componentes interactivos .[#toc-interactive-components]
=======================================================

Tenemos una cosa mÃ¡s que contarte sobre los presentadores: tienen un sistema de componentes incorporado. Los mÃ¡s veteranos recordarÃ©is algo parecido de Delphi o ASP.NET Web Forms. React o Vue.js estÃ¡n construidos sobre algo remotamente similar. En el mundo de los frameworks PHP, esta es una caracterÃ­stica completamente Ãºnica.

Los componentes son unidades separadas reutilizables que colocamos en pÃ¡ginas (es decir, presentadores). Pueden ser [formularios |forms:in-presenter], [datagrids |https://componette.org/contributte/datagrid/], menÃºs, encuestas, de hecho cualquier cosa que tenga sentido usar repetidamente. Podemos crear nuestros propios componentes o utilizar algunos de la [enorme gama |https://componette.org] de componentes de cÃ³digo abierto.

Los componentes cambian radicalmente el enfoque del desarrollo de aplicaciones. AbrirÃ¡n nuevas posibilidades para componer pÃ¡ginas a partir de unidades predefinidas. Y tienen algo en comÃºn con [Hollywood |components#Hollywood style].


Contenedor DI y configuraciÃ³n .[#toc-di-container-and-configuration]
====================================================================

El contenedor DI (fÃ¡brica de objetos) es el corazÃ³n de toda la aplicaciÃ³n.

No te preocupes, no es una caja negra mÃ¡gica, como podrÃ­a parecer por las palabras anteriores. En realidad, es una clase PHP bastante aburrida generada por Nette y almacenada en un directorio cachÃ©. Tiene un montÃ³n de mÃ©todos llamados como `createServiceAbcd()` y cada uno de ellos crea y devuelve un objeto. SÃ­, tambiÃ©n hay un mÃ©todo `createServiceApplication()` que producirÃ¡ `Nette\Application\Application`, que necesitamos en el archivo `index.php` para ejecutar la aplicaciÃ³n. Y hay mÃ©todos para producir presentadores individuales. Y asÃ­ sucesivamente.

Los objetos que crea el contenedor DI se llaman servicios por alguna razÃ³n.

Lo realmente especial de esta clase es que no es programada por ti, sino por el framework. En realidad genera el cÃ³digo PHP y lo guarda en el disco. TÃº sÃ³lo das instrucciones sobre quÃ© objetos debe ser capaz de producir el contenedor y cÃ³mo exactamente. Y estas instrucciones estÃ¡n escritas en [archivos de configuraciÃ³n |bootstrap#DI Container Configuration] en el [formato NEON |neon:format] y por lo tanto tienen la extensiÃ³n `.neon`.

Los archivos de configuraciÃ³n se utilizan Ãºnicamente para dar instrucciones al contenedor DI. AsÃ­, por ejemplo, si especifico la opciÃ³n `expiration: 14 days` en la secciÃ³n de [sesiÃ³n |http:configuration#Session], el contenedor DI al crear el objeto `Nette\Http\Session` que representa la sesiÃ³n llamarÃ¡ a su mÃ©todo `setExpiration('14 days')`, y asÃ­ la configuraciÃ³n se hace realidad.

Hay todo un capÃ­tulo preparado para ti, describiendo quÃ© se puede [configurar |nette:configuring] y cÃ³mo [definir tus propios servicios |dependency-injection:services].

Una vez que te adentres en la creaciÃ³n de servicios, te encontrarÃ¡s con la palabra [autocableado |dependency-injection:autowiring]. Este es un gadget que te harÃ¡ la vida increÃ­blemente mÃ¡s fÃ¡cil. Puede pasar objetos automÃ¡ticamente donde los necesites (en los constructores de tus clases, por ejemplo) sin que tengas que hacer nada. Usted encontrarÃ¡ que el contenedor DI en Nette es un pequeÃ±o milagro.


Â¿Y ahora quÃ©? .[#toc-what-next]
===============================

Hemos repasado los principios bÃ¡sicos de las aplicaciones en Nette. Hasta aquÃ­, muy superficialmente, pero pronto ahondarÃ¡s en las profundidades y acabarÃ¡s creando maravillosas aplicaciones web. Â¿DÃ³nde continuar? Â¿Has probado el tutorial [Crea tu primera |quickstart:getting-started] aplicaciÃ³n?

AdemÃ¡s de lo anterior, Nette tiene todo un arsenal de [clases Ãºtiles |utils:], [capa de base de datos |database:], etc. Prueba a hacer clic a propÃ³sito en la documentaciÃ³n. O visita [el blog |https://blog.nette.org]. DescubrirÃ¡s un montÃ³n de cosas interesantes.

Deje que el marco de traer un montÃ³n de alegrÃ­a ğŸ’™
