Jak dziaÅ‚ajÄ… aplikacje?
***********************

<div class=perex>

WÅ‚aÅ›nie czytasz podstawowy dokument dokumentacji Nette. Dowiesz siÄ™ caÅ‚ego zasady dziaÅ‚ania aplikacji internetowych. Åadnie od A do Z, od chwili narodzin aÅ¼ do ostatniego tchnienia skryptu PHP. Po przeczytaniu bÄ™dziesz wiedzieÄ‡:

- jak to wszystko dziaÅ‚a
- co to jest Bootstrap, Presenter i kontener DI
- jak wyglÄ…da struktura katalogÃ³w

</div>


Struktura katalogÃ³w
===================

OtwÃ³rz przykÅ‚ad szkieletu aplikacji internetowej o nazwie [WebProject|https://github.com/nette/web-project] i podczas czytania moÅ¼esz patrzeÄ‡ na pliki, o ktÃ³rych jest mowa.

Struktura katalogÃ³w wyglÄ…da mniej wiÄ™cej tak:

/--pre
<b>web-project/</b>
â”œâ”€â”€ <b>app/</b>                      â† katalog z aplikacjÄ…
â”‚   â”œâ”€â”€ <b>Core/</b>                 â† podstawowe klasy niezbÄ™dne do dziaÅ‚ania
â”‚   â”‚   â””â”€â”€ <b>RouterFactory.php</b> â† konfiguracja adresÃ³w URL
â”‚   â”œâ”€â”€ <b>Presentation/</b>         â† presentery, szablony i spÃ³Å‚ka.
â”‚   â”‚   â”œâ”€â”€ <b>@layout.latte</b>     â† szablon layoutu
â”‚   â”‚   â””â”€â”€ <b>Home/</b>             â† katalog presentera Home
â”‚   â”‚       â”œâ”€â”€ <b>HomePresenter.php</b> â† klasa presentera Home
â”‚   â”‚       â””â”€â”€ <b>default.latte</b> â† szablon akcji default
â”‚   â””â”€â”€ <b>Bootstrap.php</b>         â† klasa startowa Bootstrap
â”œâ”€â”€ <b>bin/</b>                      â† skrypty uruchamiane z wiersza poleceÅ„
â”œâ”€â”€ <b>config/</b>                   â† pliki konfiguracyjne
â”‚   â”œâ”€â”€ <b>common.neon</b>
â”‚   â””â”€â”€ <b>services.neon</b>
â”œâ”€â”€ <b>log/</b>                      â† zalogowane bÅ‚Ä™dy
â”œâ”€â”€ <b>temp/</b>                     â† pliki tymczasowe, cache, â€¦
â”œâ”€â”€ <b>vendor/</b>                   â† biblioteki zainstalowane przez Composer
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ <b>autoload.php</b>          â† autoloading wszystkich zainstalowanych pakietÃ³w
â”œâ”€â”€ <b>www/</b>                      â† katalog publiczny czyli document-root projektu
â”‚   â”œâ”€â”€ <b>.htaccess</b>             â† reguÅ‚y mod_rewrite
â”‚   â””â”€â”€ <b>index.php</b>             â† pierwszy plik, ktÃ³rym uruchamia siÄ™ aplikacja
â””â”€â”€ <b>.htaccess</b>                 â† zabrania dostÄ™pu do wszystkich katalogÃ³w oprÃ³cz www
\--

StrukturÄ™ katalogÃ³w moÅ¼na dowolnie zmieniaÄ‡, foldery przemianowaÄ‡ lub przenieÅ›Ä‡, jest caÅ‚kowicie elastyczna. Nette dodatkowo dysponuje inteligentnÄ… autodetekcjÄ… i automatycznie rozpozna lokalizacjÄ™ aplikacji, w tym jej bazÄ™ URL.

W nieco wiÄ™kszych aplikacjach moÅ¼emy foldery z presenterami i szablonami [podzieliÄ‡ na podkatalogi |directory-structure#Presentery a Å¡ablony] i klasy na przestrzenie nazw, ktÃ³re nazywamy moduÅ‚ami.

Katalog `www/` reprezentuje tzw. katalog publiczny czyli document-root projektu. MoÅ¼na go przemianowaÄ‡ bez koniecznoÅ›ci ustawiania czegokolwiek dodatkowego po stronie aplikacji. Trzeba tylko [skonfigurowaÄ‡ hosting |nette:troubleshooting#Jak zmÄ›nit Äi ostranit z URL adresÃ¡Å™ www] tak, aby document-root wskazywaÅ‚ na ten katalog.

WebProject moÅ¼na rÃ³wnieÅ¼ od razu pobraÄ‡ wraz z Nette za pomocÄ… [Composera |best-practices:composer]:

```shell
composer create-project nette/web-project
```

Na Linuksie lub macOS ustaw katalogom `log/` i `temp/` [prawa do zapisu |nette:troubleshooting#NastavenÃ­ prÃ¡v adresÃ¡Å™Å¯].

Aplikacja WebProject jest gotowa do uruchomienia, nie trzeba niczego konfigurowaÄ‡ i moÅ¼na jÄ… od razu wyÅ›wietliÄ‡ w przeglÄ…darce, uzyskujÄ…c dostÄ™p do folderu `www/`.


Å»Ä…danie HTTP
============

Wszystko zaczyna siÄ™ w chwili, gdy uÅ¼ytkownik w przeglÄ…darce otwiera stronÄ™. Czyli gdy przeglÄ…darka puka do serwera z Å¼Ä…daniem HTTP. Å»Ä…danie kieruje siÄ™ na jeden plik PHP, ktÃ³ry znajduje siÄ™ w publicznym katalogu `www/`, a jest nim `index.php`. Powiedzmy, Å¼e chodzi o Å¼Ä…danie na adres `https://example.com/product/123`. DziÄ™ki odpowiedniemu [ustawieniu serwera|nette:troubleshooting#Jak nastavit server pro hezkÃ¡ URL?] rÃ³wnieÅ¼ ten URL mapuje siÄ™ na plik `index.php` i ten siÄ™ wykonuje.

Jego zadaniem jest:

1) zainicjalizowanie Å›rodowiska
2) uzyskanie fabryki
3) uruchomienie aplikacji Nette, ktÃ³ra obsÅ‚uÅ¼y Å¼Ä…danie

JakÄ… fabrykÄ™? PrzecieÅ¼ nie produkujemy traktorÃ³w, ale strony internetowe! Poczekajcie, zaraz siÄ™ to wyjaÅ›ni.

SÅ‚owami â€inicjalizacja Å›rodowiskaâ€ rozumiemy na przykÅ‚ad to, Å¼e aktywuje siÄ™ [Tracy|tracy:], co jest niesamowitym narzÄ™dziem do logowania lub wizualizacji bÅ‚Ä™dÃ³w. Na serwerze produkcyjnym bÅ‚Ä™dy loguje, na deweloperskim od razu wyÅ›wietla. Dlatego do inicjalizacji naleÅ¼y rÃ³wnieÅ¼ decyzja, czy strona dziaÅ‚a w trybie produkcyjnym czy deweloperskim. Do tego Nette uÅ¼ywa [inteligentnej autodetekcji|bootstrap#vyvojarsky-vs-produkcni-rezim]: jeÅ›li stronÄ™ uruchamiasz na localhost, dziaÅ‚a w trybie deweloperskim. Nie musisz wiÄ™c nic konfigurowaÄ‡, a aplikacja jest od razu gotowa zarÃ³wno do rozwoju, jak i ostrego wdroÅ¼enia. Te kroki sÄ… wykonywane i szczegÃ³Å‚owo opisane w rozdziale o [klasie Bootstrap|bootstrap].

Trzecim punktem (tak, drugi pominÄ™liÅ›my, ale wrÃ³cimy do niego) jest uruchomienie aplikacji. ObsÅ‚ugÄ… Å¼Ä…daÅ„ HTTP w Nette zajmuje siÄ™ klasa `Nette\Application\Application` (dalej `Application`), wiÄ™c gdy mÃ³wimy uruchomiÄ‡ aplikacjÄ™, mamy na myÅ›li konkretnie wywoÅ‚anie metody o wymownej nazwie `run()` na obiekcie tej klasy.

Nette jest mentorem, ktÃ³ry prowadzi CiÄ™ do pisania czystych aplikacji wedÅ‚ug sprawdzonych metodyk. A jedna z tych absolutnie najsprawdzonych nazywa siÄ™ **dependency injection**, w skrÃ³cie DI. W tej chwili nie chcemy CiÄ™ obciÄ…Å¼aÄ‡ wyjaÅ›nianiem DI, od tego jest [osobny rozdziaÅ‚|dependency-injection:introduction], istotny jest skutek, Å¼e kluczowe obiekty bÄ™dzie nam zazwyczaj tworzyÄ‡ fabryka obiektÃ³w, ktÃ³rej mÃ³wi siÄ™ **kontener DI** (w skrÃ³cie DIC). Tak, to ta fabryka, o ktÃ³rej byÅ‚a przed chwilÄ… mowa. I wyprodukuje nam rÃ³wnieÅ¼ obiekt `Application`, dlatego potrzebujemy najpierw kontenera. Uzyskamy go za pomocÄ… klasy `Configurator` i pozwolimy mu wyprodukowaÄ‡ obiekt `Application`, wywoÅ‚amy na nim metodÄ™ `run()` i tym samym uruchomi siÄ™ aplikacja Nette. DokÅ‚adnie to dzieje siÄ™ w pliku [index.php|bootstrap#index.php].


Nette Application
=================

Klasa Application ma jedno zadanie: odpowiedzieÄ‡ na Å¼Ä…danie HTTP.

Aplikacje pisane w Nette dzielÄ… siÄ™ na mnÃ³stwo tzw. presenterÃ³w (w innych frameworkach moÅ¼na spotkaÄ‡ siÄ™ z terminem controller, chodzi o to samo), ktÃ³re sÄ… klasami, z ktÃ³rych kaÅ¼da reprezentuje jakÄ…Å› konkretnÄ… stronÄ™ internetowÄ…: np. stronÄ™ gÅ‚Ã³wnÄ…; produkt w e-sklepie; formularz logowania; kanaÅ‚ sitemap itp. Aplikacja moÅ¼e mieÄ‡ od jednego do tysiÄ™cy presenterÃ³w.

Application zaczyna od tego, Å¼e prosi tzw. router, aby zdecydowaÅ‚, ktÃ³remu z presenterÃ³w przekazaÄ‡ aktualne Å¼Ä…danie do obsÅ‚uÅ¼enia. Router decyduje, czyja to odpowiedzialnoÅ›Ä‡. SpoglÄ…da na wejÅ›ciowy URL `https://example.com/product/123` i na podstawie tego, jak jest ustawiony, decyduje, Å¼e to praca np. dla **presentera** `Product`, od ktÃ³rego bÄ™dzie chciaÅ‚ jako **akcjÄ™** wyÅ›wietlenie (`show`) produktu o `id: 123`. ParÄ™ presenter + akcja jest dobrym zwyczajem zapisywaÄ‡ oddzielonÄ… dwukropkiem jako `Product:show`.

Zatem router przeksztaÅ‚ciÅ‚ URL na parÄ™ `Presenter:action` + parametry, w naszym przypadku `Product:show` + `id: 123`. Jak taki router wyglÄ…da, moÅ¼na zobaczyÄ‡ w pliku `app/Core/RouterFactory.php` i szczegÃ³Å‚owo opisujemy go w rozdziale [Routing].

IdÅºmy dalej. Application juÅ¼ zna nazwÄ™ presentera i moÅ¼e kontynuowaÄ‡. TworzÄ…c obiekt klasy `ProductPresenter`, ktÃ³ry jest kodem presentera `Product`. DokÅ‚adniej mÃ³wiÄ…c, prosi kontener DI, aby wyprodukowaÅ‚ presenter, poniewaÅ¼ od produkowania jest on.

Presenter moÅ¼e wyglÄ…daÄ‡ na przykÅ‚ad tak:

```php
class ProductPresenter extends Nette\Application\UI\Presenter
{
	public function __construct(
		private ProductRepository $repository,
	) {
	}

	public function renderShow(int $id): void
	{
		// pobieramy dane z modelu i przekazujemy do szablonu
		$this->template->product = $this->repository->getProduct($id);
	}
}
```

ObsÅ‚ugÄ™ Å¼Ä…dania przejmuje presenter. A zadanie brzmi jasno: wykonaj akcjÄ™ `show` z `id: 123`. Co w jÄ™zyku presenterÃ³w oznacza, Å¼e wywoÅ‚ana zostanie metoda `renderShow()` i w parametrze `$id` otrzyma `123`.

Presenter moÅ¼e obsÅ‚ugiwaÄ‡ wiÄ™cej akcji, czyli mieÄ‡ wiÄ™cej metod `render<Action>()`. Ale zalecamy projektowanie presenterÃ³w z jednÄ… lub jak najmniejszÄ… liczbÄ… akcji.

Zatem, wywoÅ‚ano metodÄ™ `renderShow(123)`, ktÃ³rej kod jest wprawdzie wymyÅ›lonym przykÅ‚adem, ale moÅ¼na na nim zobaczyÄ‡, jak przekazuje siÄ™ dane do szablonu, czyli zapisem do `$this->template`.

NastÄ™pnie presenter zwraca odpowiedÅº. MoÅ¼e to byÄ‡ strona HTML, obrazek, dokument XML, wysÅ‚anie pliku z dysku, JSON lub na przykÅ‚ad przekierowanie na innÄ… stronÄ™. WaÅ¼ne jest, Å¼e jeÅ›li jawnie nie powiemy, jak ma odpowiedzieÄ‡ (co jest przypadkiem `ProductPresenter`), odpowiedziÄ… bÄ™dzie wyrenderowanie szablonu ze stronÄ… HTML. Dlaczego? PoniewaÅ¼ w 99% przypadkÃ³w chcemy wyrenderowaÄ‡ szablon, dlatego presenter to zachowanie traktuje jako domyÅ›lne i chce nam uÅ‚atwiÄ‡ pracÄ™. To jest sens Nette.

Nie musimy nawet podawaÄ‡, jaki szablon wyrenderowaÄ‡, Å›cieÅ¼kÄ™ do niego wywnioskuje sam. W przypadku akcji `show` po prostu sprÃ³buje zaÅ‚adowaÄ‡ szablon `show.latte` w katalogu z klasÄ… `ProductPresenter`. Podobnie sprÃ³buje odnaleÅºÄ‡ layout w pliku `@layout.latte` (wiÄ™cej o [wyszukiwaniu szablonÃ³w|templates#hledani-sablon]).

A nastÄ™pnie szablony wyrenderuje. Tym samym zadanie presentera i caÅ‚ej aplikacji jest zakoÅ„czone, a dzieÅ‚o jest ukoÅ„czone. JeÅ›li szablon by nie istniaÅ‚, zwrÃ³cona zostanie strona z bÅ‚Ä™dem 404. WiÄ™cej o presenterach przeczytasz na stronie [Presentery|presenters].

[* request-flow.svg *]

Dla pewnoÅ›ci, sprÃ³bujmy podsumowaÄ‡ caÅ‚y proces z nieco innym URL:

1) URL bÄ™dzie `https://example.com`
2) uruchamiamy aplikacjÄ™, tworzy siÄ™ kontener i uruchamia `Application::run()`
3) router dekoduje URL jako parÄ™ `Home:default`
4) tworzy siÄ™ obiekt klasy `HomePresenter`
5) wywoÅ‚ywana jest metoda `renderDefault()` (jeÅ›li istnieje)
6) renderowany jest szablon np. `default.latte` z layoutem np. `@layout.latte`


ByÄ‡ moÅ¼e spotkaÅ‚eÅ› siÄ™ teraz z duÅ¼Ä… iloÅ›ciÄ… nowych pojÄ™Ä‡, ale wierzymy, Å¼e majÄ… sens. Tworzenie aplikacji w Nette to ogromna przyjemnoÅ›Ä‡.


Szablony
========

Skoro juÅ¼ mowa o szablonach, w Nette uÅ¼ywa siÄ™ systemu szablonÃ³w [Latte |latte:]. Dlatego teÅ¼ te koÅ„cÃ³wki `.latte` przy szablonach. Latte uÅ¼ywa siÄ™ po pierwsze dlatego, Å¼e jest to najlepiej zabezpieczony system szablonÃ³w dla PHP, a jednoczeÅ›nie system najbardziej intuicyjny. Nie musisz uczyÄ‡ siÄ™ wielu nowych rzeczy, wystarczy znajomoÅ›Ä‡ PHP i kilku znacznikÃ³w. Wszystko dowiesz siÄ™ [w dokumentacji |templates].

W szablonie [tworzy siÄ™ linki |creating-links] do innych presenterÃ³w i akcji w ten sposÃ³b:

```latte
<a n:href="Product:show $productId">szczegÃ³Å‚y produktu</a>
```

Po prostu zamiast rzeczywistego URL wpisujesz znanÄ… parÄ™ `Presenter:action` i podajesz ewentualne parametry. Sztuczka tkwi w `n:href`, ktÃ³re mÃ³wi, Å¼e ten atrybut przetworzy Nette. I wygeneruje:

```latte
<a href="/product/456">szczegÃ³Å‚y produktu</a>
```

Generowaniem URL zajmuje siÄ™ juÅ¼ wczeÅ›niej wspomniany router. OtÃ³Å¼ routery w Nette sÄ… wyjÄ…tkowe tym, Å¼e potrafiÄ… wykonywaÄ‡ nie tylko transformacje z URL na parÄ™ presenter:action, ale takÅ¼e odwrotnie, czyli z nazwy presentera + akcji + parametrÃ³w wygenerowaÄ‡ URL.
DziÄ™ki temu w Nette moÅ¼esz caÅ‚kowicie zmieniÄ‡ ksztaÅ‚ty URL w caÅ‚ej gotowej aplikacji, nie zmieniajÄ…c ani jednego znaku w szablonie czy presenterze. Tylko przez modyfikacjÄ™ routera.
RÃ³wnieÅ¼ dziÄ™ki temu dziaÅ‚a tzw. kanonizacja, co jest kolejnÄ… unikalnÄ… cechÄ… Nette, ktÃ³ra przyczynia siÄ™ do lepszego SEO (optymalizacji dla wyszukiwarek internetowych) przez automatyczne zapobieganie istnieniu duplikatÃ³w treÅ›ci pod rÃ³Å¼nymi URL.
Wielu programistÃ³w uwaÅ¼a to za niesamowite.


Komponenty interaktywne
=======================

O presenterach musimy Ci jeszcze zdradziÄ‡ jednÄ… rzecz: majÄ… w sobie wbudowany system komponentÃ³w. CoÅ› podobnego mogÄ… pamiÄ™taÄ‡ weterani z Delphi lub ASP.NET Web Forms, na czymÅ› zdalnie podobnym opiera siÄ™ React czy Vue.js. W Å›wiecie frameworkÃ³w PHP jest to absolutnie unikalna sprawa.

Komponenty to samodzielne, wielokrotnego uÅ¼ytku caÅ‚oÅ›ci, ktÃ³re wstawiamy do stron (czyli presenterÃ³w). MogÄ… to byÄ‡ [formularze |forms:in-presenter], [siatki danych |https://componette.org/contributte/datagrid/], menu, ankiety, wÅ‚aÅ›ciwie cokolwiek, co ma sens uÅ¼ywaÄ‡ wielokrotnie. MoÅ¼emy tworzyÄ‡ wÅ‚asne komponenty lub uÅ¼ywaÄ‡ niektÃ³rych z [ogromnej oferty |https://componette.org] komponentÃ³w open source.

Komponenty zasadniczo wpÅ‚ywajÄ… na podejÅ›cie do tworzenia aplikacji. OtworzÄ… Ci nowe moÅ¼liwoÅ›ci skÅ‚adania stron z gotowych jednostek. A ponadto majÄ… coÅ› wspÃ³lnego z [Hollywoodem|components#Hollywood style].


Kontener DI i konfiguracja
==========================

Kontener DI czyli fabryka obiektÃ³w jest sercem caÅ‚ej aplikacji.

Nie obawiaj siÄ™, nie jest to Å¼aden magiczny black box, jak mogÅ‚oby siÄ™ wydawaÄ‡ z poprzednich linijek. WÅ‚aÅ›ciwie jest to jedna doÅ›Ä‡ nudna klasa PHP, ktÃ³rÄ… generuje Nette i zapisuje w katalogu z cache. Ma mnÃ³stwo metod nazwanych jak `createServiceAbcd()` i kaÅ¼da z nich potrafi wyprodukowaÄ‡ i zwrÃ³ciÄ‡ jakiÅ› obiekt. Tak, jest tam rÃ³wnieÅ¼ metoda `createServiceApplication()`, ktÃ³ra wyprodukuje `Nette\Application\Application`, ktÃ³rego potrzebowaliÅ›my w pliku `index.php` do uruchomienia aplikacji. I sÄ… tam metody produkujÄ…ce poszczegÃ³lne presentery. I tak dalej.

Obiektom, ktÃ³re tworzy kontener DI, z jakiegoÅ› powodu mÃ³wi siÄ™ usÅ‚ugi.

Co jest w tej klasie naprawdÄ™ specjalnego, to Å¼e nie programujesz jej Ty, ale framework. On rzeczywiÅ›cie generuje kod PHP i zapisuje go na dysku. Ty tylko dajesz instrukcje, jakie obiekty ma umieÄ‡ kontener produkowaÄ‡ i jak dokÅ‚adnie. A te instrukcje sÄ… zapisane w [plikach konfiguracyjnych|bootstrap#konfigurace-di-kontejneru], dla ktÃ³rych uÅ¼ywa siÄ™ formatu [NEON|neon:format] i dlatego majÄ… teÅ¼ rozszerzenie `.neon`.

Pliki konfiguracyjne sÅ‚uÅ¼Ä… czysto do instruowania kontenera DI. WiÄ™c gdy na przykÅ‚ad podam w sekcji [sesji|http:configuration#Session] opcjÄ™ `expiration: 14 days`, to kontener DI przy tworzeniu obiektu `Nette\Http\Session` reprezentujÄ…cego sesjÄ™ wywoÅ‚a jego metodÄ™ `setExpiration('14 days')` i tym samym konfiguracja stanie siÄ™ rzeczywistoÅ›ciÄ….

Jest tu dla Ciebie przygotowany caÅ‚y rozdziaÅ‚ opisujÄ…cy, co wszystko moÅ¼na [konfigurowaÄ‡ |nette:configuring] i jak [definiowaÄ‡ wÅ‚asne usÅ‚ugi |dependency-injection:services].

Jak tylko trochÄ™ zagÅ‚Ä™bisz siÄ™ w tworzenie usÅ‚ug, natkniesz siÄ™ na sÅ‚owo [autowiring |dependency-injection:autowiring]. To jest bajer, ktÃ³ry niesamowicie uproÅ›ci Ci Å¼ycie. Potrafi automatycznie przekazywaÄ‡ obiekty tam, gdzie ich potrzebujesz (na przykÅ‚ad w konstruktorach Twoich klas), bez koniecznoÅ›ci robienia czegokolwiek. Odkryjesz, Å¼e kontener DI w Nette to maÅ‚y cud.


DokÄ…d dalej?
============

PrzeszliÅ›my przez podstawowe zasady aplikacji w Nette. Na razie bardzo powierzchownie, ale wkrÃ³tce zagÅ‚Ä™bisz siÄ™ w temat i z czasem stworzysz wspaniaÅ‚e aplikacje internetowe. DokÄ…d kontynuowaÄ‡ dalej? Czy wyprÃ³bowaÅ‚eÅ› juÅ¼ tutorial [Pisanie pierwszej aplikacji|quickstart:]?

OprÃ³cz wyÅ¼ej opisanego, Nette dysponuje caÅ‚ym arsenaÅ‚em [przydatnych klas|utils:], [warstwÄ… bazy danych|database:], itd. SprÃ³buj sobie po prostu przeklikaÄ‡ dokumentacjÄ™. Lub [blog|https://blog.nette.org]. Odkryjesz mnÃ³stwo ciekawych rzeczy.

Niech framework przynosi Ci mnÃ³stwo radoÅ›ci ğŸ’™
