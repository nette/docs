Kako delujejo aplikacije?
*************************

<div class=perex>

Trenutno berete osnovni dokument dokumentacije Nette. Spoznali boste vsa naÄela delovanja spletnih aplikacij. Lepo od A do Å½, od trenutka rojstva do zadnjega diha skripte PHP. Po branju boste vedeli:

- kako vse to deluje
- kaj so Bootstrap, Presenter in DI kontejner
- kako je videti struktura imenikov

</div>


Struktura imenika .[#toc-directory-structure]
=============================================

Odprite skeletni primer spletne aplikacije z imenom [WebProject |https://github.com/nette/web-project] in si oglejte datoteke, o katerih se piÅ¡e.

Struktura imenikov je videti nekako takole:

/--pre
<b>web-project/</b>
â”œâ”€â”€ <b>app/</b>                      â† directory with application
â”‚   â”œâ”€â”€ <b>Presenters/</b>           â† presenter classes
â”‚   â”‚   â”œâ”€â”€ <b>HomePresenter.php</b> â† Home presenter class
â”‚   â”‚   â””â”€â”€ <b>templates/</b>        â† templates directory
â”‚   â”‚       â”œâ”€â”€ <b>@layout.latte</b> â† template of shared layout
â”‚   â”‚       â””â”€â”€ <b>Home/</b>         â† templates for Home presenter
â”‚   â”‚           â””â”€â”€ <b>default.latte</b>  â† template for action `default`
â”‚   â”œâ”€â”€ <b>Router/</b>               â† configuration of URL addresses
â”‚   â””â”€â”€ <b>Bootstrap.php</b>         â† booting class Bootstrap
â”œâ”€â”€ <b>bin/</b>                      â† scripts for the command line
â”œâ”€â”€ <b>config/</b>                   â† configuration files
â”‚   â”œâ”€â”€ <b>common.neon</b>
â”‚   â””â”€â”€ <b>local.neon</b>
â”œâ”€â”€ <b>log/</b>                      â† error logs
â”œâ”€â”€ <b>temp/</b>                     â† temporary files, cache, â€¦
â”œâ”€â”€ <b>vendor/</b>                   â† libraries installed by Composer
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ <b>autoload.php</b>          â† autoloading of libs installed by Composer
â”œâ”€â”€ <b>www/</b>                      â† public directory, document root of project
â”‚   â”œâ”€â”€ <b>.htaccess</b>             â† mod_rewrite rules etc
â”‚   â””â”€â”€ <b>index.php</b>             â† initial file that launches the application
â””â”€â”€ <b>.htaccess</b>                 â† prohibits access to all directories except www
\--

Lahko kakor koli spremenite imeniÅ¡ko strukturo, preimenujete ali premaknete mape, nato pa samo uredite poti do `log/` in `temp/` v datoteki `Bootstrap.php` ter pot do te datoteke v `composer.json` v razdelku `autoload`. NiÄ veÄ, nobene zapletene ponovne konfiguracije, nobenih stalnih sprememb. Nette ima [pametno samodejno zaznavanje |bootstrap#development-vs-production-mode].

Za nekoliko veÄje aplikacije lahko mape s predvajalniki in predlogami razdelimo v podimenike (na disku) in v imenske prostore (v kodi), ki jih imenujemo [moduli |modules].

Imenik `www/` je javni imenik ali dokumentni koren projekta. Lahko ga preimenujete, ne da bi vam bilo treba na strani aplikacije nastaviti kar koli drugega. [Gostovanje |nette:troubleshooting#How to change or remove www directory from URL] morate le [konfigurirati |nette:troubleshooting#How to change or remove www directory from URL] tako, da bo korenina dokumentov preÅ¡la v ta imenik.

WebProject lahko prenesete tudi neposredno, vkljuÄno z Nette, z uporabo [Composerja |best-practices:composer]:

```shell
composer create-project nette/web-project
```

V operacijskem sistemu Linux ali macOS nastavite [dovoljenja za pisanje za |nette:troubleshooting#Setting directory permissions] imenike `log/` in `temp/`.

Aplikacija WebProject je pripravljena za zagon, niÄesar veÄ ni treba nastavljati, ogledate pa si jo lahko neposredno v brskalniku z dostopom do mape `www/`.


Zahteva HTTP .[#toc-http-request]
=================================

Vse se zaÄne, ko uporabnik odpre stran v brskalniku in brskalnik z zahtevo HTTP zaklepa streÅ¾nik. Zahteva gre v datoteko PHP, ki se nahaja v javnem imeniku `www/`, ki je `index.php`. Predpostavimo, da je to zahteva na naslov `https://example.com/product/123` in se bo izvrÅ¡il.

Njegova naloga je:

1) inicializacija okolja
2) pridobiti tovarno
3) zagnati aplikacijo Nette, ki obravnava zahtevo

Katere vrste je tovarna? Ne proizvajamo traktorjev, temveÄ spletne strani! PoÄakajte, takoj vam bo razloÅ¾eno.

Z "inicializacijo okolja" mislimo na primer na to, da se aktivira [Tracy, |tracy:] ki je izjemno orodje za beleÅ¾enje ali vizualizacijo napak. BeleÅ¾i napake v produkcijskem streÅ¾niku in jih prikazuje neposredno v razvojnem streÅ¾niku. Zato je treba pri inicializaciji odloÄiti tudi, ali spletno mesto deluje v produkcijskem ali razvojnem naÄinu. Za to Nette uporablja samodejno zaznavanje: Äe zaÅ¾enete spletno mesto na lokalnem gostitelju, se zaÅ¾ene v razvijalskem naÄinu. NiÄesar vam ni treba konfigurirati in aplikacija je pripravljena tako za razvojno kot produkcijsko namestitev. Ti koraki so izvedeni in podrobno opisani v poglavju o [razredu Bootstrap |bootstrap].

Tretja toÄka (da, drugo smo preskoÄili, vendar se bomo k njej vrnili) je zagon aplikacije. Obravnavo zahtevkov HTTP v Nette izvaja razred `Nette\Application\Application` (v nadaljevanju `Application`), zato ko reÄemo "zagnati aplikacijo", imamo v mislih klic metode z imenom `run()` na objektu tega razreda.

Nette je mentor, ki vas vodi pri pisanju Äistih aplikacij po preverjenih metodologijah. Najbolj preizkuÅ¡ena se imenuje **vbrizgavanje odvisnosti**, skrajÅ¡ano DI. Trenutno vas ne Å¾elimo obremenjevati z razlago DI, saj je za to namenjeno [posebno poglavje |dependency-injection:introduction], pomembno pa je, da bodo kljuÄni objekti obiÄajno ustvarjeni s tovarno za objekte, imenovano **kontejner DI** (skrajÅ¡ano DIC). Da, to je tista tovarna, ki smo jo omenili pred kratkim. Ta nam ustvari tudi objekt `Application`, zato najprej potrebujemo vsebnik. Dobimo ga z uporabo razreda `Configurator` in mu pustimo, da izdela objekt `Application`, pokliÄemo metodo `run()` in s tem zaÅ¾enemo aplikacijo Nette. Natanko to se zgodi v datoteki [index.php |bootstrap#index.php].


Aplikacija Nette .[#toc-nette-application]
==========================================

Razred Application ima eno samo nalogo: odgovoriti na zahtevo HTTP.

Aplikacije, napisane v okolju Nette, so razdeljene na Å¡tevilne tako imenovane predstavnike (v drugih ogrodjih lahko naletite na izraz controller, ki je enak), ki so razredi, ki predstavljajo doloÄeno spletno stran: npr. domaÄa stran; izdelek v e-trgovini; prijavni obrazec; vir zemljevida spletnega mesta itd. Aplikacija ima lahko od enega do veÄ tisoÄ predstavnikov.

Aplikacija se zaÄne tako, da zahteva od tako imenovanega usmerjevalnika, da se odloÄi, kateremu od predstavnikov bo posredoval trenutno zahtevo v obdelavo. Usmerjevalnik se odloÄi, Äigava je to odgovornost. Pregleda vhodni naslov URL `https://example.com/product/123`, ki Å¾eli `show` izdelek z `id: 123` kot dejanjem. Dobra navada je, da se pari predstavnik + akcija, loÄeni z dvopiÄjem, zapiÅ¡ejo kot `Product:show`.

Usmerjevalnik je torej pretvoril naslov URL v par `Presenter:action` + parametri, v naÅ¡em primeru `Product:show` + `id: 123`. Kako je videti usmerjevalnik, si lahko ogledate v datoteki `app/Router/RouterFactory.php`, podrobno pa ga bomo opisali v poglavju [Usmerjanje |Routing].

Pojdimo naprej. Aplikacija Å¾e pozna ime predavatelja in lahko nadaljuje. Z ustvarjanjem predmeta `ProductPresenter`, ki je koda predstavnika `Product`. NatanÄneje, za ustvarjanje predstavnika zaprosi vsebnik DI, saj je izdelovanje objektov njegova naloga.

Predstavnik je lahko videti takole:

```php
class ProductPresenter extends Nette\Application\UI\Presenter
{
	public function __construct(
		private ProductRepository $repository,
	) {
	}

	public function renderShow(int $id): void
	{
		// pridobimo podatke iz modela in jih posredujemo predlogi
		$this->template->product = $this->repository->getProduct($id);
	}
}
```

Zahtevo obravnava predstavnik. In naloga je jasna: izvedite dejanje `show` s `id: 123`. Kar v jeziku predstavnikov pomeni, da se pokliÄe metoda `renderShow()` in v parametru `$id` dobi `123`.

Predstavnik lahko obravnava veÄ dejanj, tj. ima veÄ metod `render<Action>()`. Vendar priporoÄamo, da predstavnike oblikujete z eno ali Äim manj akcijami.

Tako je bila klicana metoda `renderShow(123)`, katere koda je izmiÅ¡ljen primer, vendar lahko na njej vidite, kako se podatki posredujejo predlogi, tj. z zapisom v `$this->template`.

Nato predstavnik vrne odgovor. To je lahko stran HTML, slika, dokument XML, poÅ¡iljanje datoteke z diska, JSON ali preusmeritev na drugo stran. Pomembno je, da Äe izrecno ne navedemo, kako odgovoriti (kar je primer `ProductPresenter`), bo odgovor prikaz predloge s stranjo HTML. Zakaj? No, ker v 99 % primerov Å¾elimo izrisati predlogo, zato predstavnik to vedenje sprejme kot privzeto in nam Å¾eli olajÅ¡ati delo. To je Nettejeva poanta.

Ni nam treba niti navesti, katero predlogo Å¾elimo narisati, on pot do nje izpelje po preprosti logiki. V primeru predstavnika `Product` in akcije `show`, poskuÅ¡a preveriti, ali obstaja ena od teh datotek s predlogami glede na imenik, v katerem se nahaja razred `ProductPresenter`:

- `templates/Product/show.latte`
- `templates/Product.show.latte`

Prav tako poskuÅ¡a poiskati postavitev v datoteki `@layout.latte` in nato upodobi predlogo. Zdaj je naloga predstavnika in celotne aplikacije konÄana. ÄŒe predloga ne obstaja, se vrne stran z napako 404. VeÄ o predstavitvah si lahko preberete na strani [Predstavitve |Presenters].

[* request-flow.svg *]

Da bi se prepriÄali, poskusite celoten postopek ponoviti z nekoliko drugaÄnim naslovom URL:

1) naslov URL bo `https://example.com`
2) zaÅ¾enemo aplikacijo, ustvarimo vsebnik in zaÅ¾enemo `Application::run()`
3) usmerjevalnik dekodira naslov URL kot par `Home:default`
4) ustvari se objekt `HomePresenter`
5) kliÄemo metodo `renderDefault()` (Äe obstaja)
6) prikaÅ¾e se predloga `templates/Home/default.latte` z razporeditvijo `templates/@layout.latte`


Morda ste zdaj naleteli na veliko novih konceptov, vendar verjamemo, da so smiselni. Ustvarjanje aplikacij v programu Nette je zelo enostavno.


Predloge .[#toc-templates]
==========================

Pri predlogah Nette uporablja sistem predlog [Latte |latte:]. Zato se datoteke s predlogami konÄajo s `.latte`. Latte se uporablja, ker je najbolj varen sistem predlog za PHP in hkrati najbolj intuitiven sistem. Ni se vam treba nauÄiti veliko novega, poznati morate le PHP in nekaj oznak Latte. Vse boste naÅ¡li v [dokumentaciji |latte:].

V predlogi [ustvarimo povezave do |creating-links] drugih predstavnikov in akcij, kot sledi:

```latte
<a n:href="Product:show $productId">product detail</a>
```

Preprosto zapiÅ¡ite znani par `Presenter:action` namesto pravega URL in vkljuÄite vse parametre. Trik je `n:href`, ki pove, da bo ta atribut obdelal program Nette. In ustvaril bo:

```latte
<a href="/product/456">product detail</a>
```

Za generiranje naslova URL je odgovoren prej omenjeni usmerjevalnik. Pravzaprav so usmerjevalniki v Nette edinstveni, saj lahko izvajajo ne le pretvorbe iz naslova URL v par predstavnik:dejanje, temveÄ tudi obratno, generirajo naslov URL iz imena predstavnika + dejanja + parametrov.
ZahvaljujoÄ temu lahko v Nette v celoti spremenite obliko URL v celotni dokonÄani aplikaciji, ne da bi spremenili en sam znak v predlogi ali predstavniku, samo s spremembo usmerjevalnika.
ZahvaljujoÄ temu pa deluje tudi tako imenovana kanonizacija, ki je Å¡e ena edinstvena lastnost sistema Nette, ki izboljÅ¡a SEO (optimizacijo iskanja v internetu), saj samodejno prepreÄuje obstoj podvojene vsebine na razliÄnih URL-jih.
Å tevilnim programerjem se to zdi neverjetno.


Interaktivne komponente .[#toc-interactive-components]
======================================================

O predstavitvah vam moramo povedati Å¡e nekaj: imajo vgrajen sistem komponent. StarejÅ¡i med vami se morda spomnite neÄesa podobnega iz Delphija ali ASP.NET Web Forms. React ali Vue.js sta zgrajena na neÄem zelo podobnem. V svetu ogrodij PHP je to povsem edinstvena lastnost.

Komponente so loÄene enote za veÄkratno uporabo, ki jih namestimo v strani (tj. predstavnike). To so lahko [obrazci |forms:in-presenter], [podatkovne mreÅ¾e |https://componette.org/contributte/datagrid/], meniji, ankete, pravzaprav vse, kar je smiselno uporabiti veÄkrat. Ustvarimo lahko lastne komponente ali uporabimo katero od [Å¡tevilnih |https://componette.org] odprtokodnih komponent.

Komponente bistveno spremenijo pristop k razvoju aplikacij. Odprle bodo nove moÅ¾nosti za sestavljanje strani iz vnaprej doloÄenih enot. In imajo nekaj skupnega s [Hollywoodom |components#Hollywood style].


Kontejner DI in konfiguracija .[#toc-di-container-and-configuration]
====================================================================

Kontejner DI (tovarna predmetov) je srce celotne aplikacije.

Ne skrbite, to ni magiÄna Ärna Å¡katla, kot se morda zdi iz prejÅ¡njih besed. Pravzaprav gre za en precej dolgoÄasen razred PHP, ki ga ustvari Nette in je shranjen v imeniku predpomnilnika. Ima veliko metod, poimenovanih kot `createServiceAbcd()`, in vsaka od njih ustvari in vrne objekt. Da, obstaja tudi metoda `createServiceApplication()`, ki ustvari `Nette\Application\Application`, ki smo jo potrebovali v datoteki `index.php` za zagon aplikacije. Obstajajo pa tudi metode za izdelavo posameznih predstavnikov. In tako naprej.

Predmeti, ki jih ustvarja vsebnik DI, se iz nekega razloga imenujejo storitve.

Posebnost tega razreda je, da ga ne programirate vi, temveÄ ogrodje. Pravzaprav ustvari kodo PHP in jo shrani na disk. Vi samo podate navodila o tem, katere predmete naj bi vsebnik znal ustvariti in kako natanÄno. Ta navodila so zapisana v [konfiguracijskih datotekah |bootstrap#DI Container Configuration] v [formatu NEON |neon:format] in imajo zato konÄnico `.neon`.

Konfiguracijske datoteke se uporabljajo izkljuÄno za dajanje navodil vsebniku DI. Tako bo na primer, Äe v razdelku [seje |http:configuration#Session] navedem moÅ¾nost `expiration: 14 days`, vsebnik DI pri ustvarjanju objekta `Nette\Http\Session`, ki predstavlja sejo, poklical njegovo metodo `setExpiration('14 days')`, s Äimer bo konfiguracija postala resniÄnost.

Za vas je pripravljeno celotno poglavje, v katerem je opisano, kaj je mogoÄe [konfigurirati |nette:configuring] in kako [opredeliti lastne storitve |dependency-injection:services].

Ko se boste lotili ustvarjanja storitev, boste naleteli na besedo [samodejno povezovanje |dependency-injection:autowiring]. To je pripomoÄek, ki vam bo neverjetno olajÅ¡al Å¾ivljenje. Z njim lahko samodejno posredujete predmete, kjer jih potrebujete (na primer v konstruktorjih vaÅ¡ih razredov), ne da bi vam bilo treba kar koli storiti. Ugotovili boste, da je zabojnik DI v Netteu majhen ÄudeÅ¾.


Kaj naprej? .[#toc-what-next]
=============================

Pregledali smo osnovna naÄela aplikacij v programu Nette. Zaenkrat zelo povrÅ¡no, vendar se boste kmalu poglobili v globino in sÄasoma ustvarili Äudovite spletne aplikacije. Kje nadaljevati? Ste Å¾e poskusili z uÄbenikom [Ustvarite svojo prvo aplikacijo |quickstart:]?

Poleg zgoraj navedenega ima Nette Å¡e cel arzenal [uporabnih razredov |utils:], [sloj podatkovnih zbirk |database:] itd. Poskusite namenoma samo klikniti po dokumentaciji. Ali pa obiÅ¡Äite [blog |https://blog.nette.org]. Odkrili boste veliko zanimivih stvari.

Naj vam ogrodje prinese veliko veselja ğŸ’™
