Comment fonctionnent les applications ?
***************************************

<div class=perex>

Vous lisez actuellement le guide fondamental de la documentation Nette. Vous apprendrez tout le principe de fonctionnement des applications web. De A Ã  Z, du dÃ©but Ã  la fin de l'exÃ©cution du script PHP. AprÃ¨s lecture, vous saurez :

- comment tout cela fonctionne
- ce qu'est Bootstrap, un Presenter et un conteneur DI
- Ã  quoi ressemble la structure des rÃ©pertoires

</div>


Structure des rÃ©pertoires
=========================

Ouvrez l'exemple de squelette d'application web appelÃ© [WebProject|https://github.com/nette/web-project] et pendant la lecture, examinez les fichiers mentionnÃ©s.

La structure des rÃ©pertoires ressemble Ã  quelque chose comme ceci :

/--pre
<b>web-project/</b>
â”œâ”€â”€ <b>app/</b>                      â† rÃ©pertoire de l'application
â”‚   â”œâ”€â”€ <b>Core/</b>                 â† classes de base nÃ©cessaires au fonctionnement
â”‚   â”‚   â””â”€â”€ <b>RouterFactory.php</b> â† configuration des adresses URL
â”‚   â”œâ”€â”€ <b>Presentation/</b>         â† presenters, templates & co.
â”‚   â”‚   â”œâ”€â”€ <b>@layout.latte</b>     â† template de layout
â”‚   â”‚   â””â”€â”€ <b>Home/</b>             â† rÃ©pertoire du presenter Home
â”‚   â”‚       â”œâ”€â”€ <b>HomePresenter.php</b> â† classe du presenter Home
â”‚   â”‚       â””â”€â”€ <b>default.latte</b> â† template de l'action default
â”‚   â””â”€â”€ <b>Bootstrap.php</b>         â† classe de dÃ©marrage Bootstrap
â”œâ”€â”€ <b>assets/</b>                   â† ressources (SCSS, TypeScript, images sources)
â”œâ”€â”€ <b>bin/</b>                      â† scripts exÃ©cutÃ©s depuis la ligne de commande
â”œâ”€â”€ <b>config/</b>                   â† fichiers de configuration
â”‚   â”œâ”€â”€ <b>common.neon</b>
â”‚   â””â”€â”€ <b>services.neon</b>
â”œâ”€â”€ <b>log/</b>                      â† erreurs journalisÃ©es
â”œâ”€â”€ <b>temp/</b>                     â† fichiers temporaires, cache, â€¦
â”œâ”€â”€ <b>vendor/</b>                   â† bibliothÃ¨ques installÃ©es par Composer
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ <b>autoload.php</b>          â† autoloading de tous les paquets installÃ©s
â”œâ”€â”€ <b>www/</b>                      â† rÃ©pertoire public ou document-root du projet
â”‚   â”œâ”€â”€ <b>assets/</b>               â† fichiers statiques compilÃ©s (CSS, JS, images, ...)
â”‚   â”œâ”€â”€ <b>.htaccess</b>             â† rÃ¨gles mod_rewrite
â”‚   â””â”€â”€ <b>index.php</b>             â† fichier initial par lequel l'application est lancÃ©e
â””â”€â”€ <b>.htaccess</b>                 â† interdit l'accÃ¨s Ã  tous les rÃ©pertoires sauf www
\--

Vous pouvez modifier la structure des rÃ©pertoires comme vous le souhaitez, renommer ou dÃ©placer des dossiers, elle est entiÃ¨rement flexible. De plus, Nette dispose d'une autodÃ©tection intelligente et reconnaÃ®t automatiquement l'emplacement de l'application, y compris sa base d'URL.

Pour les applications lÃ©gÃ¨rement plus grandes, nous pouvons [diviser les dossiers avec les presenters et les templates en sous-rÃ©pertoires |directory-structure#Presenters et templates] et les classes en espaces de noms, que nous appelons modules.

Le rÃ©pertoire `www/` reprÃ©sente le rÃ©pertoire public ou document-root du projet. Vous pouvez le renommer sans aucune configuration supplÃ©mentaire cÃ´tÃ© application. Il suffit de [configurer l'hÃ©bergement |nette:troubleshooting#Comment changer ou supprimer le rÃ©pertoire www de l URL] pour que le document-root pointe vers ce rÃ©pertoire.

Vous pouvez Ã©galement tÃ©lÃ©charger directement WebProject incluant Nette en utilisant [Composer |best-practices:composer] :

```shell
composer create-project nette/web-project
```

Sous Linux ou macOS, dÃ©finissez les [permissions d'Ã©criture |nette:troubleshooting#Configuration des permissions de rÃ©pertoire] pour les rÃ©pertoires `log/` et `temp/`.

L'application WebProject est prÃªte Ã  Ãªtre lancÃ©e, il n'y a absolument rien Ã  configurer et vous pouvez l'afficher directement dans le navigateur en accÃ©dant au dossier `www/`.


RequÃªte HTTP
============

Tout commence au moment oÃ¹ l'utilisateur ouvre une page dans le navigateur. C'est-Ã -dire lorsque le navigateur contacte le serveur avec une requÃªte HTTP. La requÃªte pointe vers un seul fichier PHP, qui se trouve dans le rÃ©pertoire public `www/`, et c'est `index.php`. Supposons qu'il s'agisse d'une requÃªte pour l'adresse `https://example.com/product/123`. GrÃ¢ce Ã  une [configuration serveur appropriÃ©e |nette:troubleshooting#Comment configurer le serveur pour les jolies URL], cette URL est Ã©galement associÃ©e au fichier `index.php`, qui est ensuite exÃ©cutÃ©.

Ses tÃ¢ches sont :

1) initialiser l'environnement
2) obtenir la factory
3) lancer l'application Nette, qui traitera la requÃªte

Quelle factory ? Nous ne fabriquons pas de tracteurs, mais des sites web ! Patientez, cela va s'Ã©claircir.

Par "initialisation de l'environnement", nous entendons par exemple l'activation de [Tracy|tracy:], qui est un outil exceptionnel pour la journalisation ou la visualisation des erreurs. Sur un serveur de production, il journalise les erreurs, sur un serveur de dÃ©veloppement, il les affiche directement. L'initialisation comprend donc Ã©galement la dÃ©cision de savoir si le site fonctionne en mode production ou dÃ©veloppement. Pour cela, Nette utilise une [autodÃ©tection intelligente |bootstrapping#Mode DÃ©veloppement vs Production] : si vous lancez le site sur localhost, il fonctionne en mode dÃ©veloppement. Vous n'avez donc rien Ã  configurer et l'application est prÃªte Ã  la fois pour le dÃ©veloppement et le dÃ©ploiement en production. Ces Ã©tapes sont effectuÃ©es et dÃ©crites en dÃ©tail dans le chapitre sur la [classe Bootstrap|bootstrapping].

Le troisiÃ¨me point (oui, nous avons sautÃ© le deuxiÃ¨me, mais nous y reviendrons) est le lancement de l'application. Le traitement des requÃªtes HTTP dans Nette est gÃ©rÃ© par la classe `Nette\Application\Application` (ci-aprÃ¨s `Application`), donc quand nous disons lancer l'application, nous entendons spÃ©cifiquement appeler la mÃ©thode `run()` sur l'objet de cette classe.

Nette est un mentor qui vous guide vers l'Ã©criture d'applications propres selon des mÃ©thodologies Ã©prouvÃ©es. Et l'une de celles qui sont absolument les plus Ã©prouvÃ©es s'appelle **l'injection de dÃ©pendances**, en abrÃ©gÃ© DI. Pour le moment, nous ne voulons pas vous surcharger avec l'explication de la DI, il y a un [chapitre sÃ©parÃ©|dependency-injection:introduction] pour cela, l'important est la consÃ©quence que les objets clÃ©s nous seront gÃ©nÃ©ralement crÃ©Ã©s par une factory d'objets appelÃ©e **conteneur DI** (abrÃ©gÃ© en DIC). Oui, c'est la factory dont il Ã©tait question il y a un instant. Et elle nous crÃ©era aussi l'objet `Application`, c'est pourquoi nous avons d'abord besoin du conteneur. Nous l'obtenons Ã  l'aide de la classe `Configurator` et nous lui demandons de crÃ©er l'objet `Application`, nous appelons sa mÃ©thode `run()` et l'application Nette est ainsi lancÃ©e. C'est exactement ce qui se passe dans le fichier [index.php |bootstrapping#index.php].


Nette Application
=================

La classe `Application` n'a qu'une seule tÃ¢che : rÃ©pondre Ã  la requÃªte HTTP.

Les applications Ã©crites en Nette sont divisÃ©es en de nombreux presenters (dans d'autres frameworks, vous pouvez rencontrer le terme controller, c'est la mÃªme chose), qui sont des classes, dont chacune reprÃ©sente une page web spÃ©cifique : par ex. la page d'accueil ; un produit dans une boutique en ligne ; un formulaire de connexion ; un flux sitemap, etc. Une application peut avoir d'un Ã  des milliers de presenters.

`Application` commence par demander au routeur de dÃ©cider Ã  quel presenter transmettre la requÃªte actuelle pour traitement. Le routeur dÃ©termine qui est responsable. Il regarde l'URL d'entrÃ©e `https://example.com/product/123` et sur la base de sa configuration, dÃ©cide que c'est le travail, par ex., du **presenter** `Product`, auquel il demandera comme **action** l'affichage (`show`) du produit avec `id: 123`. Il est de bonne pratique de noter la paire presenter + action sÃ©parÃ©e par deux-points, comme `Product:show`.

Le routeur a donc transformÃ© l'URL en une paire `Presenter:action` + paramÃ¨tres, dans notre cas `Product:show` + `id: 123`. Ã€ quoi ressemble un tel routeur, vous pouvez le voir dans le fichier `app/Core/RouterFactory.php` et nous le dÃ©crivons en dÃ©tail dans le chapitre [Routage |Routing].

Continuons. `Application` connaÃ®t dÃ©jÃ  le nom du presenter et peut continuer. En crÃ©ant l'objet de la classe `ProductPresenter`, qui est le code du presenter `Product`. Plus prÃ©cisÃ©ment, il demande au conteneur DI de crÃ©er le presenter, car c'est son rÃ´le.

Le presenter peut ressembler Ã  ceci :

```php
class ProductPresenter extends Nette\Application\UI\Presenter
{
	public function __construct(
		private ProductRepository $repository,
	) {
	}

	public function renderShow(int $id): void
	{
		// nous obtenons les donnÃ©es du modÃ¨le et les passons au template
		$this->template->product = $this->repository->getProduct($id);
	}
}
```

Le presenter prend en charge le traitement de la requÃªte. Et la tÃ¢che est claire : effectuer l'action `show` avec `id: 123`. Ce qui, dans le langage des presenters, signifie que la mÃ©thode `renderShow()` est appelÃ©e et reÃ§oit `123` dans le paramÃ¨tre `$id`.

Un presenter peut gÃ©rer plusieurs actions, c'est-Ã -dire avoir plusieurs mÃ©thodes `render<Action>()`. Mais nous recommandons de concevoir des presenters avec une seule ou le moins d'actions possible.

Donc, la mÃ©thode `renderShow(123)` a Ã©tÃ© appelÃ©e, dont le code est un exemple fictif, mais vous pouvez y voir comment les donnÃ©es sont passÃ©es au template, c'est-Ã -dire en Ã©crivant dans `$this->template`.

Ensuite, le presenter retourne une rÃ©ponse. Cela peut Ãªtre une page HTML, une image, un document XML, l'envoi d'un fichier depuis le disque, du JSON ou mÃªme une redirection vers une autre page. Il est important que si nous ne disons pas explicitement comment rÃ©pondre (ce qui est le cas de `ProductPresenter`), la rÃ©ponse sera le rendu d'un template avec une page HTML. Pourquoi ? Parce que dans 99% des cas, nous voulons rendre un template, donc le presenter considÃ¨re ce comportement comme celui par dÃ©faut et veut nous faciliter le travail. C'est le but de Nette.

Nous n'avons mÃªme pas besoin de spÃ©cifier quel template rendre, il dÃ©duit le chemin lui-mÃªme. Dans le cas de l'action `show`, il essaie simplement de charger le template `show.latte` dans le rÃ©pertoire de la classe `ProductPresenter`. Il essaie Ã©galement de trouver le layout dans le fichier `@layout.latte` (plus de dÃ©tails sur la [recherche de templates |templates#Recherche de templates]).

Et ensuite, il rend les templates. La tÃ¢che du presenter et de toute l'application est ainsi terminÃ©e. Si le template n'existait pas, une page d'erreur 404 serait retournÃ©e. Vous en apprendrez plus sur les presenters sur la page [Presenters |Presenters].

[* request-flow.svg *]

Pour Ãªtre sÃ»r, essayons de rÃ©capituler tout le processus avec une URL lÃ©gÃ¨rement diffÃ©rente :

1) L'URL sera `https://example.com`
2) nous dÃ©marrons l'application, le conteneur est crÃ©Ã© et `Application::run()` est lancÃ©
3) le routeur dÃ©code l'URL comme la paire `Home:default`
4) l'objet de la classe `HomePresenter` est crÃ©Ã©
5) la mÃ©thode `renderDefault()` est appelÃ©e (si elle existe)
6) le template (par ex. `default.latte`) avec le layout (par ex. `@layout.latte`) est rendu


Vous avez peut-Ãªtre rencontrÃ© de nombreux nouveaux termes maintenant, mais nous espÃ©rons qu'ils ont du sens. CrÃ©er des applications avec Nette est incroyablement simple et agrÃ©able.


Templates
=========

Puisque nous avons parlÃ© des templates, Nette utilise le systÃ¨me de templates [Latte |latte:]. D'une part parce que c'est le systÃ¨me de templates le plus sÃ©curisÃ© pour PHP, et d'autre part parce que c'est aussi le systÃ¨me le plus intuitif. Vous n'avez pas besoin d'apprendre beaucoup de nouveautÃ©s, la connaissance de PHP et de quelques balises suffit. Vous apprendrez tout dans [la documentation |templates].

Dans le template, des [liens |creating-links] sont crÃ©Ã©s vers d'autres presenters & actions comme ceci :

```latte
<a n:href="Product:show $productId">dÃ©tail du produit</a>
```

Au lieu d'une URL rÃ©elle, Ã©crivez simplement la paire connue `Presenter:action` et spÃ©cifiez d'Ã©ventuels paramÃ¨tres. L'astuce rÃ©side dans `n:href`, qui indique que cet attribut sera traitÃ© par Nette. Et il gÃ©nÃ©rera :

```latte
<a href="/product/456">dÃ©tail du produit</a>
```

La gÃ©nÃ©ration d'URL est gÃ©rÃ©e par le routeur mentionnÃ© prÃ©cÃ©demment. En effet, les routeurs dans Nette sont exceptionnels car ils peuvent effectuer non seulement des transformations d'URL en paire presenter:action, mais aussi l'inverse, c'est-Ã -dire gÃ©nÃ©rer une URL Ã  partir du nom du presenter + action + paramÃ¨tres. GrÃ¢ce Ã  cela, dans Nette, vous pouvez complÃ¨tement changer les formes d'URL dans toute une application terminÃ©e, sans changer un seul caractÃ¨re dans le template ou le presenter. Juste en modifiant le routeur. GrÃ¢ce Ã  cela fonctionne Ã©galement la canonisation, qui est une autre caractÃ©ristique unique de Nette, contribuant Ã  un meilleur SEO (optimisation pour les moteurs de recherche) en empÃªchant automatiquement l'existence de contenu dupliquÃ© sur diffÃ©rentes URL. De nombreux programmeurs trouvent cela impressionnant.


Composants interactifs
======================

Nous devons vous dire encore une chose sur les presenters : ils ont un systÃ¨me de composants intÃ©grÃ©. Les vÃ©tÃ©rans peuvent se souvenir de quelque chose de similaire dans Delphi ou ASP.NET Web Forms ; React ou Vue.js sont basÃ©s sur quelque chose de vaguement similaire. Dans le monde des frameworks PHP, c'est une caractÃ©ristique absolument unique.

Les composants sont des unitÃ©s autonomes et rÃ©utilisables que nous insÃ©rons dans les pages (c'est-Ã -dire les presenters). Il peut s'agir de [formulaires |forms:in-presenter], de [datagrids |https://componette.org/contributte/datagrid/], de menus, de sondages, en fait de tout ce qu'il est judicieux d'utiliser de maniÃ¨re rÃ©pÃ©tÃ©e. Nous pouvons crÃ©er nos propres composants ou utiliser certains de la [vaste offre |https://componette.org] de composants open source.

Les composants influencent fondamentalement l'approche de la crÃ©ation d'applications. Ils vous ouvrent de nouvelles possibilitÃ©s de composition de pages Ã  partir d'unitÃ©s prÃ©fabriquÃ©es. Et en plus, ils ont quelque chose en commun avec [Hollywood |components#Style Hollywood].


Conteneur DI et configuration
=============================

Le conteneur DI ou factory d'objets est le cÅ“ur de toute l'application.

Ne vous inquiÃ©tez pas, ce n'est pas une boÃ®te noire magique, comme on pourrait le penser d'aprÃ¨s les lignes prÃ©cÃ©dentes. En fait, c'est une classe PHP plutÃ´t simple, gÃ©nÃ©rÃ©e par Nette et stockÃ©e dans le rÃ©pertoire cache. Elle a beaucoup de mÃ©thodes nommÃ©es comme `createServiceAbcd()` et chacune d'elles sait comment crÃ©er et retourner un objet. Oui, il y a aussi une mÃ©thode `createServiceApplication()`, qui crÃ©e `Nette\Application\Application`, dont nous avions besoin dans le fichier `index.php` pour lancer l'application. Et il y a des mÃ©thodes crÃ©ant les presenters individuels. Et ainsi de suite.

Les objets que le conteneur DI crÃ©e sont, pour une raison quelconque, appelÃ©s services.

Ce qui est vraiment spÃ©cial Ã  propos de cette classe, c'est que ce n'est pas vous qui la programmez, mais le framework. Il gÃ©nÃ¨re rÃ©ellement le code PHP et le sauvegarde sur le disque. Vous donnez simplement des instructions sur les objets que le conteneur doit savoir crÃ©er et comment prÃ©cisÃ©ment. Et ces instructions sont Ã©crites dans des [fichiers de configuration |bootstrapping#Configuration du Conteneur DI], pour lesquels le format [NEON|neon:format] est utilisÃ© et qui ont donc aussi l'extension `.neon`.

Les fichiers de configuration servent uniquement Ã  instruire le conteneur DI. Ainsi, par exemple, si j'indique dans la section [session |http:configuration#Session] l'option `expiration: 14 days`, alors le conteneur DI, lors de la crÃ©ation de l'objet `Nette\Http\Session` reprÃ©sentant la session, appellera sa mÃ©thode `setExpiration('14 days')` et la configuration deviendra ainsi rÃ©alitÃ©.

Il y a tout un chapitre prÃ©parÃ© pour vous dÃ©crivant tout ce qui peut Ãªtre [configurÃ© |nette:configuring] et comment [dÃ©finir vos propres services |dependency-injection:services].

DÃ¨s que vous vous familiariserez un peu avec la crÃ©ation de services, vous rencontrerez le mot [autowiring |dependency-injection:autowiring]. C'est une astuce qui vous simplifiera incroyablement la vie. Elle sait comment passer automatiquement des objets lÃ  oÃ¹ vous en avez besoin (par exemple dans les constructeurs de vos classes), sans que vous ayez Ã  faire quoi que ce soit. Vous dÃ©couvrirez que le conteneur DI de Nette est un petit miracle.


OÃ¹ aller ensuite ?
==================

Nous avons parcouru les principes de base des applications en Nette. Pour l'instant trÃ¨s superficiellement, mais vous approfondirez bientÃ´t et crÃ©erez avec le temps de merveilleuses applications web. OÃ¹ continuer ? Avez-vous dÃ©jÃ  essayÃ© le tutoriel [Ã‰crivons notre premiÃ¨re application|quickstart:] ?

En plus de ce qui a Ã©tÃ© dÃ©crit ci-dessus, Nette dispose de tout un arsenal de [classes utiles|utils:], d'une [couche de base de donnÃ©es|database:], etc. Essayez juste de parcourir la documentation. Ou le [blog|https://blog.nette.org]. Vous dÃ©couvrirez beaucoup de choses intÃ©ressantes.

Que le framework vous apporte beaucoup de joie ğŸ’™
