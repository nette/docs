Bootstrap
*********

<div class=perex>

Bootstrap je zavÃ¡dÄ›cÃ­ kÃ³d, kterÃ½ inicializuje prostÅ™edÃ­, vytvoÅ™Ã­ dependency injection (DI) kontejner a spustÃ­ aplikaci. Å˜ekneme si:

- jak se konfiguruje pomocÃ­ NEON souborÅ¯
- jak rozliÅ¡it produkÄnÃ­ a vÃ½vojÃ¡Å™skÃ½ reÅ¾im
- jak vytvoÅ™it DI kontejner

</div>


Aplikace, aÅ¥ uÅ¾ jde o ty webovÃ© nebo skripty spouÅ¡tÄ›nÃ© z pÅ™Ã­kazovÃ© Å™Ã¡dky, zaÄÃ­najÃ­ svÅ¯j bÄ›h nÄ›jakou formou inicializace prostÅ™edÃ­. V dÃ¡vnÃ½ch dobÃ¡ch to mÃ­val na starosti soubor s nÃ¡zvem tÅ™eba `include.inc.php`, kterÃ½ prvotnÃ­ soubor inkludoval.
V modernÃ­ch Nette aplikacÃ­ch jej nahradila tÅ™Ã­da `Bootstrap`, kterou jakoÅ¾to souÄÃ¡st aplikace najdete v souboru `app/Bootstrap.php`. MÅ¯Å¾e vypadat kupÅ™Ã­kladu takto:

```php
use Nette\Bootstrap\Configurator;

class Bootstrap
{
	private Configurator $configurator;
	private string $rootDir;

	public function __construct()
	{
		$this->rootDir = dirname(__DIR__);
		// KonfigurÃ¡tor je zodpovÄ›dnÃ½ za nastavenÃ­ prostÅ™edÃ­ aplikace a sluÅ¾eb.
		$this->configurator = new Configurator;
		// NastavÃ­ adresÃ¡Å™ pro doÄasnÃ© soubory generovanÃ© Nette (napÅ™. zkompilovanÃ© Å¡ablony)
		$this->configurator->setTempDirectory($this->rootDir . '/temp');
	}

	public function bootWebApplication(): Nette\DI\Container
	{
		$this->initializeEnvironment();
		$this->setupContainer();
		return $this->configurator->createContainer();
	}

	private function initializeEnvironment(): void
	{
		// Nette je chytrÃ© a vÃ½vojovÃ½ reÅ¾im se zapÃ­nÃ¡ automaticky,
		// nebo jej mÅ¯Å¾ete povolit pro konkrÃ©tnÃ­ IP adresu odkomentovÃ¡nÃ­m nÃ¡sledujÃ­cÃ­ho Å™Ã¡dku:
		// $this->configurator->setDebugMode('secret@23.75.345.200');

		// Aktivuje Tracy: ultimÃ¡tnÃ­ "Å¡vÃ½carskÃ½ nÅ¯Å¾" pro ladÄ›nÃ­.
		$this->configurator->enableTracy($this->rootDir . '/log');

		// RobotLoader: automaticky naÄÃ­tÃ¡ vÅ¡echny tÅ™Ã­dy ve zvolenÃ©m adresÃ¡Å™i
		$this->configurator->createRobotLoader()
			->addDirectory(__DIR__)
			->register();
	}

	private function setupContainer(): void
	{
		// NaÄte konfiguraÄnÃ­ soubory
		$this->configurator->addConfig($this->rootDir . '/config/common.neon');
	}
}
```


index.php
=========

PrvotnÃ­ soubor je v pÅ™Ã­padÄ› webovÃ½ch aplikacÃ­ `index.php`, kterÃ½ se nachÃ¡zÃ­ ve veÅ™ejnÃ©m adresÃ¡Å™i `www/`. Ten si nechÃ¡ od tÅ™Ã­dy Bootstrap inicializovat prostÅ™edÃ­ a vyrobit DI kontejner. PotÃ© z nÄ›j zÃ­skÃ¡ sluÅ¾bu `Application`, kterÃ¡ spustÃ­ webovou aplikaci:

```php
$bootstrap = new App\Bootstrap;
// Inicializace prostÅ™edÃ­ + vytvoÅ™enÃ­ DI kontejneru
$container = $bootstrap->bootWebApplication();
// DI kontejner vytvoÅ™Ã­ objekt Nette\Application\Application
$application = $container->getByType(Nette\Application\Application::class);
// SpuÅ¡tÄ›nÃ­ aplikace Nette a zpracovÃ¡nÃ­ pÅ™Ã­chozÃ­ho poÅ¾adavku
$application->run();
```

Jak vidno, s nastavenÃ­m prostÅ™edÃ­ a vytvoÅ™enÃ­m dependency injection (DI) kontejneru pomÃ¡hÃ¡ tÅ™Ã­da [api:Nette\Bootstrap\Configurator], kterou si nynÃ­ blÃ­Å¾e pÅ™edstavÃ­me.


VÃ½vojÃ¡Å™skÃ½ vs produkÄnÃ­ reÅ¾im
=============================

Nette se chovÃ¡ rÅ¯znÄ› podle toho, zda bÄ›Å¾Ã­ na vÃ½vojÃ¡Å™skÃ©m nebo produkÄnÃ­m serveru:

ğŸ› ï¸  VÃ½vojÃ¡Å™skÃ½ reÅ¾im (Development):
	- Zobrazuje Tracy debugbar s uÅ¾iteÄnÃ½mi informacemi (SQL dotazy, Äas vykonÃ¡nÃ­, pouÅ¾itÃ¡ pamÄ›Å¥)
	- PÅ™i chybÄ› zobrazÃ­ detailnÃ­ chybovou strÃ¡nku s volÃ¡nÃ­m funkcÃ­ a obsahem promÄ›nnÃ½ch
	- Automaticky obnovuje cache pÅ™i zmÄ›nÄ› Latte Å¡ablon, ÃºpravÄ› konfiguraÄnÃ­ch souborÅ¯ atd.


ğŸš€  ProdukÄnÃ­ reÅ¾im (Production):
	- Nezobrazuje Å¾Ã¡dnÃ© ladÃ­cÃ­ informace, vÅ¡echny chyby zapisuje do logu
	- PÅ™i chybÄ› zobrazÃ­ ErrorPresenter nebo obecnou strÃ¡nku "Server Error"
	- Cache se nikdy automaticky neobnovuje!
	- OptimalizovanÃ½ pro rychlost a bezpeÄnost


Volba reÅ¾imu se provÃ¡dÃ­ autodetekcÃ­, takÅ¾e obvykle nenÃ­ potÅ™eba nic konfigurovat nebo ruÄnÄ› pÅ™epÃ­nat:

- vÃ½vojÃ¡Å™skÃ½ reÅ¾im: na localhostu (IP adresa `127.0.0.1` nebo `::1`) pokud nenÃ­ pÅ™Ã­tomnÃ¡ proxy (tj. jejÃ­ HTTP hlaviÄka)
- produkÄnÃ­ reÅ¾im: vÅ¡ude jinde

Pokud chceme vÃ½vojÃ¡Å™skÃ½ reÅ¾im povolit i v dalÅ¡Ã­ch pÅ™Ã­padech, napÅ™Ã­klad programÃ¡torÅ¯m pÅ™istupujÃ­cÃ­m z konkrÃ©tnÃ­ IP adresy, pouÅ¾ijeme `setDebugMode()`:

```php
$this->configurator->setDebugMode('23.75.345.200'); // lze uvÃ©st i pole IP adres
```

RozhodnÄ› doporuÄujeme kombinovat IP adresu s cookie. Do cookie `nette-debug` uloÅ¾Ã­me tajnÃ½ token, napÅ™. `secret1234`, a tÃ­mto zpÅ¯sobem aktivujeme vÃ½vojÃ¡Å™skÃ½ reÅ¾im pro programÃ¡tory pÅ™istupujÃ­cÃ­ z konkrÃ©tnÃ­ IP adresy a zÃ¡roveÅˆ majÃ­cÃ­ v cookie zmÃ­nÄ›nÃ½ token:

```php
$this->configurator->setDebugMode('secret1234@23.75.345.200');
```

VÃ½vojÃ¡Å™skÃ½ reÅ¾im mÅ¯Å¾eme takÃ© vypnout ÃºplnÄ›, i pro localhost:

```php
$this->configurator->setDebugMode(false);
```

Pozor, hodnota `true` zapne vÃ½vojÃ¡Å™skÃ½ reÅ¾im natvrdo, coÅ¾ se nikdy nesmÃ­ stÃ¡t na produkÄnÃ­m serveru.


DebugovacÃ­ nÃ¡stroj Tracy
========================

Pro snadnÃ© debugovÃ¡nÃ­ jeÅ¡tÄ› zapneme skvÄ›lÃ½ nÃ¡stroj [Tracy |tracy:]. Ve vÃ½vojÃ¡Å™skÃ©m reÅ¾imu chyby vizualizuje a v produkÄnÃ­m reÅ¾imu chyby loguje do uvedenÃ©ho adresÃ¡Å™e:

```php
$this->configurator->enableTracy($this->rootDir . '/log');
```


DoÄasnÃ© soubory
===============

Nette vyuÅ¾Ã­vÃ¡ cache pro DI kontejner, RobotLoader, Å¡ablony atd. Proto je nutnÃ© nastavit cestu k adresÃ¡Å™i, kam se bude cache uklÃ¡dat:

```php
$this->configurator->setTempDirectory($this->rootDir . '/temp');
```

Na Linuxu nebo macOS nastavte adresÃ¡Å™Å¯m `log/` a `temp/` [prÃ¡va pro zÃ¡pis |nette:troubleshooting#NastavenÃ­ prÃ¡v adresÃ¡Å™Å¯].


RobotLoader
===========

Zpravidla budeme chtÃ­t automaticky naÄÃ­tat tÅ™Ã­dy pomocÃ­ [RobotLoaderu |robot-loader:], musÃ­me ho tedy nastartovat a nechÃ¡me jej naÄÃ­tat tÅ™Ã­dy z adresÃ¡Å™e, kde je umÃ­stÄ›nÃ½ `Bootstrap.php` (tj. `__DIR__`), a vÅ¡ech podadresÃ¡Å™Å¯:

```php
$this->configurator->createRobotLoader()
	->addDirectory(__DIR__)
	->register();
```

AlternativnÃ­ pÅ™Ã­stup je nechat tÅ™Ã­dy naÄÃ­tat pouze pÅ™es [Composer |best-practices:composer] pÅ™i dodrÅ¾enÃ­ PSR-4.


Timezone
========

PÅ™es konfigurÃ¡tor mÅ¯Å¾ete nastavit vÃ½chozÃ­ Äasovou zÃ³nu.

```php
$this->configurator->setTimeZone('Europe/Prague');
```


Konfigurace DI kontejneru
=========================

SouÄÃ¡stÃ­ bootovacÃ­ho procesu je vytvoÅ™enÃ­ DI kontejneru neboli tovÃ¡rny na objekty, coÅ¾ je srdce celÃ© aplikace. Jde vlastnÄ› o PHP tÅ™Ã­du, kterou vygeneruje Nette a uloÅ¾Ã­ do adresÃ¡Å™e s cache. TovÃ¡rna vyrÃ¡bÃ­ klÃ­ÄovÃ© objekty aplikace a pomocÃ­ konfiguraÄnÃ­ch souborÅ¯ jÃ­ instruujeme, jak je mÃ¡ vytvÃ¡Å™et a nastavovat, ÄÃ­mÅ¾ ovlivÅˆujeme chovÃ¡nÃ­ celÃ© aplikace.

KonfiguraÄnÃ­ soubory se obvykle zapisujÃ­ ve formÃ¡tu [NEON |neon:format]. V samostatnÃ© kapitole se doÄtete, [co vÅ¡e lze konfigurovat |nette:configuring].

.[tip]
Ve vÃ½vojÃ¡Å™skÃ©m reÅ¾imu se kontejner automaticky aktualizuje pÅ™i kaÅ¾dÃ© zmÄ›nÄ› kÃ³du nebo konfiguraÄnÃ­ch souborÅ¯. V produkÄnÃ­m reÅ¾imu se vygeneruje jen jednou a zmÄ›ny se kvÅ¯li maximalizaci vÃ½konu nekontrolujÃ­.

KonfiguraÄnÃ­ soubory naÄteme pomocÃ­ `addConfig()`:

```php
$this->configurator->addConfig($this->rootDir . '/config/common.neon');
```

Pokud chceme pÅ™idat vÃ­ce konfiguraÄnÃ­ch souborÅ¯, mÅ¯Å¾eme funkci `addConfig()` zavolat vÃ­cekrÃ¡t.

```php
$configDir = $this->rootDir . '/config';
$this->configurator->addConfig($configDir . '/common.neon');
$this->configurator->addConfig($configDir . '/services.neon');
if (PHP_SAPI === 'cli') {
	$this->configurator->addConfig($configDir . '/cli.php');
}
```

NÃ¡zev `cli.php` nenÃ­ pÅ™eklep, konfigurace mÅ¯Å¾e bÃ½t zapsanÃ¡ takÃ© v PHP souboru, kterÃ½ ji vrÃ¡tÃ­ jako pole.

TakÃ© mÅ¯Å¾eme pÅ™idat dalÅ¡Ã­ konfiguraÄnÃ­ soubory v [sekci `includes` |dependency-injection:configuration#VklÃ¡dÃ¡nÃ­ souborÅ¯].

Pokud se v konfiguraÄnÃ­ch souborech objevÃ­ prvky se stejnÃ½mi klÃ­Äi, budou pÅ™epsÃ¡ny, nebo v pÅ™Ã­padÄ› [polÃ­ slouÄeny |dependency-injection:configuration#SluÄovÃ¡nÃ­]. PozdÄ›ji vklÃ¡danÃ½ soubor mÃ¡ vyÅ¡Å¡Ã­ prioritu neÅ¾ pÅ™edchozÃ­. Soubor, ve kterÃ©m je sekce `includes` uvedena, mÃ¡ vyÅ¡Å¡Ã­ prioritu neÅ¾ v nÄ›m inkludovanÃ© soubory.


StatickÃ© parametry
------------------

Parametry pouÅ¾Ã­vanÃ© v konfiguraÄnÃ­ch souborech mÅ¯Å¾eme definovat [v sekci `parameters`|dependency-injection:configuration#parametry] a takÃ© je pÅ™edÃ¡vat (Äi pÅ™episovat) metodou `addStaticParameters()` (mÃ¡ alias `addParameters()`). DÅ¯leÅ¾itÃ© je, Å¾e rÅ¯znÃ© hodnoty parametrÅ¯ zpÅ¯sobÃ­ vygenerovÃ¡nÃ­ dalÅ¡Ã­ch DI kontejnerÅ¯, tedy dalÅ¡Ã­ch tÅ™Ã­d.

```php
$this->configurator->addStaticParameters([
	'projectId' => 23,
]);
```

Na parametr `projectId` se lze v konfiguraci odkÃ¡zat obvyklÃ½m zÃ¡pisem `%projectId%`.


DynamickÃ© parametry
-------------------

Do kontejneru mÅ¯Å¾eme pÅ™idat i dynamickÃ© parametry, jejichÅ¾ rÅ¯znÃ© hodnoty na rozdÃ­l od statickÃ½ch parameterÅ¯ nezpÅ¯sobÃ­ generovÃ¡nÃ­ novÃ½ch DI kontejnerÅ¯.

```php
$this->configurator->addDynamicParameters([
	'remoteIp' => $_SERVER['REMOTE_ADDR'],
]);
```

JednoduÅ¡e tak mÅ¯Å¾eme pÅ™idat napÅ™. environmentÃ¡lnÃ­ promÄ›nnÃ©, na kterÃ© se pak lze v konfiguraci odkÃ¡zat zÃ¡pisem `%env.variable%`.

```php
$this->configurator->addDynamicParameters([
	'env' => getenv(),
]);
```


VÃ½chozÃ­ parametry
-----------------

V konfiguraÄnÃ­ch souborech mÅ¯Å¾ete vyuÅ¾Ã­t tyto statickÃ© parametry:

- `%appDir%` je absolutnÃ­ cesta k adresÃ¡Å™i se souborem `Bootstrap.php`
- `%wwwDir%` je absolutnÃ­ cesta k adresÃ¡Å™i se vstupnÃ­m souborem `index.php`
- `%tempDir%` je absolutnÃ­ cesta k adresÃ¡Å™i pro doÄasnÃ© soubory
- `%vendorDir%` je absolutnÃ­ cesta k adresÃ¡Å™i, kam Composer instaluje knihovny
- `%rootDir%` je absolutnÃ­ cesta ke koÅ™enovÃ©mu adresÃ¡Å™i projektu
- `%debugMode%` udÃ¡vÃ¡, zda je aplikace v debugovacÃ­m reÅ¾imu
- `%consoleMode%` udÃ¡vÃ¡, zda request pÅ™iÅ¡el pÅ™es pÅ™Ã­kazovou Å™Ã¡dku


ImportovanÃ© sluÅ¾by
------------------

NynÃ­ uÅ¾ jdeme hloubÄ›ji. AÄkoliv je smyslem DI kontejneru objekty vyrÃ¡bet, vÃ½jimeÄnÄ› mÅ¯Å¾e vzniknout potÅ™eba do kontejneru existujÃ­cÃ­ objekt vloÅ¾it. UdÄ›lÃ¡me to tak, Å¾e sluÅ¾bu definujeme s pÅ™Ã­znakem `imported: true`.

```neon
services:
	myservice:
		type: App\Model\MyCustomService
		imported: true
```

A v bootstrapu do kontejneru vloÅ¾Ã­me objekt:

```php
$this->configurator->addServices([
	'myservice' => new App\Model\MyCustomService('foobar'),
]);
```


OdliÅ¡nÃ© prostÅ™edÃ­
=================

Nebojte se upravit tÅ™Ã­du Bootstrap podle svÃ½ch potÅ™eb. MetodÄ› `bootWebApplication()` mÅ¯Å¾ete pÅ™idat parametry pro rozliÅ¡enÃ­ webovÃ½ch projektÅ¯. Nebo mÅ¯Å¾eme doplnit dalÅ¡Ã­ metody, napÅ™Ã­klad `bootTestEnvironment()`, kterÃ¡ inicializuje prostÅ™edÃ­ pro jednotkovÃ© testy, `bootConsoleApplication()` pro skripty volanÃ© z pÅ™Ã­kazovÃ© Å™Ã¡dky atd.

```php
public function bootTestEnvironment(): Nette\DI\Container
{
	Tester\Environment::setup(); // inicializace Nette Testeru
	$this->setupContainer();
	return $this->configurator->createContainer();
}

public function bootConsoleApplication(): Nette\DI\Container
{
	$this->configurator->setDebugMode(false);
	$this->initializeEnvironment();
	$this->setupContainer();
	return $this->configurator->createContainer();
}
```
