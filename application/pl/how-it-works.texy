Jak dziaÅ‚ajÄ… aplikacje?
***********************

<div class=perex>

Czytasz wÅ‚aÅ›nie dokumentacjÄ™ rdzenia Nette. Poznasz caÅ‚Ä… zasadÄ™ dziaÅ‚ania aplikacji internetowych. Od A do Z, od momentu narodzin do ostatniego tchnienia skryptu PHP. Po przeczytaniu tego, bÄ™dziesz wiedziaÅ‚:

- jak to wszystko dziaÅ‚a
- czym jest Bootstrap, Presenter i kontener DI
- jak wyglÄ…da struktura katalogÃ³w

</div>


Struktura katalogu .[#toc-directory-structure]
==============================================

OtwÃ³rz szkieletowy przykÅ‚ad aplikacji internetowej o nazwie [WebProject |https://github.com/nette/web-project] i w trakcie czytania moÅ¼esz przyjrzeÄ‡ siÄ™ omawianym plikom.

Struktura katalogÃ³w wyglÄ…da mniej wiÄ™cej tak:

/--pre
<b>web-project/</b>
â”œâ”€â”€ <b>app/</b>                      â† adresÃ¡Å™ s aplikacÃ­
â”‚   â”œâ”€â”€ <b>Presenters/</b>           â† presentery a Å¡ablony
â”‚   â”‚   â”œâ”€â”€ <b>HomepagePresenter.php</b>  â† tÅ™Ã­da presenteru Homepage
â”‚   â”‚   â””â”€â”€ <b>templates/</b>        â† adresÃ¡Å™ se Å¡ablonami
â”‚   â”‚       â”œâ”€â”€ <b>@layout.latte</b> â† Å¡ablona layoutu
â”‚   â”‚       â””â”€â”€ <b>Homepage/</b>     â† Å¡ablony presenteru Homepage
â”‚   â”‚           â””â”€â”€ <b>default.latte</b>  â† Å¡ablona akce 'default'
â”‚   â”œâ”€â”€ <b>Router/</b>               â† konfigurace URL adres
â”‚   â””â”€â”€ <b>Bootstrap.php</b>         â† zavÃ¡dÄ›cÃ­ tÅ™Ã­da Bootstrap
â”œâ”€â”€ <b>bin/</b>                      â† skripty spouÅ¡tÄ›nÃ© z pÅ™Ã­kazovÃ© Å™Ã¡dky
â”œâ”€â”€ <b>config/</b>                   â† konfiguraÄnÃ­ soubory
â”‚   â”œâ”€â”€ <b>common.neon</b>
â”‚   â””â”€â”€ <b>local.neon</b>
â”œâ”€â”€ <b>log/</b>                      â† logovanÃ© chyby
â”œâ”€â”€ <b>temp/</b>                     â† doÄasnÃ© soubory, cache, â€¦
â”œâ”€â”€ <b>vendor/</b>                   â† knihovny instalovanÃ© Composerem
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ <b>autoload.php</b>          â† autoloading vÅ¡ech nainstalovanÃ½ch balÃ­ÄkÅ¯
â”œâ”€â”€ <b>www/</b>                      â† veÅ™ejnÃ½ adresÃ¡Å™ neboli document-root projektu
â”‚   â”œâ”€â”€ <b>.htaccess</b>             â† pravidla mod_rewrite
â”‚   â””â”€â”€ <b>index.php</b>             â† prvotnÃ­ soubor, kterÃ½m se aplikace spouÅ¡tÃ­
â””â”€â”€ <b>.htaccess</b>                 â† zakazuje pÅ™Ã­stup do vÅ¡ech adresÃ¡Å™Å¯ krom www
\--

MoÅ¼esz zmieniÄ‡ strukturÄ™ katalogÃ³w w dowolny sposÃ³b, zmieniÄ‡ nazwÄ™ lub przenieÅ›Ä‡ foldery, a nastÄ™pnie po prostu edytowaÄ‡ Å›cieÅ¼ki do `log/` i `temp/` w pliku `Bootstrap.php`, a nastÄ™pnie Å›cieÅ¼kÄ™ do tego pliku w `composer.json` w sekcji `autoload`. Nic wiÄ™cej, Å¼adnych skomplikowanych rekonfiguracji, Å¼adnych zmian w staÅ‚ych. Nette posiada [sprytnÄ… |bootstrap#Development-vs-Production-Mode] funkcjÄ™ [autodetekcji |bootstrap#Development-vs-Production-Mode].

W przypadku nieco wiÄ™kszych aplikacji moÅ¼emy podzieliÄ‡ foldery prezentera i szablonu na dysku na podkatalogi, a klasy na przestrzenie nazw, ktÃ³re nazywamy [moduÅ‚ami |modules].

Katalog `www/` jest tzw. katalogiem publicznym lub document-root projektu. MoÅ¼esz zmieniÄ‡ jego nazwÄ™ bez koniecznoÅ›ci ustawiania czegokolwiek innego po stronie aplikacji. Wystarczy [skonfigurowaÄ‡ hosting |nette:troubleshooting#How-to-change-or-remove-www-directory-from-URL] tak, aby document-root trafiÅ‚ do tego katalogu.

MoÅ¼esz rÃ³wnieÅ¼ pobraÄ‡ WebProject bezpoÅ›rednio, w tym Nette, uÅ¼ywajÄ…c [Composera |best-practices:composer]:

```shell
composer create-project nette/web-project
```

W systemach Linux lub macOS ustaw katalogi `log/` i `temp/` na uprawnienia do [zapisu |nette:troubleshooting#Setting-Directory-Permissions].

Aplikacja WebProject jest gotowa do uruchomienia, nie jest wymagana Å¼adna konfiguracja i moÅ¼na jÄ… obejrzeÄ‡ bezpoÅ›rednio w przeglÄ…darce, wchodzÄ…c do folderu `www/`.


Å»Ä…danie HTTP .[#toc-http-request]
=================================

Wszystko zaczyna siÄ™ w momencie, gdy uÅ¼ytkownik otwiera stronÄ™ w przeglÄ…darce. Czyli wtedy, gdy przeglÄ…darka kliknie na serwer z Å¼Ä…daniem HTTP. Å»Ä…danie jest kierowane do pojedynczego pliku PHP znajdujÄ…cego siÄ™ w katalogu publicznym `www/`, czyli do `index.php`. ZaÅ‚Ã³Å¼my, Å¼e Å¼Ä…danie dotyczy `https://example.com/product/123` i jest wykonywany.

Jego celem jest:

1) inicjalizacja Å›rodowiska
2) zdobyÄ‡ fabrykÄ™
3) uruchomiÄ‡ aplikacjÄ™ Nette, ktÃ³ra bÄ™dzie obsÅ‚ugiwaÄ‡ Å¼Ä…danie

Jaka fabryka? Nie robimy traktorÃ³w, robimy strony internetowe! Trzymaj siÄ™, za chwilÄ™ siÄ™ to wyjaÅ›ni.

Przez "inicjalizacjÄ™ Å›rodowiska" rozumiemy na przykÅ‚ad, Å¼e wÅ‚Ä…czona jest [Tracy |tracy:], ktÃ³ra jest niesamowitym narzÄ™dziem do logowania lub wizualizacji bÅ‚Ä™dÃ³w. Rejestruje bÅ‚Ä™dy na serwerze produkcyjnym, a wyÅ›wietla je na serwerze deweloperskim. Tak wiÄ™c inicjalizacja obejmuje podjÄ™cie decyzji, czy witryna dziaÅ‚a w trybie produkcyjnym czy rozwojowym. Aby to zrobiÄ‡, Nette uÅ¼ywa autodetekcji: jeÅ›li uruchamiasz stronÄ™ na localhost, dziaÅ‚a ona w trybie deweloperskim. Nie musisz niczego konfigurowaÄ‡, a aplikacja jest gotowa zarÃ³wno do rozwoju, jak i wdroÅ¼enia na Å¼ywo. CzynnoÅ›ci te sÄ… wykonywane i szczegÃ³Å‚owo opisane w rozdziale poÅ›wiÄ™conym [klasie Bootstrap |bootstrap].

Trzeci punkt (tak, pominÄ™liÅ›my drugi, ale do niego wrÃ³cimy) to uruchomienie aplikacji. ObsÅ‚ugÄ… Å¼Ä…daÅ„ HTTP zajmuje siÄ™ w Nette klasa `Nette\Application\Application` (dalej `Application`), wiÄ™c mÃ³wiÄ…c o uruchomieniu aplikacji, mamy na myÅ›li w szczegÃ³lnoÅ›ci wywoÅ‚anie metody o odpowiedniej nazwie `run()` na obiekcie tej klasy.

Nette jest mentorem, ktÃ³ry prowadzi CiÄ™ do pisania czystych aplikacji wedÅ‚ug sprawdzonych metodologii. A jeden z absolutnie najbardziej sprawdzonych nazywa siÄ™ **dependency injection**, w skrÃ³cie DI. W tym momencie nie chcemy obarczaÄ‡ CiÄ™ wyjaÅ›nianiem DI, jest na to [osobny rozdziaÅ‚ |dependency-injection:introduction], sedno sprawy jest takie, Å¼e kluczowe obiekty bÄ™dÄ… zazwyczaj tworzone przez naszÄ… fabrykÄ™ obiektÃ³w, ktÃ³ra nazywa siÄ™ **DI container** (w skrÃ³cie DIC). Tak, to jest ta fabryka, o ktÃ³rej byÅ‚a mowa przed chwilÄ…. A takÅ¼e uczyni nas obiektem `Application`, dlatego najpierw potrzebujemy kontenera. Uzyskamy go za pomocÄ… klasy `Configurator` i kaÅ¼emy mu wytworzyÄ‡ obiekt `Application`, wywoÅ‚aÄ‡ na nim metodÄ™ `run()` i to uruchomi aplikacjÄ™ Nette. DokÅ‚adnie to samo dzieje siÄ™ w pliku [index.php |bootstrap#index-php].


Aplikacja Nette .[#toc-nette-application]
=========================================

Klasa Application ma tylko jedno zadanie: odpowiedzieÄ‡ na Å¼Ä…danie HTTP.

Aplikacje napisane w Nette sÄ… podzielone na wiele prezenterÃ³w (w innych frameworkach moÅ¼esz spotkaÄ‡ siÄ™ z terminem controller, to to samo), czyli klas, z ktÃ³rych kaÅ¼da reprezentuje konkretnÄ… stronÄ™ witryny: np. stronÄ™ gÅ‚Ã³wnÄ…; produkt w sklepie internetowym; formularz logowania; sitemap feed itp. Aplikacja moÅ¼e mieÄ‡ od jednego do tysiÄ™cy prezenterÃ³w.

Aplikacja rozpoczyna siÄ™ od zapytania tzw. routera o decyzjÄ™, do ktÃ³rego prezentera przekazaÄ‡ bieÅ¼Ä…ce Å¼Ä…danie do przetworzenia. Router decyduje o tym, czyja to odpowiedzialnoÅ›Ä‡. Patrzy na wejÅ›ciowy URL `https://example.com/product/123`, ktÃ³rego poprosi o wyÅ›wietlenie (`show`) produktu z `id: 123` jako **akcji** . DobrÄ… praktykÄ… jest zapisanie pary prezenter + akcja oddzielonej dwukropkiem jako `Product:show`.

W ten sposÃ³b router przeksztaÅ‚ca adres URL w parÄ™ `Presenter:action` + parametry, w naszym przypadku `Product:show` + `id: 123`. Jak wyglÄ…da taki router, moÅ¼na zobaczyÄ‡ w pliku `app/Router/RouterFactory.php`, a szczegÃ³Å‚owo opisujemy go w rozdziale [Routing |Routing].

Ruszajmy dalej. Aplikacja zna teraz nazwÄ™ prezentera i moÅ¼e przejÅ›Ä‡ dalej. ProdukujÄ…c obiekt klasy `ProductPresenter`, ktÃ³ry jest kodem prezentera `Product`. DokÅ‚adniej, prosi kontener DI o wyprodukowanie prezentera, poniewaÅ¼ jest tam, aby go wyprodukowaÄ‡.

Prezenter moÅ¼e wyglÄ…daÄ‡ tak:

```php
class ProductPresenter extends Nette\Application\UI\Presenter
{
	public function __construct(
		private ProductRepository $repository,
	) {
	}

	public function renderShow(int $id): void
	{
		// zÃ­skÃ¡me dane z modelu a pÅ™edÃ¡me do Å¡ablony
		$this->template->product = $this->repository->getProduct($id);
	}
}
```

Prezenter przejmuje obsÅ‚ugÄ™ Å¼Ä…dania. A zadanie jest jasne: wykonaÄ‡ akcjÄ™ `show` z `id: 123`. Co w jÄ™zyku prezenterÃ³w oznacza wywoÅ‚anie metody `renderShow()` i uzyskanie `123` w parametrze `$id`.

Prezenter moÅ¼e obsÅ‚ugiwaÄ‡ wiele akcji, czyli mieÄ‡ wiele metod `render<Akce>()`. Zalecamy jednak projektowanie prezenterÃ³w z jednÄ… lub jak najmniejszÄ… iloÅ›ciÄ… akcji.

WywoÅ‚ana jest wiÄ™c metoda `renderShow(123)`, ktÃ³rej kod jest fikcyjnym przykÅ‚adem, ale widaÄ‡, jak przekazaÄ‡ dane do szablonu, czyli piszÄ…c do `$this->template`.

NastÄ™pnie prezenter zwraca odpowiedÅº. MoÅ¼e to byÄ‡ strona HTML, obraz, dokument XML, wysÅ‚anie pliku z dysku, JSON, a nawet przekierowanie na innÄ… stronÄ™. Co waÅ¼ne, o ile nie powiemy wprost prezenterowi, jak ma odpowiedzieÄ‡ (co ma miejsce w przypadku `ProductPresenter`), odpowiedziÄ… bÄ™dzie renderowanie szablonu ze stronÄ… HTML. Dlaczego? PoniewaÅ¼ w 99% przypadkÃ³w chcemy renderowaÄ‡ szablon, wiÄ™c prezenter przyjmuje to zachowanie jako domyÅ›lne i chce uÅ‚atwiÄ‡ nam pracÄ™. O to wÅ‚aÅ›nie chodzi w Nette.

Nie musimy nawet okreÅ›laÄ‡, jaki szablon ma byÄ‡ renderowany, sam wywnioskuje Å›cieÅ¼kÄ™ do niego za pomocÄ… prostej logiki. W przypadku prezentera `Product` i akcji `show`, sprÃ³buje sprawdziÄ‡, czy istnieje jeden z tych plikÃ³w szablonÃ³w przechowywanych wzglÄ™dnie z katalogu klasy `ProductPresenter`:

- `templates/Product/show.latte`
- `templates/Product.show.latte`

SprÃ³buje rÃ³wnieÅ¼ przeÅ›ledziÄ‡ ukÅ‚ad w pliku `@layout.latte`, a nastÄ™pnie wyrenderowaÄ‡ szablon. W ten sposÃ³b koÅ„czy siÄ™ zadanie prezentera i aplikacji, a praca zostaje zakoÅ„czona. JeÅ›li szablon nie istnieje, zwrÃ³cona zostanie strona bÅ‚Ä™du 404. WiÄ™cej o prezenterach moÅ¼na przeczytaÄ‡ na stronie [Prezenterzy |presenters].

[* request-flow.svg *]

Aby byÄ‡ bezpiecznym, sprÃ³bujmy podsumowaÄ‡ caÅ‚y proces z nieco innym adresem URL:

1) Adres URL bÄ™dzie nastÄ™pujÄ…cy `https://example.com`
2) uruchamiamy aplikacjÄ™, tworzymy kontener i uruchamiamy `Application::run()`
3) router dekoduje adres URL jako parÄ™ `Homepage:default`
4) tworzony jest obiekt klasy `HomepagePresenter`
5) wywoÅ‚ywana jest metoda `renderDefault()` (jeÅ›li istnieje)
6) wyrenderowaÄ‡ szablon np. `templates/Homepage/default.latte` z ukÅ‚adem np. `templates/@layout.latte`


Teraz byÄ‡ moÅ¼e spotkaÅ‚eÅ› siÄ™ z wieloma nowymi pojÄ™ciami, ale wierzymy, Å¼e majÄ… one sens. Tworzenie aplikacji w Nette to ogromna buÅ‚ka z masÅ‚em.


Szablony .[#toc-templates]
==========================

MÃ³wiÄ…c o szablonach, Nette uÅ¼ywa systemu szablonÃ³w [Latte |latte:]. StÄ…d `.latte` zakoÅ„czenie dla szablonÃ³w. Latte jest uÅ¼ywany czÄ™Å›ciowo dlatego, Å¼e jest to najbezpieczniejszy system szablonowania dla PHP, a takÅ¼e najbardziej intuicyjny. Nie musisz uczyÄ‡ siÄ™ wielu nowych rzeczy, moÅ¼esz sobie poradziÄ‡ z PHP i kilkoma tagami. Wszystkiego moÅ¼na siÄ™ dowiedzieÄ‡ [w dokumentacji |latte:].

Szablon Å‚Ä…czy siÄ™ [z |creating-links] innymi prezenterami i wydarzeniami w nastÄ™pujÄ…cy sposÃ³b:

```latte
<a n:href="Product:show $productId">detail produktu</a>
```

Wystarczy wpisaÄ‡ znanÄ… parÄ™ `Presenter:action` zamiast prawdziwego adresu URL i podaÄ‡ dowolne parametry. Sztuczka to `n:href`, ktÃ³ra mÃ³wi, Å¼e ten atrybut jest obsÅ‚ugiwany przez Nette. I wygenerowaÄ‡ jÄ…:

```latte
<a href="/product/456">detail produktu</a>
```

Za generowanie adresu URL odpowiada wspomniany wczeÅ›niej router. Routery w Nette sÄ… wyjÄ…tkowe, poniewaÅ¼ mogÄ… nie tylko wykonywaÄ‡ transformacje z URL do pary prezenter:akcja, ale takÅ¼e w drugÄ… stronÄ™, czyli z nazwy prezentera + akcji + parametrÃ³w do wygenerowania URL.
DziÄ™ki temu Nette moÅ¼e caÅ‚kowicie zmieniÄ‡ ksztaÅ‚ty adresÃ³w URL w caÅ‚ej gotowej aplikacji, nie zmieniajÄ…c ani jednego znaku w szablonie lub prezenterze. Wystarczy zmodyfikowaÄ‡ router.
Sprawia rÃ³wnieÅ¼, Å¼e dziaÅ‚a tak zwana kanonizacja, kolejna unikalna funkcja Nette, ktÃ³ra przyczynia siÄ™ do lepszego SEO (optymalizacji pod kÄ…tem wyszukiwarek) poprzez automatyczne zapobieganie istnieniu zduplikowanych treÅ›ci na rÃ³Å¼nych adresach URL.
Wielu programistÃ³w uwaÅ¼a to za przytÅ‚aczajÄ…ce.


Elementy interaktywne .[#toc-interactive-components]
====================================================

O prezenterach moÅ¼na powiedzieÄ‡ jeszcze jedno: majÄ… wbudowany system komponentÃ³w. MoÅ¼esz pamiÄ™taÄ‡ coÅ› podobnego z Delphi lub ASP.NET Web Forms, a React lub Vue.js opiera siÄ™ na czymÅ› zdalnie podobnym. W Å›wiecie frameworkÃ³w PHP jest to rzecz zupeÅ‚nie wyjÄ…tkowa.

Komponenty to samodzielne jednostki wielokrotnego uÅ¼ytku, ktÃ³re osadzamy na stronach (czyli prezenterach). MogÄ… to byÄ‡ [formularze |forms:in-presenter], [datagridy |https://componette.org/contributte/datagrid/], menu, ankiety, w rzeczywistoÅ›ci wszystko, co ma sens, aby uÅ¼ywaÄ‡ wielokrotnie. MoÅ¼emy stworzyÄ‡ wÅ‚asne komponenty lub skorzystaÄ‡ z ktÃ³regoÅ› z [ogromnej gamy |https://componette.org] komponentÃ³w open source.

Komponenty w zasadniczy sposÃ³b wpÅ‚ywajÄ… na podejÅ›cie do budowania aplikacji. OtwierajÄ… one nowe moÅ¼liwoÅ›ci komponowania stron z gotowych jednostek. Do tego majÄ… coÅ› wspÃ³lnego z [Hollywood |components#Hollywood-Style].


Kontener DI i konfiguracja .[#toc-di-container-and-configuration]
=================================================================

Kontener DI, czyli fabryka obiektÃ³w, to serce aplikacji.

Nie martw siÄ™, nie jest to magiczna czarna skrzynka, jak mogÅ‚oby siÄ™ wydawaÄ‡ z poprzednich wierszy. Jest to wÅ‚aÅ›ciwie jedna doÅ›Ä‡ nudna klasa PHP, ktÃ³rÄ… Nette generuje i przechowuje w katalogu cache. Ma garÅ›Ä‡ metod nazwanych jak `createServiceAbcd()` i kaÅ¼da z nich moÅ¼e wytworzyÄ‡ i zwrÃ³ciÄ‡ obiekt. Tak, istnieje metoda `createServiceApplication()`, ktÃ³ra wyprodukuje `Nette\Application\Application`, ktÃ³ry byÅ‚ nam potrzebny w pliku `index.php` do uruchomienia aplikacji. A sÄ… metody, ktÃ³re produkujÄ… indywidualnych prezenterÃ³w. I tak dalej.

Obiekty, ktÃ³re tworzy kontener DI, nie bez powodu nazywane sÄ… usÅ‚ugami.

To co jest naprawdÄ™ wyjÄ…tkowe w tej klasie to fakt, Å¼e nie programujesz jej, robi to framework. W rzeczywistoÅ›ci generuje on kod PHP i przechowuje go na dysku. Po prostu instruujesz, jakie obiekty kontener powinien byÄ‡ w stanie wyprodukowaÄ‡ i jak dokÅ‚adnie. A instrukcje te zapisywane sÄ… w [plikach konfiguracyjnych |bootstrap#DI-Container-Configuration], dla ktÃ³rych wykorzystywany jest format [NEON |neon:format], a wiÄ™c majÄ… rozszerzenie `.neon`.

Pliki konfiguracyjne sÅ‚uÅ¼Ä… wyÅ‚Ä…cznie do instruowania kontenera DI. Tak wiÄ™c, na przykÅ‚ad, jeÅ›li okreÅ›lÄ™ opcjÄ™ `expiration: 14 days` w sekcji [sesji |http:configuration#Session], kontener DI wywoÅ‚a swojÄ… metodÄ™ `setExpiration('14 days')`, gdy utworzy obiekt `Nette\Http\Session` reprezentujÄ…cy sesjÄ™, urzeczywistniajÄ…c konfiguracjÄ™.

Jest caÅ‚y rozdziaÅ‚ opisujÄ…cy, co moÅ¼na [skonfigurowaÄ‡ |nette:configuring] i jak [zdefiniowaÄ‡ niestandardowe usÅ‚ugi |dependency-injection:services].

Gdy zagÅ‚Ä™bimy siÄ™ nieco w tworzenie usÅ‚ug, natrafimy na sÅ‚owo [autowiring |dependency-injection:autowiring]. To gadÅ¼et, ktÃ³ry w niesamowity sposÃ³b uproÅ›ci Twoje Å¼ycie. MoÅ¼e automatycznie przekazywaÄ‡ obiekty tam, gdzie ich potrzebujesz (jak w konstruktorach twoich klas) bez koniecznoÅ›ci robienia czegokolwiek. Przekonasz siÄ™, Å¼e kontener DI w Nette to maÅ‚e cudo.


Gdzie dalej? .[#toc-what-next]
==============================

PrzeszliÅ›my przez podstawowe zasady dziaÅ‚ania aplikacji Nette. Jak na razie bardzo powierzchownie, ale wkrÃ³tce dostaniesz siÄ™ do nitty gritty i ostatecznie zbudujesz kilka wspaniaÅ‚ych aplikacji internetowych. Gdzie dalej? Czy prÃ³bowaÅ‚eÅ› tutoriala [Pisanie pierwszej aplikacji |quickstart:]?

OprÃ³cz powyÅ¼szego Nette posiada caÅ‚y arsenaÅ‚ [przydatnych klas |utils:], [warstwÄ™ bazodanowÄ… |database:] itp. SprÃ³buj celowo przeklikaÄ‡ siÄ™ przez dokumentacjÄ™. Albo [blog |https://blog.nette.org]. Odkryjesz wiele ciekawych rzeczy.

Niech ramy przyniosÄ… Wam wiele radoÅ›ci ğŸ’™
