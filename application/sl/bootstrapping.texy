Bootstrapping
*************

<div class=perex>

Bootstrapping je proces inicializacije okolja aplikacije, ustvarjanja vsebnika za vstavljanje odvisnosti (DI) in zagona aplikacije. Razpravljali bomo o:

- kako razred Bootstrap inicializira okolje
- kako so aplikacije konfigurirane z uporabo NEON datotek
- kako razlikovati med produkcijskim in razvojnim naƒçinom
- kako ustvariti in konfigurirati DI vsebnik

</div>


Aplikacije, bodisi spletne ali skripti, zagnani iz ukazne vrstice, zaƒçnejo svoje delovanje z neko obliko inicializacije okolja. V davnih ƒçasih je za to skrbel datoteka z imenom, na primer `include.inc.php`, ki jo je prvotna datoteka vkljuƒçila. V sodobnih Nette aplikacijah jo je nadomestil razred `Bootstrap`, ki ga kot del aplikacije najdete v datoteki `app/Bootstrap.php`. Lahko izgleda na primer takole:

```php
use Nette\Bootstrap\Configurator;

class Bootstrap
{
	private Configurator $configurator;
	private string $rootDir;

	public function __construct()
	{
		$this->rootDir = dirname(__DIR__);
		// Konfigurator je odgovoren za nastavitev okolja aplikacije in storitev.
		$this->configurator = new Configurator;
		// Nastavi mapo za zaƒçasne datoteke, ki jih generira Nette (npr. prevedene predloge)
		$this->configurator->setTempDirectory($this->rootDir . '/temp');
	}

	public function bootWebApplication(): Nette\DI\Container
	{
		$this->initializeEnvironment();
		$this->setupContainer();
		return $this->configurator->createContainer();
	}

	private function initializeEnvironment(): void
	{
		// Nette je pameten in razvojni naƒçin se vklopi samodejno,
		// ali pa ga lahko omogoƒçite za doloƒçen IP naslov z odkomentiranjem naslednje vrstice:
		// $this->configurator->setDebugMode('secret@23.75.345.200');

		// Aktivira Tracy: ultimativni "≈°vicarski no≈æ" za razhro≈°ƒçevanje.
		$this->configurator->enableTracy($this->rootDir . '/log');

		// RobotLoader: samodejno nalo≈æi vse razrede v izbrani mapi
		$this->configurator->createRobotLoader()
			->addDirectory(__DIR__)
			->register();
	}

	private function setupContainer(): void
	{
		// Nalo≈æi konfiguracijske datoteke
		$this->configurator->addConfig($this->rootDir . '/config/common.neon');
	}
}
```


index.php
=========

Prvotna datoteka je v primeru spletnih aplikacij `index.php`, ki se nahaja v [javni mapi |directory-structure#Javna mapa www] `www/`. Ta si pusti od razreda Bootstrap inicializirati okolje in izdelati DI vsebnik. Nato iz njega pridobi storitev `Application`, ki za≈æene spletno aplikacijo:

```php
$bootstrap = new App\Bootstrap;
// Inicializacija okolja + ustvarjanje DI vsebnika
$container = $bootstrap->bootWebApplication();
// DI vsebnik ustvari objekt Nette\Application\Application
$application = $container->getByType(Nette\Application\Application::class);
// Zagon aplikacije Nette in obdelava dohodnega zahtevka
$application->run();
```

Kot je vidno, pri nastavitvi okolja in ustvarjanju dependency injection (DI) vsebnika pomaga razred [api:Nette\Bootstrap\Configurator], ki si ga bomo zdaj podrobneje predstavili.


Razvojni vs produkcijski naƒçin
==============================

Nette se obna≈°a razliƒçno glede na to, ali teƒçe na razvojnem ali produkcijskem stre≈æniku:

üõ†Ô∏è  Razvojni naƒçin (Development):
	- Prikazuje Tracy debugbar z uporabnimi informacijami (SQL poizvedbe, ƒças izvajanja, uporabljeni pomnilnik)
	- Ob napaki prika≈æe podrobno stran z napako s klici funkcij in vsebino spremenljivk
	- Samodejno obnavlja predpomnilnik ob spremembi Latte predlog, urejanju konfiguracijskih datotek itd.


üöÄ  Produkcijski naƒçin (Production):
	- Ne prikazuje nobenih informacij za razhro≈°ƒçevanje, vse napake zapisuje v dnevnik
	- Ob napaki prika≈æe ErrorPresenter ali splo≈°no stran "Server Error"
	- Predpomnilnik se nikoli samodejno ne obnavlja!
	- Optimiziran za hitrost in varnost


Izbira naƒçina se izvaja s samodejnim zaznavanjem, zato obiƒçajno ni treba niƒçesar konfigurirati ali roƒçno preklapljati:

- razvojni naƒçin: na localhostu (IP naslov `127.0.0.1` ali `::1`) ƒçe ni prisoten proxy (tj. njegova HTTP glava)
- produkcijski naƒçin: povsod drugje

ƒåe ≈æelimo razvojni naƒçin omogoƒçiti tudi v drugih primerih, na primer programerjem, ki dostopajo z doloƒçenega IP naslova, uporabimo `setDebugMode()`:

```php
$this->configurator->setDebugMode('23.75.345.200'); // lahko navedemo tudi polje IP naslovov
```

Vsekakor priporoƒçamo kombiniranje IP naslova s pi≈°kotkom. V pi≈°kotek `nette-debug` shranimo skrivni ≈æeton, npr. `secret1234`, in na ta naƒçin aktiviramo razvojni naƒçin za programerje, ki dostopajo z doloƒçenega IP naslova in imajo hkrati v pi≈°kotku omenjeni ≈æeton:

```php
$this->configurator->setDebugMode('secret1234@23.75.345.200');
```

Razvojni naƒçin lahko tudi popolnoma izklopimo, tudi za localhost:

```php
$this->configurator->setDebugMode(false);
```

Pozor, vrednost `true` vklopi razvojni naƒçin na trdo, kar se nikoli ne sme zgoditi na produkcijskem stre≈æniku.


Orodje za razhro≈°ƒçevanje Tracy
==============================

Za enostavno razhro≈°ƒçevanje ≈°e vklopimo odliƒçno orodje [Tracy |tracy:]. V razvojnem naƒçinu vizualizira napake in v produkcijskem naƒçinu napake bele≈æi v navedeno mapo:

```php
$this->configurator->enableTracy($this->rootDir . '/log');
```


Zaƒçasne datoteke
================

Nette uporablja predpomnilnik za DI vsebnik, RobotLoader, predloge itd. Zato je treba nastaviti pot do mape, kamor se bo predpomnilnik shranjeval:

```php
$this->configurator->setTempDirectory($this->rootDir . '/temp');
```

Na Linuxu ali macOS nastavite mapama `log/` in `temp/` [pravice za pisanje |nette:troubleshooting#Nastavitev pravic map].


RobotLoader
===========

Praviloma bomo ≈æeleli samodejno nalagati razrede s pomoƒçjo [RobotLoaderja |robot-loader:], zato ga moramo zagnati in mu pustiti, da nalaga razrede iz mape, kjer se nahaja `Bootstrap.php` (tj. `__DIR__`), in vseh podmap:

```php
$this->configurator->createRobotLoader()
	->addDirectory(__DIR__)
	->register();
```

Alternativni pristop je, da pustimo razrede nalagati samo prek [Composerja |best-practices:composer] ob upo≈°tevanju PSR-4.


ƒåasovni pas
===========

Prek konfiguratorja lahko nastavite privzeti ƒçasovni pas.

```php
$this->configurator->setTimeZone('Europe/Prague');
```


Konfiguracija DI vsebnika
=========================

Del zagonskega procesa je ustvarjanje DI vsebnika ali tovarne objektov, kar je srce celotne aplikacije. Gre pravzaprav za PHP razred, ki ga Nette generira in shrani v mapo s predpomnilnikom. Tovarna izdeluje kljuƒçne objekte aplikacije in s pomoƒçjo konfiguracijskih datotek ji naroƒçamo, kako naj jih ustvarja in nastavlja, s ƒçimer vplivamo na obna≈°anje celotne aplikacije.

Konfiguracijske datoteke se obiƒçajno zapisujejo v formatu [NEON |neon:format]. V loƒçenem poglavju boste izvedeli, [kaj vse je mogoƒçe konfigurirati |nette:configuring].

.[tip]
V razvojnem naƒçinu se vsebnik samodejno posodablja ob vsaki spremembi kode ali konfiguracijskih datotek. V produkcijskem naƒçinu se generira samo enkrat in spremembe se zaradi maksimizacije zmogljivosti ne preverjajo.

Konfiguracijske datoteke nalo≈æimo s pomoƒçjo `addConfig()`:

```php
$this->configurator->addConfig($this->rootDir . '/config/common.neon');
```

ƒåe ≈æelimo dodati veƒç konfiguracijskih datotek, lahko funkcijo `addConfig()` pokliƒçemo veƒçkrat.

```php
$configDir = $this->rootDir . '/config';
$this->configurator->addConfig($configDir . '/common.neon');
$this->configurator->addConfig($configDir . '/services.neon');
if (PHP_SAPI === 'cli') {
	$this->configurator->addConfig($configDir . '/cli.php');
}
```

Ime `cli.php` ni napaka, konfiguracija je lahko zapisana tudi v PHP datoteki, ki jo vrne kot polje.

Prav tako lahko dodamo druge konfiguracijske datoteke v [odsek `includes` |dependency-injection:configuration#Vkljuƒçevanje datotek].

ƒåe se v konfiguracijskih datotekah pojavijo elementi z enakimi kljuƒçi, bodo prepisani ali v primeru [polj zdru≈æeni |dependency-injection:configuration#Zdru≈æevanje]. Kasneje vkljuƒçena datoteka ima vi≈°jo prioriteto kot prej≈°nja. Datoteka, v kateri je naveden odsek `includes`, ima vi≈°jo prioriteto kot v njej vkljuƒçene datoteke.


Statiƒçni parametri
------------------

Parametre, uporabljene v konfiguracijskih datotekah, lahko definiramo [v odseku `parameters` |dependency-injection:configuration#Parametri] in jih tudi posredujemo (ali prepi≈°emo) z metodo `addStaticParameters()` (ima alias `addParameters()`). Pomembno je, da razliƒçne vrednosti parametrov povzroƒçijo generiranje dodatnih DI vsebnikov, torej dodatnih razredov.

```php
$this->configurator->addStaticParameters([
	'projectId' => 23,
]);
```

Na parameter `projectId` se lahko v konfiguraciji sklicujemo z obiƒçajnim zapisom `%projectId%`.


Dinamiƒçni parametri
-------------------

V vsebnik lahko dodamo tudi dinamiƒçne parametre, katerih razliƒçne vrednosti za razliko od statiƒçnih parametrov ne povzroƒçijo generiranja novih DI vsebnikov.

```php
$this->configurator->addDynamicParameters([
	'remoteIp' => $_SERVER['REMOTE_ADDR'],
]);
```

Preprosto lahko tako dodamo npr. okoljske spremenljivke, na katere se nato lahko v konfiguraciji sklicujemo z zapisom `%env.variable%`.

```php
$this->configurator->addDynamicParameters([
	'env' => getenv(),
]);
```


Privzeti parametri
------------------

V konfiguracijskih datotekah lahko uporabite te statiƒçne parametre:

- `%appDir%` je absolutna pot do mape z datoteko `Bootstrap.php`
- `%wwwDir%` je absolutna pot do mape z vhodno datoteko `index.php`
- `%tempDir%` je absolutna pot do mape za zaƒçasne datoteke
- `%vendorDir%` je absolutna pot do mape, kamor Composer name≈°ƒça knji≈ænice
- `%rootDir%` je absolutna pot do korenskega direktorija projekta
- `%debugMode%` oznaƒçuje, ali je aplikacija v naƒçinu za razhro≈°ƒçevanje
- `%consoleMode%` oznaƒçuje, ali je zahtevek pri≈°el prek ukazne vrstice


Uvo≈æene storitve
----------------

Zdaj gremo globlje. ƒåeprav je smisel DI vsebnika izdelovati objekte, lahko izjemoma nastane potreba, da v vsebnik vstavimo obstojeƒçi objekt. To storimo tako, da storitev definiramo z zastavico `imported: true`.

```neon
services:
	myservice:
		type: App\Model\MyCustomService
		imported: true
```

In v bootstrapu v vsebnik vstavimo objekt:

```php
$this->configurator->addServices([
	'myservice' => new App\Model\MyCustomService('foobar'),
]);
```


Razliƒçna okolja
===============

Ne bojte se prilagoditi razreda Bootstrap svojim potrebam. Metodi `bootWebApplication()` lahko dodate parametre za razlikovanje spletnih projektov. Ali pa lahko dopolnimo druge metode, na primer `bootTestEnvironment()`, ki inicializira okolje za enotne teste, `bootConsoleApplication()` za skripte, klicane iz ukazne vrstice itd.

```php
public function bootTestEnvironment(): Nette\DI\Container
{
	Tester\Environment::setup(); // inicializacija Nette Testerja
	$this->setupContainer();
	return $this->configurator->createContainer();
}

public function bootConsoleApplication(): Nette\DI\Container
{
	$this->configurator->setDebugMode(false);
	$this->initializeEnvironment();
	$this->setupContainer();
	return $this->configurator->createContainer();
}
```
