Kako delujejo aplikacije?
*************************

<div class=perex>

Pravkar berete osnovno listino dokumentacije Nette. Izvedeli boste celoten princip delovanja spletnih aplikacij. Lepo od A do Å½, od trenutka rojstva do zadnjega izdiha PHP skripta. Po branju boste vedeli:

- kako vse skupaj deluje
- kaj so Bootstrap, Presenter in DI vsebnik
- kako izgleda struktura map

</div>


Struktura map
=============

Odpri si primer ogrodja spletne aplikacije imenovane [WebProject|https://github.com/nette/web-project] in med branjem lahko gledaÅ¡ datoteke, o katerih je govora.

Struktura map izgleda nekako takole:

/--pre
<b>web-project/</b>
â”œâ”€â”€ <b>app/</b>                      â† mapa z aplikacijo
â”‚   â”œâ”€â”€ <b>Core/</b>                 â† osnovni razredi, potrebni za delovanje
â”‚   â”‚   â””â”€â”€ <b>RouterFactory.php</b> â† konfiguracija URL naslovov
â”‚   â”œâ”€â”€ <b>Presentation/</b>         â† presenterji, predloge & co.
â”‚   â”‚   â”œâ”€â”€ <b>@layout.latte</b>     â† predloga postavitve
â”‚   â”‚   â””â”€â”€ <b>Home/</b>             â† mapa presenterja Home
â”‚   â”‚       â”œâ”€â”€ <b>HomePresenter.php</b> â† razred presenterja Home
â”‚   â”‚       â””â”€â”€ <b>default.latte</b> â† predloga akcije default
â”‚   â””â”€â”€ <b>Bootstrap.php</b>         â† zagonski razred Bootstrap
â”œâ”€â”€ <b>bin/</b>                      â† skripti, zagnani iz ukazne vrstice
â”œâ”€â”€ <b>config/</b>                   â† konfiguracijske datoteke
â”‚   â”œâ”€â”€ <b>common.neon</b>
â”‚   â””â”€â”€ <b>services.neon</b>
â”œâ”€â”€ <b>log/</b>                      â† zabeleÅ¾ene napake
â”œâ”€â”€ <b>temp/</b>                     â† zaÄasne datoteke, predpomnilnik, â€¦
â”œâ”€â”€ <b>vendor/</b>                   â† knjiÅ¾nice, nameÅ¡Äene s Composerjem
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ <b>autoload.php</b>          â† samodejno nalaganje vseh nameÅ¡Äenih paketov
â”œâ”€â”€ <b>www/</b>                      â† javna mapa ali document-root projekta
â”‚   â”œâ”€â”€ <b>.htaccess</b>             â† pravila mod_rewrite
â”‚   â””â”€â”€ <b>index.php</b>             â† zaÄetna datoteka, s katero se aplikacija zaÅ¾ene
â””â”€â”€ <b>.htaccess</b>                 â† prepoveduje dostop do vseh map razen www
\--

Strukturo map lahko kakorkoli spreminjate, mape preimenujete ali premaknete, je popolnoma fleksibilna. Nette poleg tega razpolaga s pametnim samodejnim zaznavanjem in samodejno prepozna lokacijo aplikacije, vkljuÄno z njeno osnovno URL.

Pri nekoliko veÄjih aplikacijah lahko mape s presenterji in predlogami [razÄlenimo v podmape |directory-structure#Presentery a Å¡ablony] in razrede v imenske prostore, ki jim reÄemo moduli.

Mapa `www/` predstavlja t.i. javno mapo ali document-root projekta. Lahko jo preimenujete brez potrebe po kakrÅ¡nemkoli dodatnem nastavljanju na strani aplikacije. Le potrebno je [konfigurirati gostovanje |nette:troubleshooting#Jak zmÄ›nit Äi ostranit z URL adresÃ¡Å™ www] tako, da document-root kaÅ¾e v to mapo.

WebProject si lahko tudi takoj prenesete vkljuÄno z Nette in to s pomoÄjo [Composerja |best-practices:composer]:

```shell
composer create-project nette/web-project
```

Na Linuxu ali macOS nastavite mapama `log/` in `temp/` [pravice za pisanje |nette:troubleshooting#NastavenÃ­ prÃ¡v adresÃ¡Å™Å¯].

Aplikacija WebProject je pripravljena za zagon, ni treba niÄesar konfigurirati in jo lahko takoj prikaÅ¾ete v brskalniku z dostopom do mape `www/`.


HTTP zahtevek
=============

Vse se zaÄne v trenutku, ko uporabnik v brskalniku odpre stran. Torej, ko brskalnik potrka na streÅ¾nik s HTTP zahtevkom. Zahtevek cilja na eno samo PHP datoteko, ki se nahaja v javni mapi `www/`, in to je `index.php`. Recimo, da gre za zahtevek na naslov `https://example.com/product/123`. ZahvaljujoÄ primerni [nastavitvi streÅ¾nika|nette:troubleshooting#Jak nastavit server pro hezkÃ¡ URL?] se tudi ta URL preslika na datoteko `index.php` in ta se izvede.

Njegova naloga je:

1) inicializirati okolje
2) pridobiti tovarno
3) zagnati Nette aplikacijo, ki bo obdelala zahtevek

KakÅ¡no tovarno? Saj ne izdelujemo traktorjev, ampak spletne strani! PoÄakajte, takoj se bo pojasnilo.

Z besedami "inicializacija okolja" mislimo na primer to, da se aktivira [Tracy|tracy:], kar je Äudovito orodje za beleÅ¾enje ali vizualizacijo napak. Na produkcijskem streÅ¾niku napake beleÅ¾i, na razvojnem jih takoj prikaÅ¾e. Zato k inicializaciji spada tudi odloÄitev, ali spletno mesto teÄe v produkcijskem ali razvojnem naÄinu. Za to Nette uporablja [pametno samodejno zaznavanje|bootstrap#vyvojarsky-vs-produkcni-rezim]: Äe spletno mesto zaÅ¾enete na localhostu, teÄe v razvojnem naÄinu. Ni vam treba niÄesar konfigurirati in aplikacija je takoj pripravljena tako za razvoj kot za ostro uporabo. Ti koraki se izvajajo in so podrobno opisani v poglavju o [razredu Bootstrap|bootstrap].

Tretja toÄka (da, drugo smo preskoÄili, a se bomo vrnili k njej) je zagon aplikacije. Obdelavo HTTP zahtevkov ima v Nette na skrbi razred `Nette\Application\Application` (v nadaljevanju `Application`), zato ko reÄemo zagnati aplikacijo, mislimo konkretno na klicanje metode s primernim imenom `run()` na objektu tega razreda.

Nette je mentor, ki vas vodi k pisanju Äistih aplikacij po preverjenih metodologijah. In ena od tistih popolnoma najbolj preverjenih se imenuje **dependency injection**, skrajÅ¡ano DI. V tem trenutku vas ne Å¾elimo obremenjevati z razlago DI, za to je tu [loÄeno poglavje|dependency-injection:introduction], bistven je posledica, da nam bo kljuÄne objekte obiÄajno ustvarjala tovarna objektov, ki se ji reÄe **DI vsebnik** (skrajÅ¡ano DIC). Da, to je tista tovarna, o kateri je bila pred kratkim govora. In izdelala nam bo tudi objekt `Application`, zato potrebujemo najprej vsebnik. Pridobimo ga s pomoÄjo razreda `Configurator` in mu pustimo izdelati objekt `Application`, na njem pokliÄemo metodo `run()` in s tem se zaÅ¾ene Nette aplikacija. ToÄno to se dogaja v datoteki [index.php|bootstrap#index.php].


Nette Application
=================

Razred Application ima eno samo nalogo: odgovoriti na HTTP zahtevek.

Aplikacije, napisane v Nette, se Älenijo v veliko t.i. presenterjev (v drugih ogrodjih se lahko sreÄate z izrazom controller, gre za isto stvar), kar so razredi, od katerih vsak predstavlja neko konkretno stran spletnega mesta: npr. domaÄo stran; izdelek v spletni trgovini; prijavni obrazec; sitemap vir itd. Aplikacija lahko ima od enega do tisoÄ presenterjev.

Application zaÄne tako, da prosi t.i. usmerjevalnik (router), naj odloÄi, kateremu od presenterjev predati trenutni zahtevek v obdelavo. Usmerjevalnik odloÄi, Äigava je to odgovornost. Pogleda vhodni URL `https://example.com/product/123` in na podlagi tega, kako je nastavljen, odloÄi, da je to delo npr. za **presenter** `Product`, od katerega bo Å¾elel kot **akcijo** prikaz (`show`) izdelka z `id: 123`. Par presenter + akcija je dobra navada zapisovati loÄeno z dvopiÄjem kot `Product:show`.

Torej je usmerjevalnik transformiral URL v par `Presenter:action` + parametri, v naÅ¡em primeru `Product:show` + `id: 123`. Kako takÅ¡en usmerjevalnik izgleda, si lahko pogledate v datoteki `app/Core/RouterFactory.php` in ga podrobno opisujemo v poglavju [Usmerjanje|routing].

Pojdimo naprej. Application Å¾e pozna ime presenterja in lahko nadaljuje naprej. S tem, da izdela objekt razreda `ProductPresenter`, kar je koda presenterja `Product`. NatanÄneje reÄeno, prosi DI vsebnik, naj presenter izdela, ker je za izdelovanje tu on.

Presenter lahko izgleda na primer takole:

```php
class ProductPresenter extends Nette\Application\UI\Presenter
{
	public function __construct(
		private ProductRepository $repository,
	) {
	}

	public function renderShow(int $id): void
	{
		// pridobimo podatke iz modela in jih posredujemo predlogi
		$this->template->product = $this->repository->getProduct($id);
	}
}
```

Obdelavo zahtevka prevzame presenter. In naloga je jasna: izvedi akcijo `show` z `id: 123`. Kar v jeziku presenterjev pomeni, da se pokliÄe metoda `renderShow()` in v parametru `$id` dobi `123`.

Presenter lahko obravnava veÄ akcij, torej ima veÄ metod `render<Akcija>()`. Vendar priporoÄamo naÄrtovanje presenterjev z eno ali Äim manj akcijami.

Torej, poklicala se je metoda `renderShow(123)`, katere koda je sicer izmiÅ¡ljen primer, vendar lahko na njej vidite, kako se posredujejo podatki v predlogo, torej z zapisom v `$this->template`.

Nato presenter vrne odgovor. Ta je lahko HTML stran, slika, XML dokument, poÅ¡iljanje datoteke z diska, JSON ali pa preusmeritev na drugo stran. Pomembno je, da Äe eksplicitno ne povemo, kako naj odgovori (kar je primer `ProductPresenter`), bo odgovor izris predloge s HTML stranjo. Zakaj? Ker v 99 % primerov Å¾elimo izrisati predlogo, zato presenter to obnaÅ¡anje jemlje kot privzeto in nam Å¾eli olajÅ¡ati delo. To je smisel Nette.

Ni nam treba niti navajati, katero predlogo izrisati, pot do nje si izpelje sam. V primeru akcije `show` preprosto poskusi naloÅ¾iti predlogo `show.latte` v mapi z razredom `ProductPresenter`. Prav tako poskusi poiskati postavitev v datoteki `@layout.latte` (podrobneje o [iskanju predlog|templates#hledani-sablon]).

In nato predloge izriÅ¡e. S tem je naloga presenterja in celotne aplikacije konÄana in delo je zakljuÄeno. ÄŒe predloga ne bi obstajala, se vrne stran z napako 404. VeÄ o presenterjih preberite na strani [Presenterji|presenters].

[* request-flow.svg *]

Za vsak sluÄaj, poskusimo si ponoviti celoten proces z nekoliko drugaÄnim URL-jem:

1) URL bo `https://example.com`
2) zaÅ¾enemo aplikacijo, ustvari se vsebnik in zaÅ¾ene `Application::run()`
3) usmerjevalnik dekodira URL kot par `Home:default`
4) ustvari se objekt razreda `HomePresenter`
5) pokliÄe se metoda `renderDefault()` (Äe obstaja)
6) izriÅ¡e se predloga npr. `default.latte` s postavitvijo npr. `@layout.latte`


Morda ste se zdaj sreÄali z veliko novimi pojmi, vendar verjamemo, da imajo smisel. Ustvarjanje aplikacij v Nette je izjemno prijetno.


Predloge
========

Ko smo Å¾e pri predlogah, v Nette se uporablja sistem predlog [Latte |latte:]. Zato tudi konÄnice `.latte` pri predlogah. Latte se uporablja delsno zato, ker gre za najbolj varen sistem predlog za PHP, in hkrati tudi najbolj intuitiven sistem. Ni se vam treba uÄiti veliko novega, zadostuje znanje PHP in nekaj znaÄk. Vse boste izvedeli [v dokumentaciji |templates].

V predlogi se [ustvarjajo povezave |creating-links] na druge presenterje & akcije takole:

```latte
<a n:href="Product:show $productId">podrobnosti izdelka</a>
```

Preprosto namesto realnega URL-ja napiÅ¡ete znani par `Presenter:action` in navedete morebitne parametre. Trik je v `n:href`, ki pravi, da ta atribut obdela Nette. In generira:

```latte
<a href="/product/456">podrobnosti izdelka</a>
```

Generiranje URL-jev ima na skrbi Å¾e prej omenjeni usmerjevalnik. NamreÄ usmerjevalniki v Nette so izjemni s tem, da znajo izvajati ne samo transformacije iz URL-ja v par presenter:action, ampak tudi obratno, torej iz imena presenterja + akcije + parametrov generirati URL.
ZahvaljujoÄ temu lahko v Nette popolnoma spremenite oblike URL-jev v celotni konÄani aplikaciji, ne da bi spremenili en sam znak v predlogi ali presenterju. Samo s tem, da uredite usmerjevalnik.
Prav tako zahvaljujoÄ temu deluje t.i. kanonizacija, kar je Å¡e ena edinstvena lastnost Nette, ki prispeva k boljÅ¡emu SEO (optimizaciji najdljivosti na internetu) s tem, da samodejno prepreÄuje obstoj podvojene vsebine na razliÄnih URL-jih.
Veliko programerjev to Å¡teje za osupljivo.


Interaktivne komponente
=======================

O presenterjih vam moramo povedati Å¡e eno stvar: imajo vgrajen komponentni sistem. Nekaj podobnega se lahko spomnijo veterani iz Delphi ali ASP.NET Web Forms, na neÄem oddaljeno podobnem temeljita React ali Vue.js. V svetu PHP ogrodij gre za popolnoma edinstveno zadevo.

Komponente so samostojne ponovno uporabne celote, ki jih vstavljamo v strani (torej presenterje). Lahko so [obrazci |forms:in-presenter], [podatkovne mreÅ¾e |https://componette.org/contributte/datagrid/], meniji, glasovalne ankete, pravzaprav karkoli, kar ima smisel uporabljati veÄkrat. Lahko ustvarjamo lastne komponente ali uporabljamo nekatere iz [ogromne ponudbe |https://componette.org] odprtokodnih komponent.

Komponente bistveno vplivajo na pristop k ustvarjanju aplikacij. Odprle vam bodo nove moÅ¾nosti sestavljanja strani iz vnaprej pripravljenih enot. In poleg tega imajo nekaj skupnega s [Hollywoodom|components#Hollywood style].


DI vsebnik in konfiguracija
===========================

DI vsebnik ali tovarna objektov je srce celotne aplikacije.

Ne skrbite, ni to nobena Äarobna Ärna Å¡katla, kot bi se morda lahko zdelo iz prejÅ¡njih vrstic. Pravzaprav je to ena precej dolgoÄasna PHP klasa, ki jo generira Nette in shrani v mapo s predpomnilnikom. Ima veliko metod, poimenovanih kot `createServiceAbcd()`, in vsaka od njih zna izdelati in vrniti nek objekt. Da, tam je tudi metoda `createServiceApplication()`, ki izdela `Nette\Application\Application`, ki smo ga potrebovali v datoteki `index.php` za zagon aplikacije. In tam so metode, ki izdelujejo posamezne presenterje. In tako naprej.

Objektom, ki jih DI vsebnik ustvarja, se iz nekega razloga reÄe storitve.

Kar je pri tej klasi resniÄno posebno, je to, da je ne programirate vi, ampak ogrodje. On dejansko generira PHP kodo in jo shrani na disk. Vi samo dajete navodila, kakÅ¡ne objekte naj zna vsebnik izdelovati in kako natanÄno. In ta navodila so zapisana v [konfiguracijskih datotekah|bootstrap#konfigurace-di-kontejneru], za katere se uporablja format [NEON|neon:format] in zato imajo tudi konÄnico `.neon`.

Konfiguracijske datoteke sluÅ¾ijo izkljuÄno za navodila DI vsebnika. Torej, ko na primer navedem v sekciji [session|http:configuration#Session] moÅ¾nost `expiration: 14 days`, DI vsebnik pri ustvarjanju objekta `Nette\Http\Session`, ki predstavlja sejo, pokliÄe njegovo metodo `setExpiration('14 days')` in s tem konfiguracija postane resniÄnost.

Tu je za vas pripravljeno celo poglavje, ki opisuje, kaj vse je mogoÄe [konfigurirati |nette:configuring] in kako [definirati lastne storitve |dependency-injection:services].

Ko se malo poglobite v ustvarjanje storitev, boste naleteli na besedo [autowiring |dependency-injection:autowiring]. To je iznajdba, ki vam bo na neverjeten naÄin poenostavila Å¾ivljenje. Zna samodejno posredovati objekte tja, kjer jih potrebujete (na primer v konstruktorjih vaÅ¡ih klas), ne da bi morali karkoli narediti. Ugotovili boste, da je DI vsebnik v Nette mali ÄudeÅ¾.


Kam naprej?
===========

PreÅ¡li smo osnovne principe aplikacij v Nette. Zaenkrat zelo povrÅ¡no, vendar boste kmalu prodrli v globino in sÄasoma ustvarili Äudovite spletne aplikacije. Kam nadaljevati? Ste Å¾e preizkusili vadnico [PiÅ¡emo prvo aplikacijo|quickstart:]?

Poleg zgoraj opisanega Nette razpolaga s celim arzenalom [uporabnih klas|utils:], [podatkovno plastjo|database:], itd. Poskusite si samo tako preklikati dokumentacijo. Ali [blog|https://blog.nette.org]. Odkrili boste veliko zanimivega.

Naj vam ogrodje prinese veliko veselja ğŸ’™
