Bootstrap
*********

<div class=perex>

Bootstrap to kod startowy, ktÃ³ry inicjalizuje Å›rodowisko, tworzy kontener wtrysku zaleÅ¼noÅ›ci (DI) i uruchamia aplikacjÄ™. Powiedzmy:

- jak skonfigurowaÄ‡ przy uÅ¼yciu plikÃ³w NEON
- jak odrÃ³Å¼niÄ‡ tryb produkcyjny od deweloperskiego
- jak stworzyÄ‡ kontener DI

</div>


Aplikacje, niezaleÅ¼nie od tego, czy sÄ… to aplikacje internetowe, czy skrypty wiersza poleceÅ„, rozpoczynajÄ… swÃ³j czas dziaÅ‚ania od pewnej formy inicjalizacji Å›rodowiska. W dawnych czasach robiÅ‚ to plik o nazwie na przykÅ‚ad `include.inc.php`, ktÃ³ry inkubowaÅ‚ poczÄ…tkowy plik.
W nowoczesnych aplikacjach Nette zostaÅ‚o to zastÄ…pione klasÄ… `Bootstrap`, ktÃ³ra jako czÄ™Å›Ä‡ aplikacji znajduje siÄ™ w pliku `app/Bootstrap.php` MoÅ¼e to wyglÄ…daÄ‡ tak:

```php
use Nette\Bootstrap\Configurator;

class Bootstrap
{
	private Configurator $configurator;
	private string $rootDir;

	public function __construct()
	{
		$this->rootDir = dirname(__DIR__);
		// Konfigurator jest odpowiedzialny za konfiguracjÄ™ Å›rodowiska aplikacji i usÅ‚ug.
		$this->configurator = new Configurator;
		// Ustawienie katalogu dla plikÃ³w tymczasowych generowanych przez Nette (np. skompilowanych szablonÃ³w).
		$this->configurator->setTempDirectory($this->rootDir . '/temp');
	}

	public function bootWebApplication(): Nette\DI\Container
	{
		$this->initializeEnvironment();
		$this->setupContainer();
		return $this->configurator->createContainer();
	}

	private function initializeEnvironment(): void
	{
		// Nette jest inteligentny i tryb deweloperski wÅ‚Ä…cza siÄ™ automatycznie,
		// lub moÅ¼na go wÅ‚Ä…czyÄ‡ dla okreÅ›lonego adresu IP, odkomentowujÄ…c nastÄ™pujÄ…cÄ… liniÄ™:
		// $this->configurator->setDebugMode('secret@23.75.345.200');

		// WÅ‚Ä…cza Tracy: najlepsze narzÄ™dzie do debugowania.
		$this->configurator->enableTracy($this->rootDir . '/log');

		// RobotLoader: automatycznie Å‚aduje wszystkie klasy w podanym katalogu
		$this->configurator->createRobotLoader()
			->addDirectory(__DIR__)
			->register();
	}

	private function setupContainer(): void
	{
		// Åadowanie plikÃ³w konfiguracyjnych
		$this->configurator->addConfig($this->rootDir . '/config/common.neon');
	}
}
```


index.php .[#toc-index-php]
===========================

PoczÄ…tkowym plikiem dla aplikacji internetowych jest `index.php`, znajdujÄ…cy siÄ™ w publicznym katalogu `www/`. UÅ¼ywa on klasy `Bootstrap` do zainicjowania Å›rodowiska i utworzenia kontenera DI. NastÄ™pnie uzyskuje usÅ‚ugÄ™ `Application` z kontenera, ktÃ³ry uruchamia aplikacjÄ™ internetowÄ…:

```php
$bootstrap = new App\Bootstrap;
// Inicjalizacja Å›rodowiska + utworzenie kontenera DI
$container = $bootstrap->bootWebApplication();
// Kontener DI tworzy obiekt Nette\Application\Application
$application = $container->getByType(Nette\Application\Application::class);
// Uruchom aplikacjÄ™ Nette i obsÅ‚uÅ¼ przychodzÄ…ce Å¼Ä…danie
$application->run();
```

Jak widaÄ‡, klasa [api:Nette\Bootstrap\Configurator] pomaga w konfiguracji Å›rodowiska i tworzeniu kontenera dependency injection (DI), ktÃ³remu teraz przyjrzymy siÄ™ bliÅ¼ej.


Tryb deweloperski a produkcyjny .[#toc-development-vs-production-mode]
======================================================================

Nette zachowuje siÄ™ rÃ³Å¼nie w zaleÅ¼noÅ›ci od tego, czy dziaÅ‚a na serwerze deweloperskim czy produkcyjnym:

ğŸ› ï¸ Tryb deweloperski:
	- WyÅ›wietla pasek debugowania Tracy z przydatnymi informacjami (np. zapytania SQL, czas wykonania, uÅ¼ycie pamiÄ™ci).
	- WyÅ›wietla szczegÃ³Å‚owÄ… stronÄ™ bÅ‚Ä™du ze Å›ladami wywoÅ‚aÅ„ funkcji i zawartoÅ›ciÄ… zmiennych w przypadku wystÄ…pienia bÅ‚Ä™du.
	- Automatycznie odÅ›wieÅ¼a pamiÄ™Ä‡ podrÄ™cznÄ…, gdy modyfikowane sÄ… szablony Latte, pliki konfiguracyjne itp.


Tryb produkcyjny:
	- Nie wyÅ›wietla Å¼adnych informacji debugowania; wszystkie bÅ‚Ä™dy sÄ… rejestrowane.
	- WyÅ›wietla stronÄ™ `ErrorPresenter` lub ogÃ³lnÄ… stronÄ™ "BÅ‚Ä…d serwera", gdy wystÄ…pi bÅ‚Ä…d.
	- PamiÄ™Ä‡ podrÄ™czna nigdy nie jest automatycznie odÅ›wieÅ¼ana!
	- Zoptymalizowany pod kÄ…tem szybkoÅ›ci i bezpieczeÅ„stwa.


Tryb jest okreÅ›lany automatycznie, wiÄ™c w wiÄ™kszoÅ›ci przypadkÃ³w nie ma potrzeby konfigurowania lub przeÅ‚Ä…czania go rÄ™cznie:

- Tryb deweloperski: Aktywny na localhost (adres IP `127.0.0.1` lub `::1`), chyba Å¼e uÅ¼ywany jest serwer proxy (tj. na podstawie jego nagÅ‚Ã³wkÃ³w HTTP).
- Tryb produkcyjny: Aktywny wszÄ™dzie indziej.

JeÅ›li chcemy wÅ‚Ä…czyÄ‡ tryb deweloperski w innych przypadkach, takich jak programiÅ›ci uzyskujÄ…cy dostÄ™p z okreÅ›lonego adresu IP, uÅ¼ywamy `setDebugMode()`:

```php
$this->configurator->setDebugMode('23.75.345.200'); // moÅ¼na rÃ³wnieÅ¼ okreÅ›liÄ‡ pole adresu IP
```

Zdecydowanie zalecamy poÅ‚Ä…czenie adresu IP z plikiem cookie. W pliku cookie `nette-debug` przechowujemy tajny token, np. `secret1234`, i w ten sposÃ³b umoÅ¼liwiamy tryb deweloperski dla programistÃ³w uzyskujÄ…cych dostÄ™p z okreÅ›lonego adresu IP i posiadajÄ…cych token w pliku cookie:

```php
$this->configurator->setDebugMode('secret1234@23.75.345.200');
```

MoÅ¼emy rÃ³wnieÅ¼ caÅ‚kowicie wyÅ‚Ä…czyÄ‡ tryb deweloperski, nawet dla localhost:

```php
$this->configurator->setDebugMode(false);
```

Uwaga, wartoÅ›Ä‡ `true` domyÅ›lnie wÅ‚Ä…cza tryb deweloperski, co nigdy nie moÅ¼e mieÄ‡ miejsca na serwerze produkcyjnym.


NarzÄ™dzie do debugowania Tracy .[#toc-debugging-tool-tracy]
===========================================================

Aby uÅ‚atwiÄ‡ debugowanie, wÅ‚Ä…czmy wspaniaÅ‚e narzÄ™dzie [Tracy |tracy:]. Wizualizuje bÅ‚Ä™dy w trybie deweloperskim i loguje bÅ‚Ä™dy w trybie produkcyjnym do podanego katalogu:

```php
$this->configurator->enableTracy($this->rootDir . '/log');
```


Pliki tymczasowe .[#toc-temporary-files]
========================================

Nette uÅ¼ywa buforowania dla kontenera DI, RobotLoader, szablonÃ³w itp. Dlatego musisz ustawiÄ‡ Å›cieÅ¼kÄ™ do katalogu, w ktÃ³rym bÄ™dzie przechowywany cache:

```php
$this->configurator->setTempDirectory($this->rootDir . '/temp');
```

W systemach Linux lub macOS ustaw katalogi `log/` i `temp/` na uprawnienia do [zapisu |nette:troubleshooting#Setting-Directory-Permissions].


RobotLoader .[#toc-robotloader]
===============================

Zazwyczaj bÄ™dziemy chcieli automatycznie zaÅ‚adowaÄ‡ klasy za pomocÄ… [RobotLoader |robot-loader:], wiÄ™c musimy go uruchomiÄ‡ i kazaÄ‡ mu zaÅ‚adowaÄ‡ klasy z katalogu, w ktÃ³rym znajduje siÄ™ `Bootstrap.php` (czyli `__DIR__`), oraz z wszelkich podkatalogÃ³w:

```php
$this->configurator->createRobotLoader()
	->addDirectory(__DIR__)
	->register();
```

Alternatywnym podejÅ›ciem jest pozwoliÄ‡ mu zaÅ‚adowaÄ‡ klasy tylko poprzez [Composer |best-practices:composer], jednoczeÅ›nie podÄ…Å¼ajÄ…c za PSR-4.


Strefa czasowa .[#toc-timezone]
===============================

DomyÅ›lnÄ… strefÄ™ czasowÄ… moÅ¼na ustawiÄ‡ za poÅ›rednictwem konfiguratora.

```php
$this->configurator->setTimeZone('Europe/Prague');
```


Konfiguracja kontenera DI .[#toc-di-container-configuration]
============================================================

CzÄ™Å›ciÄ… procesu uruchamiania jest stworzenie kontenera DI, czyli fabryki obiektÃ³w, ktÃ³ra jest sercem aplikacji. Jest to wÅ‚aÅ›ciwie klasa PHP, ktÃ³ra jest generowana przez Nette i przechowywana w katalogu cache. Fabryka produkuje kluczowe obiekty aplikacji, a my za pomocÄ… plikÃ³w konfiguracyjnych instruujemy jÄ…, jak ma je tworzyÄ‡ i ustawiaÄ‡, wpÅ‚ywajÄ…c tym samym na zachowanie caÅ‚ej aplikacji.

Pliki konfiguracyjne sÄ… zazwyczaj zapisane w formacie [NEON |neon:format]. Zobacz osobny rozdziaÅ‚, aby dowiedzieÄ‡ siÄ™, co [moÅ¼na skonfigurowaÄ‡ |nette:configuring].

.[tip]
W trybie deweloperskim kontener jest automatycznie aktualizowany przy kaÅ¼dej zmianie kodu lub plikÃ³w konfiguracyjnych. W trybie produkcyjnym jest on generowany tylko raz, a zmiany nie sÄ… sprawdzane w celu uzyskania maksymalnej wydajnoÅ›ci.

Pliki konfiguracyjne sÄ… Å‚adowane za pomocÄ… `addConfig()`:

```php
$this->configurator->addConfig($this->rootDir . '/config/common.neon');
```

JeÅ›li chcemy dodaÄ‡ wiÄ™cej plikÃ³w konfiguracyjnych, moÅ¼emy wywoÅ‚aÄ‡ funkcjÄ™ `addConfig()` wielokrotnie.

```php
$configDir = $this->rootDir . '/config';
$this->configurator->addConfig($configDir . '/common.neon');
$this->configurator->addConfig($configDir . '/services.neon');
if (PHP_SAPI === 'cli') {
	$this->configurator->addConfig($configDir . '/cli.php');
}
```

Nazwa `cli.php` nie jest literÃ³wkÄ…, konfiguracja moÅ¼e byÄ‡ rÃ³wnieÅ¼ zapisana w pliku PHP, ktÃ³ry zwraca jÄ… jako tablicÄ™.

MoÅ¼emy rÃ³wnieÅ¼ dodaÄ‡ inne pliki konfiguracyjne w [sekcji `includes` |dependency-injection:configuration#including-files].

JeÅ›li w plikach konfiguracyjnych pojawiÄ… siÄ™ elementy o takich samych kluczach, zostanÄ… one nadpisane, lub [scalone |dependency-injection:configuration#merging] w przypadku pÃ³l. Plik dodany pÃ³Åºniej ma wyÅ¼szy priorytet niÅ¼ poprzedni. Plik, w ktÃ³rym wymieniona jest sekcja `includes` ma wyÅ¼szy priorytet niÅ¼ pliki w niej zawarte.


Parametry statyczne .[#toc-static-parameters]
---------------------------------------------

Parametry wykorzystywane w plikach konfiguracyjnych moÅ¼na zdefiniowaÄ‡ [w sekcji `parameters` |dependency-injection:configuration#parameters], a takÅ¼e przekazaÄ‡ (lub nadpisaÄ‡) za pomocÄ… metody `addStaticParameters()` (posiada ona alias `addParameters()`). Co waÅ¼ne, rÃ³Å¼ne wartoÅ›ci parametrÃ³w spowodujÄ… wygenerowanie dodatkowych kontenerÃ³w DI, czyli dodatkowych klas.

```php
$this->configurator->addStaticParameters([
	'projectId' => 23,
]);
```

W plikach konfiguracyjnych moÅ¼emy zapisaÄ‡ zwykÅ‚Ä… notacjÄ™ `%projectId%` aby uzyskaÄ‡ dostÄ™p do parametru o nazwie `projectId`.


Parametry dynamiczne .[#toc-dynamic-parameters]
-----------------------------------------------

Do kontenera moÅ¼emy rÃ³wnieÅ¼ dodaÄ‡ parametry dynamiczne, ktÃ³rych rÃ³Å¼ne wartoÅ›ci, w przeciwieÅ„stwie do parametrÃ³w statycznych, nie bÄ™dÄ… powodowaÅ‚y generowania nowych kontenerÃ³w DI.

```php
$this->configurator->addDynamicParameters([
	'remoteIp' => $_SERVER['REMOTE_ADDR'],
]);
```

MoÅ¼emy po prostu dodaÄ‡ np. zmienne Å›rodowiskowe, do ktÃ³rych nastÄ™pnie moÅ¼emy siÄ™ odwoÅ‚aÄ‡ w konfiguracji piszÄ…c `%env.variable%`.

```php
$this->configurator->addDynamicParameters([
	'env' => getenv(),
]);
```


Parametry domyÅ›lne .[#toc-default-parameters]
---------------------------------------------

W plikach konfiguracyjnych moÅ¼na uÅ¼ywaÄ‡ nastÄ™pujÄ…cych parametrÃ³w statycznych:

- `%appDir%` jest bezwzglÄ™dnÄ… Å›cieÅ¼kÄ… do katalogu zawierajÄ…cego plik `Bootstrap.php`
- `%wwwDir%` jest bezwzglÄ™dnÄ… Å›cieÅ¼kÄ… do katalogu zawierajÄ…cego plik wejÅ›ciowy `index.php`
- `%tempDir%` jest bezwzglÄ™dnÄ… Å›cieÅ¼kÄ… do katalogu plikÃ³w tymczasowych
- `%vendorDir%` to bezwzglÄ™dna Å›cieÅ¼ka do katalogu, w ktÃ³rym Composer instaluje biblioteki
- `%rootDir%` to bezwzglÄ™dna Å›cieÅ¼ka do katalogu gÅ‚Ã³wnego projektu
- `%debugMode%` wskazuje, czy aplikacja jest w trybie debugowania
- `%consoleMode%` wskazuje, czy Å¼Ä…danie przyszÅ‚o z linii poleceÅ„


UsÅ‚ugi importowane .[#toc-imported-services]
--------------------------------------------

Teraz wchodzimy gÅ‚Ä™biej. ChociaÅ¼ punktem kontenera DI jest wytwarzanie obiektÃ³w, w rzadkich przypadkach moÅ¼e zaistnieÄ‡ potrzeba wstawienia do kontenera istniejÄ…cego obiektu. Robimy to poprzez zdefiniowanie usÅ‚ugi z flagÄ… `imported: true`.

```neon
services:
	myservice:
		type: App\Model\MyCustomService
		imported: true
```

A w bootstrapie wstawiamy obiekt do kontenera:

```php
$this->configurator->addServices([
	'myservice' => new App\Model\MyCustomService('foobar'),
]);
```


RÃ³Å¼ne Å›rodowiska .[#toc-different-environments]
===============================================

Nie wahaj siÄ™ dostosowaÄ‡ klasy `Bootstrap` do swoich potrzeb. MoÅ¼esz dodaÄ‡ parametry do metody `bootWebApplication()`, aby rozrÃ³Å¼niÄ‡ projekty internetowe. Alternatywnie moÅ¼na dodaÄ‡ inne metody, takie jak `bootTestEnvironment()` do inicjalizacji Å›rodowiska dla testÃ³w jednostkowych, `bootConsoleApplication()` dla skryptÃ³w wywoÅ‚ywanych z wiersza poleceÅ„ itp.

```php
public function bootTestEnvironment(): Nette\DI\Container
{
	Tester\Environment::setup(); // Inicjalizacja testera sieci
	$this->setupContainer();
	return $this->configurator->createContainer();
}

public function bootConsoleApplication(): Nette\DI\Container
{
	$this->configurator->setDebugMode(false);
	$this->initializeEnvironment();
	$this->setupContainer();
	return $this->configurator->createContainer();
}
```
