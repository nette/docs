Richiesta HTTP
**************

.[perex]
Nette incapsula la richiesta HTTP in oggetti con un'API comprensibile e fornisce un filtro di sanificazione.

La richiesta HTTP è rappresentata dall'oggetto [api:Nette\Http\Request]. Se si lavora con Nette, questo oggetto viene creato automaticamente dal framework e può essere passato tramite [dependency injection |dependency-injection:passing-dependencies]. Nei presenter, è sufficiente chiamare il metodo `$this->getHttpRequest()`. Se si lavora al di fuori del framework Nette, è possibile creare l'oggetto utilizzando [RequestFactory |#RequestFactory].

Un grande vantaggio di Nette è che, al momento della creazione dell'oggetto, sanifica automaticamente tutti i parametri di input GET, POST, COOKIE e gli URL dai caratteri di controllo e dalle sequenze UTF-8 non valide. È quindi possibile lavorare in modo sicuro con questi dati. I dati sanificati vengono successivamente utilizzati nei presentatori e nei moduli.

→ [Installazione e requisiti |@home#Installation]


Richiesta Nette Http .[#toc-nette-http-request]
===============================================

Questo oggetto è immutabile. Non ha setter, ha solo un cosiddetto wither `withUrl()`, che non modifica l'oggetto, ma restituisce una nuova istanza con un valore modificato.


withUrl(Nette\Http\UrlScript $url): Nette\Http\Request .[method]
----------------------------------------------------------------
Restituisce un clone con un URL diverso.


getUrl(): Nette\Http\UrlScript .[method]
----------------------------------------
Restituisce l'URL della richiesta come oggetto [UrlScript |urls#UrlScript].

```php
$url = $httpRequest->getUrl();
echo $url; // https://nette.org/en/documentation?action=edit
echo $url->getHost(); // nette.org
```

Attenzione: I browser non inviano un frammento al server, quindi `$url->getFragment()` restituirà una stringa vuota.


getQuery(?string $key=null): string|array|null .[method]
--------------------------------------------------------
Restituisce i parametri della richiesta GET:

```php
$all = $httpRequest->getQuery(); // array di tutti i parametri URL
$id = $httpRequest->getQuery('id'); // restituisce il parametro GET 'id' (o null)
```


getPost(?string $key=null): string|array|null .[method]
-------------------------------------------------------
Restituisce i parametri della richiesta POST:

```php
$all = $httpRequest->getPost(); // array di tutti i parametri POST
$id = $httpRequest->getPost('id'); // restituisce il parametro POST 'id' (o null)
```


getFile(string|string[] $key): Nette\Http\FileUpload|array|null .[method]
-------------------------------------------------------------------------
Restituisce il [caricamento |#Uploaded Files] come oggetto [api:Nette\Http\FileUpload]:

```php
$file = $httpRequest->getFile('avatar');
if ($file?->hasFile()) { // è stato caricato un file?
	$file->getUntrustedName(); // nome del file inviato dall'utente
	$file->getSanitizedName(); // il nome senza caratteri pericolosi
}
```

Specificare un array di chiavi per accedere alla struttura del sottoalbero.

```php
//<input type="file" name="my-form[details][avatar]" multiple>
$file = $request->getFile(['my-form', 'details', 'avatar']);
```

Poiché non ci si può fidare dei dati provenienti dall'esterno e quindi non si fa affidamento sulla forma della struttura, questo metodo è più sicuro rispetto a `$request->getFiles()['my-form']['details']['avatar']`che può fallire.


getFiles(): array .[method]
---------------------------
Restituisce un albero di [file di upload |#Uploaded Files] in una struttura normalizzata, con ogni foglia un'istanza di [api:Nette\Http\FileUpload]:

```php
$files = $httpRequest->getFiles();
```


getCookie(string $key): string|array|null .[method]
---------------------------------------------------
Restituisce un cookie o `null` se non esiste.

```php
$sessId = $httpRequest->getCookie('sess_id');
```


getCookies(): array .[method]
-----------------------------
Restituisce tutti i cookie:

```php
$cookies = $httpRequest->getCookies();
```


getMethod(): string .[method]
-----------------------------
Restituisce il metodo HTTP con cui è stata effettuata la richiesta.

```php
echo $httpRequest->getMethod(); // GET, POST, HEAD, PUT
```


isMethod(string $method): bool .[method]
----------------------------------------
Verifica il metodo HTTP con cui è stata effettuata la richiesta. Il parametro non fa distinzione tra maiuscole e minuscole.

```php
if ($httpRequest->isMethod('GET')) // ...
```


getHeader(string $header): ?string .[method]
--------------------------------------------
Restituisce un'intestazione HTTP o `null` se non esiste. Il parametro non fa distinzione tra maiuscole e minuscole:

```php
$userAgent = $httpRequest->getHeader('User-Agent');
```


getHeaders(): array .[method]
-----------------------------
Restituisce tutte le intestazioni HTTP come array associativo:

```php
$headers = $httpRequest->getHeaders();
echo $headers['Content-Type'];
```


isSecured(): bool .[method]
---------------------------
La connessione è criptata (HTTPS)? Potrebbe essere necessario [impostare un proxy |configuration#HTTP proxy] per una corretta funzionalità.


isSameSite(): bool .[method]
----------------------------
La richiesta proviene dallo stesso (sotto)dominio ed è iniziata facendo clic su un link? Nette utilizza il cookie `_nss` (ex `nette-samesite`) per rilevarlo.


isAjax(): bool .[method]
------------------------
È una richiesta AJAX?


getRemoteAddress(): ?string .[method]
-------------------------------------
Restituisce l'indirizzo IP dell'utente. Potrebbe essere necessario [impostare un proxy |configuration#HTTP proxy] per una corretta funzionalità.


getRemoteHost(): ?string .[method deprecated]
---------------------------------------------
Restituisce la traduzione DNS dell'indirizzo IP dell'utente. Potrebbe essere necessario [impostare un proxy |configuration#HTTP proxy] per una corretta funzionalità.


getBasicCredentials(): ?array .[method]
---------------------------------------
Restituisce le credenziali di [autenticazione HTTP di base |https://developer.mozilla.org/en-US/docs/Web/HTTP/Authentication].

```php
[$user, $password] = $httpRequest->getBasicCredentials();
```


getRawBody(): ?string .[method]
-------------------------------
Restituisce il corpo della richiesta HTTP:

```php
$body = $httpRequest->getRawBody();
```


detectLanguage(array $langs): ?string .[method]
-----------------------------------------------
Rileva la lingua. Come parametro `$lang`, si passa un array di lingue supportate dall'applicazione e viene restituita quella preferita dal browser. Non è una magia, il metodo utilizza semplicemente l'intestazione `Accept-Language`. Se non c'è corrispondenza, restituisce `null`.

```php
// Intestazione inviata dal browser: Accept-Language: cs,en-us;q=0.8,en;q=0.5,sl;q=0.3

$langs = ['hu', 'pl', 'en']; // lingue supportate nell'applicazione
echo $httpRequest->detectLanguage($langs); // en
```


Fabbrica di richieste .[#toc-requestfactory]
============================================

La classe [api:Nette\Http\RequestFactory] viene utilizzata per creare un'istanza di `Nette\Http\Request`, che rappresenta la richiesta HTTP corrente. (Se si lavora con Nette, l'oggetto richiesta HTTP viene creato automaticamente dal framework).

```php
$factory = new Nette\Http\RequestFactory;
$httpRequest = $factory->fromGlobals();
```

Il metodo `fromGlobals()` crea un oggetto richiesta basato sulle variabili globali PHP correnti (`$_GET`, `$_POST`, `$_COOKIE`, `$_FILES` e `$_SERVER`). Durante la creazione dell'oggetto, pulisce automaticamente tutti i parametri di input GET, POST, COOKIE e l'URL dai caratteri di controllo e dalle sequenze UTF-8 non valide, garantendo così la sicurezza quando si lavorerà con questi dati in seguito.

La RequestFactory può essere configurata prima di chiamare `fromGlobals()`:

- con il metodo `$factory->setBinary()` si può disabilitare la pulizia automatica dei parametri di input dai caratteri di controllo e dalle sequenze UTF-8 non valide.
- con il metodo `$factory->setProxy(...)` si specifica l'indirizzo IP del [server proxy |configuration#HTTP proxy], necessario per il corretto rilevamento dell'indirizzo IP dell'utente.

RequestFactory consente di definire filtri che trasformano automaticamente parti della richiesta di URL. Questi filtri rimuovono dagli URL i caratteri indesiderati che possono essere stati inseriti, ad esempio, da un'errata implementazione dei sistemi di commento su vari siti web:

```php
// rimozione degli spazi dal percorso
$requestFactory->urlFilters['path']['%20'] = '';

// rimozione di un punto, di una virgola o di una parentesi destra dalla fine dell'URI
$requestFactory->urlFilters['url']['[.,)]$'] = '';

// pulizia del percorso da doppi slash (filtro predefinito)
$requestFactory->urlFilters['path']['/{2,}'] = '/';
```

La prima chiave `'path'` o `'url'` determina quale parte dell'URL sarà applicata al filtro. La seconda chiave è un'espressione regolare da cercare e il valore è la sostituzione da usare al posto del testo trovato.


File caricati .[#toc-uploaded-files]
====================================

Il metodo `Nette\Http\Request::getFiles()` restituisce un albero di file caricati in una struttura normalizzata, con ogni foglia un'istanza di [api:Nette\Http\FileUpload]. Questi oggetti incapsulano i dati inviati dall'elemento del form. `<input type=file>` elemento del modulo.

La struttura riflette la denominazione degli elementi in HTML. Nell'esempio più semplice, potrebbe trattarsi di un singolo elemento del modulo con nome, inviato come:

```latte
<input type="file" name="avatar">
```

In questo caso, `$request->getFiles()` restituisce un array:

```php
[
	'avatar' => /* FileUpload instance */
]
```

L'oggetto `FileUpload` viene creato anche se l'utente non ha caricato alcun file o il caricamento è fallito. Il metodo `hasFile()` restituisce true se è stato inviato un file:

```php
$request->getFile('avatar')?->hasFile();
```

Nel caso di un input che utilizza la notazione array per il nome:

```latte
<input type="file" name="my-form[details][avatar]">
```

l'albero restituito finisce per assomigliare a questo:

```php
[
	'my-form' => [
		'details' => [
			'avatar' => /* FileUpload instance */
		],
	],
]
```

È anche possibile creare array di file:

```latte
<input type="file" name="my-form[details][avatars][] multiple">
```

In questo caso la struttura appare come:

```php
[
	'my-form' => [
		'details' => [
			'avatars' => [
				0 => /* FileUpload instance */,
				1 => /* FileUpload instance */,
				2 => /* FileUpload instance */,
			],
		],
	],
]
```

Il modo migliore per accedere all'indice 1 di un array annidato è il seguente:

```php
$file = $request->getFile(['my-form', 'details', 'avatars', 1]);
if ($file instanceof FileUpload) {
	// ...
}
```

Poiché non ci si può fidare dei dati provenienti dall'esterno e quindi non si fa affidamento sulla forma della struttura, questo metodo è più sicuro rispetto a `$request->getFiles()['my-form']['details']['avatars'][1]`che può fallire.


Panoramica dei metodi di `FileUpload` .{toc: FileUpload}
--------------------------------------------------------


hasFile(): bool .[method]
-------------------------
Restituisce `true` se l'utente ha caricato un file.


isOk(): bool .[method]
----------------------
Restituisce `true` se il file è stato caricato con successo.


getError(): int .[method]
-------------------------
Restituisce il codice di errore associato al file caricato. È una delle costanti [UPLOAD_ERR_XXX |http://php.net/manual/en/features.file-upload.errors.php]. Se il file è stato caricato con successo, restituisce `UPLOAD_ERR_OK`.


move(string $dest) .[method]
----------------------------
Sposta un file caricato in una nuova posizione. Se il file di destinazione esiste già, verrà sovrascritto.

```php
$file->move('/path/to/files/name.ext');
```


getContents(): ?string .[method]
--------------------------------
Restituisce il contenuto del file caricato. Se il caricamento non è riuscito, restituisce `null`.


getContentType(): ?string .[method]
-----------------------------------
Rileva il tipo di contenuto MIME del file caricato in base alla sua firma. Se il caricamento non è riuscito o il rilevamento non è andato a buon fine, restituisce `null`.

.[caution]
Richiede l'estensione PHP `fileinfo`.


getUntrustedName(): string .[method]
------------------------------------
Restituisce il nome originale del file come inviato dal browser.

.[caution]
Non fidarsi del valore restituito da questo metodo. Un client potrebbe inviare un nome di file dannoso con l'intento di corrompere o hackerare l'applicazione.


getSanitizedName(): string .[method]
------------------------------------
Restituisce il nome del file sanificato. Contiene solo caratteri ASCII `[a-zA-Z0-9.-]`. Se il nome non contiene tali caratteri, restituisce "unknown". Se il file è un'immagine JPEG, PNG, GIF o WebP, restituisce l'estensione corretta.

.[caution]
Richiede l'estensione PHP `fileinfo`.


getSuggestedExtension(): ?string .[method]{data-version:3.2.4}
--------------------------------------------------------------
Restituisce l'estensione di file appropriata (senza il punto) corrispondente al tipo MIME rilevato.

.[caution]
Richiede l'estensione PHP `fileinfo`.


getUntrustedFullPath(): string .[method]
----------------------------------------
Restituisce il percorso completo originale inviato dal browser durante il caricamento della directory. Il percorso completo è disponibile solo in PHP 8.1 e versioni successive. Nelle versioni precedenti, questo metodo restituisce il nome del file non attendibile.

.[caution]
Non fidarsi del valore restituito da questo metodo. Un client potrebbe inviare un nome di file dannoso con l'intenzione di corrompere o hackerare l'applicazione.


getSize(): int .[method]
------------------------
Restituisce la dimensione del file caricato. Se il caricamento non è riuscito, restituisce `0`.


getTemporaryFile(): string .[method]
------------------------------------
Restituisce il percorso della posizione temporanea del file caricato. Se il caricamento non è riuscito, restituisce `''`.


isImage(): bool .[method]
-------------------------
Restituisce `true` se il file caricato è un'immagine JPEG, PNG, GIF o WebP. Il rilevamento si basa sulla sua firma. L'integrità dell'intero file non viene controllata. È possibile scoprire se un'immagine non è danneggiata, ad esempio provando a [caricarla |#toImage].

.[caution]
Richiede l'estensione PHP `fileinfo`.


getImageSize(): ?array .[method]
--------------------------------
Restituisce una coppia di elementi `[width, height]` con le dimensioni dell'immagine caricata. Se il caricamento non è riuscito o non è un'immagine valida, restituisce `null`.


toImage(): Nette\Utils\Image .[method]
--------------------------------------
Carica un'immagine come oggetto [Image |utils:images]. Se il caricamento non è avvenuto con successo o non è un'immagine valida, viene lanciata un'eccezione `Nette\Utils\ImageException`.
