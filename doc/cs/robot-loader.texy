RobotLoader: autoloading t콏칤d
*****************************

<div class=perex>

RobotLoader je n치stroj, kter칳 v치m zajist칤 komfort automatick칠ho na캜칤t치n칤 t콏칤d pro celou va코i aplikaci v캜etn캩 knihoven t콏et칤ch stran.

- zbav칤me se v코ech `require`
- budou se na캜칤tat jen pot콏ebn칠 skripty
- nevy쬬duje striktn칤 konvence pojmenov치n칤 adres치콏콢 캜i soubor콢

</div>

M콢쬰me tedy zapomenout na tyto zn치m칠 bloky k칩du:

```php
require_once 'Utils/Page.php';
require_once 'Utils/Style.php';
require_once 'Utils/Paginator.php';
// ...
```


Instalace
---------

Knihovnu st景nete a nainstalujete pomoc칤 n치stroje [Composer|/best-practices/composer]:

```shell
composer require nette/robot-loader
```


Pou쬴t칤
-------

Podobn캩, jako Google robot proch치z칤 a indexuje webov칠 str치nky, tak i [RobotLoader |api:Nette\Loaders\RobotLoader] proch치z칤 v코echny PHP skripty a zaznamen치v치 si, kter칠 t콏칤dy, rozhran칤 a traity v nich na코el. V칳sledky b치d치n칤 si pot칠 ulo쮂 do cache a pou쬴je p콏i dal코칤m po쬬davku. Sta캜칤 tedy ur캜it, kter칠 adres치콏e m치 proch치zet a kam ukl치dat cache:

```php
$loader = new Nette\Loaders\RobotLoader;

// adres치콏e, kter칠 m치 RobotLoader indexovat (v캜etn캩 podadres치콏콢)
$loader->addDirectory(__DIR__ . '/app');
$loader->addDirectory(__DIR__ . '/libs');

// nastav칤me cachov치n칤 do adres치콏e 'temp'
$loader->setTempDirectory(__DIR__ . '/temp');
$loader->register(); // spust칤me RobotLoader
```

A to je v코e, od t칠to chv칤le nemus칤me pou쮂셨at `require`. Par치da!

Pokud RobotLoader naraz칤 p콏i indexaci na duplicitn칤 n치zev t콏칤dy, vyhod칤 v칳jimku a informuje v치s o tom. RobotLoader tak칠 automaticky aktualizuje cache, kdy m치 na캜칤st t콏칤du, kterou nezn치. To doporu캜ujeme vypnout na produk캜n칤ch serverech, viz [#Cachov치n칤].

Pokud chcete, aby RobotLoader p콏esko캜il n캩jak칠 adres치콏e, pou쬴jte `$loader->excludeDirectory('temp')` (lze volat v칤cen치sobn캩 nebo p콏edat v칤ce adres치콏콢).

Ve v칳choz칤m nastaven칤 RobotLoader hl치s칤 chyby v souborech PHP vyhozen칤m v칳jimky `ParseError`. To lze potla캜it pomoc칤 `$loader->reportParseErrors(false)`.


Nette aplikace
--------------

Uvnit콏 Nette aplikace, kde se pou쮂셨치 v zav치d캩c칤m souboru `Bootstrap.php` objekt `$configurator`, lze z치pis zjednodu코it:

```php
$configurator = new Nette\Bootstrap\Configurator;
// ...
$configurator->setTempDirectory(__DIR__ . '/../temp');
$configurator->createRobotLoader()
	->addDirectory(__DIR__)
	->addDirectory(__DIR__ . '/../libs')
	->register();
```


Analyz치tor PHP soubor콢
----------------------

RobotLoader lze tak칠 pou쮂셦 캜ist캩 k vyhled치v치n칤 t콏칤d, rozhran칤 a trait v souborech PHP **bez** vyu쮂셨치n칤 funkce autoloadingu:

```php
$loader = new Nette\Loaders\RobotLoader;
$loader->addDirectory(__DIR__ . '/app');

// prohled치 adres치콏e na t콏칤dy / rozhran칤 / traity
$loader->rebuild();

// vrac칤 pole dvojic t콏칤da => n치zev souboru
$res = $loader->getIndexedClasses();
```

I p콏i takov칠m pou쬴t칤 m콢쬰te vyu쮂셦 cache. D칤ky tomu p콏i op캩tovn칠m skenov치n칤 nebudou opakovan캩 analyzov치ny nezm캩n캩n칠 soubory:

```php
$loader = new Nette\Loaders\RobotLoader;
$loader->addDirectory(__DIR__ . '/app');
$loader->setTempDirectory(__DIR__ . '/temp');

// prohled치 adres치콏e s vyu쬴t칤m cache
$loader->refresh();

// vrac칤 pole dvojic t콏칤da => n치zev souboru
$res = $loader->getIndexedClasses();
```


Cachov치n칤
---------

RobotLoader je velice rychl칳, proto쬰 코ikovn캩 vyu쮂셨치 cache.

P콏i v칳voji s n칤m prakticky netu코칤te, 쬰 b캩쮂 na pozad칤. Pr콢b캩쬹캩 si aktualizuje cache, proto쬰 po캜칤t치 s t칤m, 쬰 t콏칤dy a soubory mohou vznikat, zanikat, p콏ejmenov치vat se, atd. A opakovan캩 nescanuje soubory, kter칠 se nezm캩nily.

P콏i nasazen칤 na produk캜n칤m serveru naopak doporu캜ujeme aktualizaci cache vypnout pomoc칤 `$loader->setAutoRefresh(false)` (v Nette Aplikaci se tak d캩je automaticky), proto쬰 soubory se nem캩n칤. Z치rove켿 je pak nutn칠 p콏i nahr치n칤 nov칠 verze na hostingu **smazat cache.**

Prvotn칤 scanov치n칤 soubor콢, kdy cache je코t캩 neexistuje, m콢쬰 u rozs치hlej코칤ch aplikac칤 pochopiteln캩 chvili캜ku trvat. RobotLoader m치 vestav캩nou prevenci p콏ed "cache stampede":https://en.wikipedia.org/wiki/Cache_stampede.
Jde o situaci, kdy se na produk캜n칤m serveru sejde v캩t코칤 po캜et soub캩쬹칳ch po쬬davk콢, kter칠 spust칤 RobotLoader, a proto쬰 cache je코t캩 neexistuje, za캜aly by v코echny scanovat soubory. Co by ne칰m캩rn캩 zat칤쬴lo server.
Na코t캩st칤 RobotLoader funguje tak, 쬰 p콏i v칤ce soub캩쬹칳ch po쬬davc칤ch indexuje soubory pouze prvn칤 vl치kno, vytvo콏칤 cache, ostatn칤 캜ekaj칤 a n치sledn캩 cache vyu쮂셝칤.


PSR-4
-----

Dnes lze pro [autoloading pou쮂셨at Composer|best-practices/composer#autoloading] p콏i dodr쬰n칤 PSR-4. Zjednodu코en캩 콏e캜eno jde o syst칠m, kdy jmenn칠 prostory a n치zvy t콏칤d odpov칤daj칤 adres치콏ov칠 struktu콏e a n치zv콢m soubor콢, tedy nap콏. `App\Router\RouterFactory` bude v souboru `/path/to/App/Router/RouterFactory.php`.

RobotLoader nen칤 s 쮂멳nou pevnou strukturou spjat, proto se hod칤 v situac칤ch, kdy v치m 칰pln캩 nevyhovuje m칤t stejn캩 navr쬰nou adres치콏ovou strukturu jako jmenn칠 prostory v PHP, nebo kdy vyv칤j칤te aplikaci, kter치 historicky takov칠 konvence nevyu쮂셨치. Je mo쬹칠 tak칠 pou쮂셨at oba loadery dohromady.


{{composer: nette/robot-loader}}
{{leftbar: utils/@left-menu}}
