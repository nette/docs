Bootstrap
*********

<div class=perex>

A Bootstrap egy ind√≠t√≥ k√≥d, amely inicializ√°lja a k√∂rnyezetet, l√©trehoz egy f√ºgg≈ës√©gi injekt√°l√°si (DI) kont√©nert, √©s elind√≠tja az alkalmaz√°st. Megbesz√©lj√ºk:

- hogyan konfigur√°lhatja az alkalmaz√°st NEON f√°jlok seg√≠ts√©g√©vel.
- hogyan kezelje a termel√©si √©s a fejleszt√©si m√≥dokat
- hogyan hozzuk l√©tre a DI kont√©nert

</div>


Az alkalmaz√°sok, ak√°r webes alap√∫ak, ak√°r parancssori szkriptek, valamilyen k√∂rnyezet-inicializ√°l√°ssal kezd≈ëdnek. A r√©gi id≈ëkben ez egy pl. `include.inc.php` nev≈± f√°jl lehetett, amely ez√©rt volt felel≈ës, √©s a kezdeti f√°jlban szerepelt.
A modern Nette alkalmaz√°sokban ezt felv√°ltotta a `Bootstrap` oszt√°ly, amely az alkalmaz√°s r√©szek√©nt a `app/Bootstrap.php`. Ez p√©ld√°ul √≠gy n√©zhet ki:

```php
use Nette\Bootstrap\Configurator;

class Bootstrap
{
	private Configurator $configurator;
	private string $rootDir;

	public function __construct()
	{
		$this->rootDir = dirname(__DIR__);
		// A konfigur√°tor felel≈ës az alkalmaz√°si k√∂rnyezet √©s a szolg√°ltat√°sok be√°ll√≠t√°s√°√©rt.
		$this->configurator = new Configurator;
		// A Nette √°ltal gener√°lt ideiglenes f√°jlok (pl. leford√≠tott sablonok) k√∂nyvt√°r√°nak be√°ll√≠t√°sa.
		$this->configurator->setTempDirectory($this->rootDir . '/temp');
	}

	public function bootWebApplication(): Nette\DI\Container
	{
		$this->initializeEnvironment();
		$this->setupContainer();
		return $this->configurator->createContainer();
	}

	private function initializeEnvironment(): void
	{
		// A Nette intelligens, √©s a fejleszt≈ëi √ºzemm√≥d automatikusan bekapcsol,
		// vagy enged√©lyezheti egy adott IP-c√≠mre a k√∂vetkez≈ë sor megjegyz√©s√©nek felold√°s√°val:
		// $this->configurator->setDebugMode('secret@23.75.345.200');

		// Bekapcsolja a Tracy-t: a v√©gs≈ë "sv√°jci bicska" hibakeres√©si eszk√∂z.
		$this->configurator->enableTracy($this->rootDir . '/log');

		// RobotLoader: automatikusan felt√∂lti az √∂sszes oszt√°lyt a megadott k√∂nyvt√°rban.
		$this->configurator->createRobotLoader()
			->addDirectory(__DIR__)
			->register();
	}

	private function setupContainer(): void
	{
		// Konfigur√°ci√≥s f√°jlok bet√∂lt√©se
		$this->configurator->addConfig($this->rootDir . '/config/common.neon');
	}
}
```


index.php .[#toc-index-php]
===========================

A webes alkalmaz√°sok eset√©ben az els≈ëdleges f√°jl a `index.php`, amely a `www/`[nyilv√°nos k√∂nyvt√°rban |directory-structure#public-directory-www] tal√°lhat√≥. Ez a Bootstrap oszt√°llyal inicializ√°lja a k√∂rnyezetet, √©s l√©trehoz egy DI kont√©nert. Ezut√°n megkapja bel≈ële a `Application` szolg√°ltat√°st, amely elind√≠tja a webalkalmaz√°st:

```php
$bootstrap = new App\Bootstrap;
// A k√∂rnyezet inicializ√°l√°sa + DI kont√©ner l√©trehoz√°sa
$container = $bootstrap->bootWebApplication();
// A DI kont√©ner l√©trehoz egy Nette\Application\Application objektumot.
$application = $container->getByType(Nette\Application\Application::class);
// A Nette-alkalmaz√°s elind√≠t√°sa √©s a bej√∂v≈ë k√©r√©sek kezel√©se.
$application->run();
```

Mint l√°that√≥, a [api:Nette\Bootstrap\Configurator] oszt√°ly, amelyet most r√©szletesebben bemutatunk, seg√≠t a k√∂rnyezet be√°ll√≠t√°s√°ban √©s a f√ºgg≈ës√©gi injekt√°l√°s (DI) kont√©ner l√©trehoz√°s√°ban.


Fejleszt≈ëi vs. termel√©si √ºzemm√≥d .[#toc-development-vs-production-mode]
=======================================================================

A Nette m√°sk√©pp viselkedik att√≥l f√ºgg≈ëen, hogy fejleszt√©si vagy termel√©si szerveren fut:

üõ†Ô∏è Fejleszt√©si m√≥d:
	- Megjelen√≠ti a Tracy hibakeres≈ë s√°vot hasznos inform√°ci√≥kkal (pl. SQL-lek√©rdez√©sek, v√©grehajt√°si id≈ë, mem√≥riahaszn√°lat).
	- Hiba eset√©n r√©szletes hibalevelet jelen√≠t meg f√ºggv√©nyh√≠v√°s nyomvonalakkal √©s v√°ltoz√≥tartalommal.
	- Automatikusan friss√≠ti a gyors√≠t√≥t√°rat, amikor a Latte sablonok, konfigur√°ci√≥s f√°jlok stb. m√≥dosulnak.


üöÄ Termel√©si m√≥d:
	- Nem jelen√≠t meg semmilyen hibakeres√©si inform√°ci√≥t; minden hiba napl√≥z√°sra ker√ºl.
	- Hiba eset√©n megjelen√≠t egy `ErrorPresenter` vagy egy √°ltal√°nos "Szerverhiba" oldalt.
	- A gyors√≠t√≥t√°r soha nem friss√ºl automatikusan!
	- A sebess√©gre √©s a biztons√°gra optimaliz√°lt.


Az √ºzemm√≥dot automatikusan hat√°rozza meg, √≠gy a legt√∂bb esetben nincs sz√ºks√©g a manu√°lis be√°ll√≠t√°sra vagy v√°lt√°sra:

- Fejleszt√©si √ºzemm√≥d: `127.0.0.1` vagy `::1`), kiv√©ve, ha proxy van haszn√°latban (azaz a HTTP fejl√©cek alapj√°n).
- Gy√°rt√°si √ºzemm√≥d: Mindenhol m√°shol akt√≠v.

Ha m√°s esetekben, p√©ld√°ul egy adott IP-c√≠mr≈ël hozz√°f√©r≈ë programoz√≥k sz√°m√°ra szeretn√© enged√©lyezni a fejleszt√©si √ºzemm√≥dot, akkor a `setDebugMode()` c√≠met haszn√°lhatja:

```php
$this->configurator->setDebugMode('23.75.345.200'); // egy vagy t√∂bb IP-c√≠m
```

Mindenk√©ppen javasoljuk az IP-c√≠m √©s a cookie kombin√°l√°s√°t. A `nette-debug` cookie-ban t√°rolunk egy titkos tokent, pl. `secret1234`, √©s a fejleszt√©si m√≥d az IP √©s a cookie ilyen kombin√°ci√≥j√°val rendelkez≈ë programoz√≥k sz√°m√°ra aktiv√°l√≥dik.

```php
$this->configurator->setDebugMode('secret1234@23.75.345.200');
```

A fejleszt≈ëi m√≥dot teljesen ki is kapcsolhatjuk, ak√°r a localhost eset√©ben is:

```php
$this->configurator->setDebugMode(false);
```

A `true` √©rt√©k kem√©nyen bekapcsolja a fejleszt≈ëi m√≥dot, ami soha nem t√∂rt√©nhet meg egy termel≈ë szerveren.


Hibakeres≈ë eszk√∂z Tracy .[#toc-debugging-tool-tracy]
====================================================

Az egyszer≈± hibakeres√©s √©rdek√©ben bekapcsoljuk a [Tracy |tracy:] nev≈± nagyszer≈± eszk√∂zt. Fejleszt≈ëi m√≥dban megjelen√≠ti a hib√°kat, termel√©si m√≥dban pedig a megadott k√∂nyvt√°rba napl√≥zza a hib√°kat:

```php
$this->configurator->enableTracy($this->rootDir . '/log');
```


Ideiglenes f√°jlok .[#toc-temporary-files]
=========================================

A Nette a DI kont√©ner, a RobotLoader, a sablonok stb. sz√°m√°ra haszn√°lja a gyors√≠t√≥t√°rat. Ez√©rt sz√ºks√©ges annak a k√∂nyvt√°rnak az el√©r√©si √∫tvonal√°t be√°ll√≠tani, ahol a gyors√≠t√≥t√°r t√°rol√°sra ker√ºl:

```php
$this->configurator->setTempDirectory($this->rootDir . '/temp');
```

Linuxon vagy macOS-en √°ll√≠tsa be a `log/` √©s a `temp/` k√∂nyvt√°rak [√≠r√°si enged√©lyeit |nette:troubleshooting#Setting directory permissions].


RobotLoader .[#toc-robotloader]
===============================

√Åltal√°ban a [RobotLoader |robot-loader:] seg√≠ts√©g√©vel szeretn√©nk automatikusan bet√∂lteni az oszt√°lyokat, ez√©rt el kell ind√≠tanunk, √©s hagynunk kell, hogy bet√∂ltse az oszt√°lyokat abb√≥l a k√∂nyvt√°rb√≥l, ahol a `Bootstrap.php` tal√°lhat√≥ (azaz `__DIR__`) √©s annak √∂sszes alk√∂nyvt√°r√°b√≥l:

```php
$this->configurator->createRobotLoader()
	->addDirectory(__DIR__)
	->register();
```

Egy alternat√≠v megold√°s az, hogy csak a [Composer |best-practices:composer] PSR-4 automatikus bet√∂lt√©s√©t haszn√°ljuk.


Id≈ëz√≥na .[#toc-timezone]
========================

A Configurator lehet≈ëv√© teszi, hogy megadjon egy id≈ëz√≥n√°t az alkalmaz√°s√°hoz.

```php
$this->configurator->setTimeZone('Europe/Prague');
```


DI kont√©ner konfigur√°l√°sa .[#toc-di-container-configuration]
============================================================

Az ind√≠t√°si folyamat r√©sze a DI kont√©ner, azaz az objektumgy√°r l√©trehoz√°sa, amely az eg√©sz alkalmaz√°s sz√≠ve. Ez tulajdonk√©ppen egy Nette √°ltal gener√°lt √©s egy cache k√∂nyvt√°rban t√°rolt PHP oszt√°ly. A gy√°r l√©trehozza az alkalmaz√°s kulcsfontoss√°g√∫ objektumait, a konfigur√°ci√≥s f√°jlok pedig utas√≠tj√°k, hogyan hozza l√©tre √©s konfigur√°lja ≈ëket, √©s √≠gy befoly√°soljuk az eg√©sz alkalmaz√°s viselked√©s√©t.

A konfigur√°ci√≥s f√°jlokat √°ltal√°ban [NEON form√°tumban |neon:format] √≠rjuk. Itt olvashatja el, hogy mit lehet [konfigur√°lni |nette:configuring].

.[tip]
Fejleszt≈ëi √ºzemm√≥dban a kont√©ner automatikusan friss√ºl minden alkalommal, amikor megv√°ltoztatja a k√≥dot vagy a konfigur√°ci√≥s f√°jlokat. Termel√©si m√≥dban csak egyszer gener√°l√≥dik, √©s a teljes√≠tm√©ny maximaliz√°l√°sa √©rdek√©ben a f√°jlv√°ltoz√°sokat nem ellen≈ërzi a rendszer.

A konfigur√°ci√≥s f√°jlok bet√∂lt√©se a `addConfig()` seg√≠ts√©g√©vel t√∂rt√©nik:

```php
$this->configurator->addConfig($this->rootDir . '/config/common.neon');
```

A `addConfig()` met√≥dus t√∂bbsz√∂r is megh√≠vhat√≥ t√∂bb f√°jl hozz√°ad√°s√°hoz.

```php
$configDir = $this->rootDir . '/config';
$this->configurator->addConfig($configDir . '/common.neon');
$this->configurator->addConfig($configDir . '/services.neon');
if (PHP_SAPI === 'cli') {
	$this->configurator->addConfig($configDir . '/cli.php');
}
```

A `cli.php` n√©v nem el√≠r√°s, a konfigur√°ci√≥ egy PHP f√°jlba is √≠rhat√≥, amely t√∂mbk√©nt adja vissza.

Alternat√≠vak√©nt haszn√°lhatjuk a [`includes` szekci√≥t |dependency-injection:configuration#including files] is, hogy t√∂bb konfigur√°ci√≥s f√°jlt t√∂lts√ºnk be.

Ha a konfigur√°ci√≥s f√°jlokban azonos kulcs√∫ elemek jelennek meg, akkor azok [fel√ºl√≠r√≥dnak, vagy |dependency-injection:configuration#Merging] t√∂mb√∂k eset√©n [√∂sszevon√°sra |dependency-injection:configuration#Merging] ker√ºlnek. A k√©s≈ëbb bevont f√°jlnak magasabb priorit√°sa van, mint az el≈ëz≈ënek. Az a f√°jl, amelyben a `includes` szakasz szerepel, magasabb priorit√°ssal rendelkezik, mint a benne foglalt f√°jlok.


Statikus param√©terek .[#toc-static-parameters]
----------------------------------------------

A konfigur√°ci√≥s f√°jlokban haszn√°lt param√©tereket a [`parameters` szakaszban |dependency-injection:configuration#parameters] lehet defini√°lni, √©s a `addStaticParameters()` met√≥dus (amelynek alias neve `addParameters()`) is √°tadhatja (vagy fel√ºl√≠rhatja). Fontos, hogy a k√ºl√∂nb√∂z≈ë param√©ter√©rt√©kek tov√°bbi DI-kont√©nerek, azaz tov√°bbi oszt√°lyok gener√°l√°s√°t okozz√°k.

```php
$this->configurator->addStaticParameters([
	'projectId' => 23,
]);
```

A konfigur√°ci√≥s f√°jlokban a `%projectId%` szok√°sos jel√∂l√©st √≠rhatjuk a `projectId` nev≈± param√©ter el√©r√©s√©hez.


Dinamikus param√©terek .[#toc-dynamic-parameters]
------------------------------------------------

A kont√©nerhez dinamikus param√©tereket is hozz√°adhatunk, ezek elt√©r≈ë √©rt√©kei a statikus param√©terekkel ellent√©tben nem okoznak √∫j DI-kont√©nerek gener√°l√°s√°t.

```php
$this->configurator->addDynamicParameters([
	'remoteIp' => $_SERVER['REMOTE_ADDR'],
]);
```

A k√∂rnyezeti v√°ltoz√≥kat k√∂nnyen el√©rhet≈ëv√© tehetn√©nk dinamikus param√©terek seg√≠ts√©g√©vel. A konfigur√°ci√≥s f√°jlokban a `%env.variable%` c√≠men kereszt√ºl √©rhetj√ºk el ≈ëket.

```php
$this->configurator->addDynamicParameters([
	'env' => getenv(),
]);
```


Alap√©rtelmezett param√©terek .[#toc-default-parameters]
------------------------------------------------------

A konfigur√°ci√≥s f√°jlokban a k√∂vetkez≈ë statikus param√©tereket haszn√°lhatja:

- `%appDir%` a `Bootstrap.php` f√°jl k√∂nyvt√°r√°nak abszol√∫t el√©r√©si √∫tja.
- `%wwwDir%` a `index.php` beviteli f√°jlt tartalmaz√≥ k√∂nyvt√°r abszol√∫t el√©r√©si √∫tja.
- `%tempDir%` az ideiglenes f√°jlok k√∂nyvt√°r√°nak abszol√∫t el√©r√©si √∫tja.
- `%vendorDir%` az abszol√∫t el√©r√©si √∫t a k√∂nyvt√°rak Composer √°ltali telep√≠t√©s√©nek k√∂nyvt√°r√°hoz.
- `%rootDir%` a projekt gy√∂k√©rk√∂nyvt√°r√°nak abszol√∫t el√©r√©si √∫tvonala.
- `%debugMode%` jelzi, hogy az alkalmaz√°s hibakeres√©si m√≥dban van-e.
- `%consoleMode%` jelzi, hogy a k√©r√©s a parancssoron kereszt√ºl √©rkezett-e.


Import√°lt szolg√°ltat√°sok .[#toc-imported-services]
--------------------------------------------------

Most m√©lyebbre megy√ºnk. B√°r a DI kont√©ner c√©lja az objektumok l√©trehoz√°sa, kiv√©telesen sz√ºks√©g lehet arra, hogy egy megl√©v≈ë objektumot beillessz√ºnk a kont√©nerbe. Ezt √∫gy tessz√ºk meg, hogy a szolg√°ltat√°st a `imported: true` attrib√∫tummal defini√°ljuk.

```neon
services:
	myservice:
		type: App\Model\MyCustomService
		imported: true
```

Hozzunk l√©tre egy √∫j p√©ld√°nyt, √©s illessz√ºk be a bootstrapbe:

```php
$this->configurator->addServices([
	'myservice' => new App\Model\MyCustomService('foobar'),
]);
```


K√ºl√∂nb√∂z≈ë k√∂rnyezetek .[#toc-different-environments]
====================================================

Ne habozzon, ha a `Bootstrap` oszt√°lyt saj√°t ig√©nyei szerint alak√≠thatja. A `bootWebApplication()` met√≥dushoz param√©tereket adhat hozz√° a webes projektek megk√ºl√∂nb√∂ztet√©se √©rdek√©ben. Alternat√≠vak√©nt m√°s met√≥dusokat is hozz√°adhat, p√©ld√°ul a `bootTestEnvironment()` a k√∂rnyezet inicializ√°l√°s√°hoz a unit tesztekhez, a `bootConsoleApplication()` a parancssorb√≥l h√≠vott szkriptekhez stb.

```php
public function bootTestEnvironment(): Nette\DI\Container
{
	Tester\Environment::setup(); // Nette Tester inicializ√°l√°sa
	$this->setupContainer();
	return $this->configurator->createContainer();
}

public function bootConsoleApplication(): Nette\DI\Container
{
	$this->configurator->setDebugMode(false);
	$this->initializeEnvironment();
	$this->setupContainer();
	return $this->configurator->createContainer();
}
```
