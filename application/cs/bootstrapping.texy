Bootstrapping
*************

<div class=perex>

Bootstrapping je proces inicializace prost≈ôed√≠ aplikace, vytvo≈ôen√≠ kontejneru pro dependency injection (DI) a spu≈°tƒõn√≠ aplikace. Budeme prob√≠rat:

- jak t≈ô√≠da Bootstrap inicializuje prost≈ôed√≠
- jak jsou aplikace konfigurov√°ny pomoc√≠ NEON soubor≈Ø
- jak rozli≈°ovat mezi produkƒçn√≠m a v√Ωvoj√°≈ôsk√Ωm re≈æimem
- jak vytvo≈ôit a nakonfigurovat DI kontejner

</div>


Aplikace, a≈• u≈æ jde o ty webov√© nebo skripty spou≈°tƒõn√© z p≈ô√≠kazov√© ≈ô√°dky, zaƒç√≠naj√≠ sv≈Øj bƒõh nƒõjakou formou inicializace prost≈ôed√≠. V d√°vn√Ωch dob√°ch to m√≠val na starosti soubor s n√°zvem t≈ôeba `include.inc.php`, kter√Ω prvotn√≠ soubor inkludoval. V modern√≠ch Nette aplikac√≠ch jej nahradila t≈ô√≠da `Bootstrap`, kterou jako≈æto souƒç√°st aplikace najdete v souboru `app/Bootstrap.php`. M≈Ø≈æe vypadat kup≈ô√≠kladu takto:

```php
use Nette\Bootstrap\Configurator;

class Bootstrap
{
	private Configurator $configurator;
	private string $rootDir;

	public function __construct()
	{
		$this->rootDir = dirname(__DIR__);
		// Konfigur√°tor je zodpovƒõdn√Ω za nastaven√≠ prost≈ôed√≠ aplikace a slu≈æeb.
		$this->configurator = new Configurator;
		// Nastav√≠ adres√°≈ô pro doƒçasn√© soubory generovan√© Nette (nap≈ô. zkompilovan√© ≈°ablony)
		$this->configurator->setTempDirectory($this->rootDir . '/temp');
	}

	public function bootWebApplication(): Nette\DI\Container
	{
		$this->initializeEnvironment();
		$this->setupContainer();
		return $this->configurator->createContainer();
	}

	private function initializeEnvironment(): void
	{
		// Nette je chytr√© a v√Ωvojov√Ω re≈æim se zap√≠n√° automaticky,
		// nebo jej m≈Ø≈æete povolit pro konkr√©tn√≠ IP adresu odkomentov√°n√≠m n√°sleduj√≠c√≠ho ≈ô√°dku:
		// $this->configurator->setDebugMode('secret@23.75.345.200');

		// Aktivuje Tracy: ultim√°tn√≠ "≈°v√Ωcarsk√Ω n≈Ø≈æ" pro ladƒõn√≠.
		$this->configurator->enableTracy($this->rootDir . '/log');

		// RobotLoader: automaticky naƒç√≠t√° v≈°echny t≈ô√≠dy ve zvolen√©m adres√°≈ôi
		$this->configurator->createRobotLoader()
			->addDirectory(__DIR__)
			->register();
	}

	private function setupContainer(): void
	{
		// Naƒçte konfiguraƒçn√≠ soubory
		$this->configurator->addConfig($this->rootDir . '/config/common.neon');
	}
}
```


index.php
=========

Prvotn√≠ soubor je v p≈ô√≠padƒõ webov√Ωch aplikac√≠ `index.php`, kter√Ω se nach√°z√≠ ve [ve≈ôejn√©m adres√°≈ôi |directory-structure#Ve≈ôejn√Ω adres√°≈ô www] `www/`. Ten si nech√° od t≈ô√≠dy Bootstrap inicializovat prost≈ôed√≠ a vyrobit DI kontejner. Pot√© z nƒõj z√≠sk√° slu≈æbu `Application`, kter√° spust√≠ webovou aplikaci:

```php
$bootstrap = new App\Bootstrap;
// Inicializace prost≈ôed√≠ + vytvo≈ôen√≠ DI kontejneru
$container = $bootstrap->bootWebApplication();
// DI kontejner vytvo≈ô√≠ objekt Nette\Application\Application
$application = $container->getByType(Nette\Application\Application::class);
// Spu≈°tƒõn√≠ aplikace Nette a zpracov√°n√≠ p≈ô√≠choz√≠ho po≈æadavku
$application->run();
```

Jak vidno, s nastaven√≠m prost≈ôed√≠ a vytvo≈ôen√≠m dependency injection (DI) kontejneru pom√°h√° t≈ô√≠da [api:Nette\Bootstrap\Configurator], kterou si nyn√≠ bl√≠≈æe p≈ôedstav√≠me.


V√Ωvoj√°≈ôsk√Ω vs produkƒçn√≠ re≈æim
=============================

Nette se chov√° r≈Øznƒõ podle toho, zda bƒõ≈æ√≠ na v√Ωvoj√°≈ôsk√©m nebo produkƒçn√≠m serveru:

üõ†Ô∏è  V√Ωvoj√°≈ôsk√Ω re≈æim (Development):
	- Zobrazuje Tracy debugbar s u≈æiteƒçn√Ωmi informacemi (SQL dotazy, ƒças vykon√°n√≠, pou≈æit√° pamƒõ≈•)
	- P≈ôi chybƒõ zobraz√≠ detailn√≠ chybovou str√°nku s vol√°n√≠m funkc√≠ a obsahem promƒõnn√Ωch
	- Automaticky obnovuje cache p≈ôi zmƒõnƒõ Latte ≈°ablon, √∫pravƒõ konfiguraƒçn√≠ch soubor≈Ø atd.


üöÄ  Produkƒçn√≠ re≈æim (Production):
	- Nezobrazuje ≈æ√°dn√© lad√≠c√≠ informace, v≈°echny chyby zapisuje do logu
	- P≈ôi chybƒõ zobraz√≠ ErrorPresenter nebo obecnou str√°nku "Server Error"
	- Cache se nikdy automaticky neobnovuje!
	- Optimalizovan√Ω pro rychlost a bezpeƒçnost


Volba re≈æimu se prov√°d√≠ autodetekc√≠, tak≈æe obvykle nen√≠ pot≈ôeba nic konfigurovat nebo ruƒçnƒõ p≈ôep√≠nat:

- v√Ωvoj√°≈ôsk√Ω re≈æim: na localhostu (IP adresa `127.0.0.1` nebo `::1`) pokud nen√≠ p≈ô√≠tomn√° proxy (tj. jej√≠ HTTP hlaviƒçka)
- produkƒçn√≠ re≈æim: v≈°ude jinde

Pokud chceme v√Ωvoj√°≈ôsk√Ω re≈æim povolit i v dal≈°√≠ch p≈ô√≠padech, nap≈ô√≠klad program√°tor≈Øm p≈ôistupuj√≠c√≠m z konkr√©tn√≠ IP adresy, pou≈æijeme `setDebugMode()`:

```php
$this->configurator->setDebugMode('23.75.345.200'); // lze uv√©st i pole IP adres
```

Rozhodnƒõ doporuƒçujeme kombinovat IP adresu s cookie. Do cookie `nette-debug` ulo≈æ√≠me tajn√Ω token, nap≈ô. `secret1234`, a t√≠mto zp≈Øsobem aktivujeme v√Ωvoj√°≈ôsk√Ω re≈æim pro program√°tory p≈ôistupuj√≠c√≠ z konkr√©tn√≠ IP adresy a z√°rove≈à maj√≠c√≠ v cookie zm√≠nƒõn√Ω token:

```php
$this->configurator->setDebugMode('secret1234@23.75.345.200');
```

V√Ωvoj√°≈ôsk√Ω re≈æim m≈Ø≈æeme tak√© vypnout √∫plnƒõ, i pro localhost:

```php
$this->configurator->setDebugMode(false);
```

Pozor, hodnota `true` zapne v√Ωvoj√°≈ôsk√Ω re≈æim natvrdo, co≈æ se nikdy nesm√≠ st√°t na produkƒçn√≠m serveru.


Debugovac√≠ n√°stroj Tracy
========================

Pro snadn√© debugov√°n√≠ je≈°tƒõ zapneme skvƒõl√Ω n√°stroj [Tracy |tracy:]. Ve v√Ωvoj√°≈ôsk√©m re≈æimu chyby vizualizuje a v produkƒçn√≠m re≈æimu chyby loguje do uveden√©ho adres√°≈ôe:

```php
$this->configurator->enableTracy($this->rootDir . '/log');
```


Doƒçasn√© soubory
===============

Nette vyu≈æ√≠v√° cache pro DI kontejner, RobotLoader, ≈°ablony atd. Proto je nutn√© nastavit cestu k adres√°≈ôi, kam se bude cache ukl√°dat:

```php
$this->configurator->setTempDirectory($this->rootDir . '/temp');
```

Na Linuxu nebo macOS nastavte adres√°≈ô≈Øm `log/` a `temp/` [pr√°va pro z√°pis |nette:troubleshooting#Nastaven√≠ pr√°v adres√°≈ô≈Ø].


RobotLoader
===========

Zpravidla budeme cht√≠t automaticky naƒç√≠tat t≈ô√≠dy pomoc√≠ [RobotLoaderu |robot-loader:], mus√≠me ho tedy nastartovat a nech√°me jej naƒç√≠tat t≈ô√≠dy z adres√°≈ôe, kde je um√≠stƒõn√Ω `Bootstrap.php` (tj. `__DIR__`), a v≈°ech podadres√°≈ô≈Ø:

```php
$this->configurator->createRobotLoader()
	->addDirectory(__DIR__)
	->register();
```

Alternativn√≠ p≈ô√≠stup je nechat t≈ô√≠dy naƒç√≠tat pouze p≈ôes [Composer |best-practices:composer] p≈ôi dodr≈æen√≠ PSR-4.


Timezone
========

P≈ôes konfigur√°tor m≈Ø≈æete nastavit v√Ωchoz√≠ ƒçasovou z√≥nu.

```php
$this->configurator->setTimeZone('Europe/Prague');
```


Konfigurace DI kontejneru
=========================

Souƒç√°st√≠ bootovac√≠ho procesu je vytvo≈ôen√≠ DI kontejneru neboli tov√°rny na objekty, co≈æ je srdce cel√© aplikace. Jde vlastnƒõ o PHP t≈ô√≠du, kterou vygeneruje Nette a ulo≈æ√≠ do adres√°≈ôe s cache. Tov√°rna vyr√°b√≠ kl√≠ƒçov√© objekty aplikace a pomoc√≠ konfiguraƒçn√≠ch soubor≈Ø j√≠ instruujeme, jak je m√° vytv√°≈ôet a nastavovat, ƒç√≠m≈æ ovliv≈àujeme chov√°n√≠ cel√© aplikace.

Konfiguraƒçn√≠ soubory se obvykle zapisuj√≠ ve form√°tu [NEON |neon:format]. V samostatn√© kapitole se doƒçtete, [co v≈°e lze konfigurovat |nette:configuring].

.[tip]
Ve v√Ωvoj√°≈ôsk√©m re≈æimu se kontejner automaticky aktualizuje p≈ôi ka≈æd√© zmƒõnƒõ k√≥du nebo konfiguraƒçn√≠ch soubor≈Ø. V produkƒçn√≠m re≈æimu se vygeneruje jen jednou a zmƒõny se kv≈Øli maximalizaci v√Ωkonu nekontroluj√≠.

Konfiguraƒçn√≠ soubory naƒçteme pomoc√≠ `addConfig()`:

```php
$this->configurator->addConfig($this->rootDir . '/config/common.neon');
```

Pokud chceme p≈ôidat v√≠ce konfiguraƒçn√≠ch soubor≈Ø, m≈Ø≈æeme funkci `addConfig()` zavolat v√≠cekr√°t.

```php
$configDir = $this->rootDir . '/config';
$this->configurator->addConfig($configDir . '/common.neon');
$this->configurator->addConfig($configDir . '/services.neon');
if (PHP_SAPI === 'cli') {
	$this->configurator->addConfig($configDir . '/cli.php');
}
```

N√°zev `cli.php` nen√≠ p≈ôeklep, konfigurace m≈Ø≈æe b√Ωt zapsan√° tak√© v PHP souboru, kter√Ω ji vr√°t√≠ jako pole.

Tak√© m≈Ø≈æeme p≈ôidat dal≈°√≠ konfiguraƒçn√≠ soubory v [sekci `includes` |dependency-injection:configuration#Vkl√°d√°n√≠ soubor≈Ø].

Pokud se v konfiguraƒçn√≠ch souborech objev√≠ prvky se stejn√Ωmi kl√≠ƒçi, budou p≈ôeps√°ny, nebo v p≈ô√≠padƒõ [pol√≠ slouƒçeny |dependency-injection:configuration#Sluƒçov√°n√≠]. Pozdƒõji vkl√°dan√Ω soubor m√° vy≈°≈°√≠ prioritu ne≈æ p≈ôedchoz√≠. Soubor, ve kter√©m je sekce `includes` uvedena, m√° vy≈°≈°√≠ prioritu ne≈æ v nƒõm inkludovan√© soubory.


Statick√© parametry
------------------

Parametry pou≈æ√≠van√© v konfiguraƒçn√≠ch souborech m≈Ø≈æeme definovat [v sekci `parameters` |dependency-injection:configuration#Parametry] a tak√© je p≈ôed√°vat (ƒçi p≈ôepisovat) metodou `addStaticParameters()` (m√° alias `addParameters()`). D≈Øle≈æit√© je, ≈æe r≈Øzn√© hodnoty parametr≈Ø zp≈Øsob√≠ vygenerov√°n√≠ dal≈°√≠ch DI kontejner≈Ø, tedy dal≈°√≠ch t≈ô√≠d.

```php
$this->configurator->addStaticParameters([
	'projectId' => 23,
]);
```

Na parametr `projectId` se lze v konfiguraci odk√°zat obvykl√Ωm z√°pisem `%projectId%`.


Dynamick√© parametry
-------------------

Do kontejneru m≈Ø≈æeme p≈ôidat i dynamick√© parametry, jejich≈æ r≈Øzn√© hodnoty na rozd√≠l od statick√Ωch parameter≈Ø nezp≈Øsob√≠ generov√°n√≠ nov√Ωch DI kontejner≈Ø.

```php
$this->configurator->addDynamicParameters([
	'remoteIp' => $_SERVER['REMOTE_ADDR'],
]);
```

Jednodu≈°e tak m≈Ø≈æeme p≈ôidat nap≈ô. environment√°ln√≠ promƒõnn√©, na kter√© se pak lze v konfiguraci odk√°zat z√°pisem `%env.variable%`.

```php
$this->configurator->addDynamicParameters([
	'env' => getenv(),
]);
```


V√Ωchoz√≠ parametry
-----------------

V konfiguraƒçn√≠ch souborech m≈Ø≈æete vyu≈æ√≠t tyto statick√© parametry:

- `%appDir%` je absolutn√≠ cesta k adres√°≈ôi se souborem `Bootstrap.php`
- `%wwwDir%` je absolutn√≠ cesta k adres√°≈ôi se vstupn√≠m souborem `index.php`
- `%tempDir%` je absolutn√≠ cesta k adres√°≈ôi pro doƒçasn√© soubory
- `%vendorDir%` je absolutn√≠ cesta k adres√°≈ôi, kam Composer instaluje knihovny
- `%rootDir%` je absolutn√≠ cesta ke ko≈ôenov√©mu adres√°≈ôi projektu
- `%baseUrl%` je absolutn√≠ URL ke ko≈ôenov√©mu adres√°≈ôi
- `%debugMode%` ud√°v√°, zda je aplikace v debugovac√≠m re≈æimu
- `%consoleMode%` ud√°v√°, zda request p≈ôi≈°el p≈ôes p≈ô√≠kazovou ≈ô√°dku


Importovan√© slu≈æby
------------------

Nyn√≠ u≈æ jdeme hloubƒõji. Aƒçkoliv je smyslem DI kontejneru objekty vyr√°bet, v√Ωjimeƒçnƒõ m≈Ø≈æe vzniknout pot≈ôeba do kontejneru existuj√≠c√≠ objekt vlo≈æit. Udƒõl√°me to tak, ≈æe slu≈æbu definujeme s p≈ô√≠znakem `imported: true`.

```neon
services:
	myservice:
		type: App\Model\MyCustomService
		imported: true
```

A v bootstrapu do kontejneru vlo≈æ√≠me objekt:

```php
$this->configurator->addServices([
	'myservice' => new App\Model\MyCustomService('foobar'),
]);
```


Odli≈°n√© prost≈ôed√≠
=================

Nebojte se upravit t≈ô√≠du Bootstrap podle sv√Ωch pot≈ôeb. Metodƒõ `bootWebApplication()` m≈Ø≈æete p≈ôidat parametry pro rozli≈°en√≠ webov√Ωch projekt≈Ø. Nebo m≈Ø≈æeme doplnit dal≈°√≠ metody, nap≈ô√≠klad `bootTestEnvironment()`, kter√° inicializuje prost≈ôed√≠ pro jednotkov√© testy, `bootConsoleApplication()` pro skripty volan√© z p≈ô√≠kazov√© ≈ô√°dky atd.

```php
public function bootTestEnvironment(): Nette\DI\Container
{
	Tester\Environment::setup(); // inicializace Nette Testeru
	$this->setupContainer();
	return $this->configurator->createContainer();
}

public function bootConsoleApplication(): Nette\DI\Container
{
	$this->configurator->setDebugMode(false);
	$this->initializeEnvironment();
	$this->setupContainer();
	return $this->configurator->createContainer();
}
```
