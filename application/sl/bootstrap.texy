Bootstrap
*********

<div class=perex>

Bootstrap je zagonska koda, ki inicializira okolje, ustvari vsebnik za vbrizgavanje odvisnosti (DI) in zaÅ¾ene aplikacijo. Obravnavali bomo:

- kako konfigurirati aplikacijo z datotekami NEON
- kako ravnati s produkcijskim in razvojnim naÄinom
- kako ustvariti vsebnik DI

</div>


Aplikacije, ne glede na to, ali temeljijo na spletu ali skripti ukazne vrstice, se zaÄnejo z doloÄeno obliko inicializacije okolja. V starih Äasih je bila za to lahko odgovorna datoteka z imenom npr. `include.inc.php`, ki je bila vkljuÄena v zaÄetno datoteko. V sodobnih aplikacijah Nette jo je nadomestil razred `Bootstrap`, ki se kot del aplikacije nahaja v datoteki `app/Bootstrap.php`. Izgleda lahko na primer takole:

```php
use Nette\Bootstrap\Configurator;

class Bootstrap
{
	private Configurator $configurator;
	private string $rootDir;

	public function __construct()
	{
		$this->rootDir = dirname(__DIR__);
		// Konfigurator je odgovoren za nastavitev okolja aplikacije in storitev.
		$this->configurator = new Configurator;
		// Nastavite imenik za zaÄasne datoteke, ki jih ustvari Nette (npr. sestavljene predloge).
		$this->configurator->setTempDirectory($this->rootDir . '/temp');
	}

	public function bootWebApplication(): Nette\DI\Container
	{
		$this->initializeEnvironment();
		$this->setupContainer();
		return $this->configurator->createContainer();
	}

	private function initializeEnvironment(): void
	{
		// Program Nette je pameten in razvojni naÄin se vklopi samodejno,
		// lahko pa ga za doloÄen naslov IP omogoÄite tako, da odkomentirate naslednjo vrstico:
		// $this->configurator->setDebugMode('secret@23.75.345.200');

		// OmogoÄi Tracy: najboljÅ¡e orodje za razhroÅ¡Äevanje "Å¡vicarskega noÅ¾a".
		$this->configurator->enableTracy($this->rootDir . '/log');

		// RobotLoader: samodejno naloÅ¾i vse razrede v danem imeniku
		$this->configurator->createRobotLoader()
			->addDirectory(__DIR__)
			->register();
	}

	private function setupContainer(): void
	{
		// Nalaganje konfiguracijskih datotek
		$this->configurator->addConfig($this->rootDir . '/config/common.neon');
	}
}
```


index.php .[#toc-index-php]
===========================

Pri spletnih aplikacijah je primarna datoteka `index.php`, ki se nahaja v [javnem imeniku |directory-structure#public-directory-www] `www/`. S tem bo razred Bootstrap inicializiral okolje in izdelal vsebnik DI. Iz njega nato pridobi storitev `Application`, ki zaÅ¾ene spletno aplikacijo:

```php
$bootstrap = new App\Bootstrap;
// Inicializacija okolja + ustvarjanje vsebnika DI
$container = $bootstrap->bootWebApplication();
// vsebnik DI ustvari objekt Nette\Application\Application
$application = $container->getByType(Nette\Application\Application::class);
// Zagnati aplikacijo Nette in obdelati vhodno zahtevo
$application->run();
```

Kot vidite, razred [api:Nette\Bootstrap\Configurator], ki ga bomo zdaj podrobneje predstavili, pomaga pri vzpostavljanju okolja in ustvarjanju vsebnika za vbrizgavanje odvisnosti (DI).


Razvojni in produkcijski naÄin .[#toc-development-vs-production-mode]
=====================================================================

Nette se obnaÅ¡a razliÄno, odvisno od tega, ali deluje v razvojnem ali produkcijskem streÅ¾niku:

ğŸ› ï¸ Razvojni naÄin:
	- PrikaÅ¾e Tracyjev razhroÅ¡Äevalni niz z uporabnimi informacijami (npr. poizvedbe SQL, Äas izvajanja, poraba pomnilnika).
	- PrikaÅ¾e podrobno stran z napakami s sledmi klicev funkcij in vsebino spremenljivk, ko pride do napake.
	- Samodejno osveÅ¾i predpomnilnik, ko se spremenijo predloge Latte, konfiguracijske datoteke itd.


ğŸš€ Produkcijski naÄin:
	- Ne prikaÅ¾e nobenih informacij o odpravljanju napak; vse napake se zabeleÅ¾ijo.
	- PrikaÅ¾e stran `ErrorPresenter` ali sploÅ¡no stran "Server Error" (Napaka streÅ¾nika), ko pride do napake.
	- Predpomnilnik se nikoli samodejno ne osveÅ¾i!
	- Optimizirano za hitrost in varnost.


NaÄin se doloÄi samodejno, zato ga v veÄini primerov ni treba roÄno konfigurirati ali preklapljati:

- Razvojni naÄin: (IP naslov `127.0.0.1` ali `::1`), razen Äe je v uporabi posrednik (tj. na podlagi glave HTTP).
- Produkcijski naÄin: Aktivno povsod drugje.

ÄŒe Å¾elite omogoÄiti razvojni naÄin v drugih primerih, na primer za programerje, ki dostopajo z doloÄenega naslova IP, lahko uporabite `setDebugMode()`:

```php
$this->configurator->setDebugMode('23.75.345.200'); // enega ali veÄ naslovov IP.
```

Vsekakor priporoÄamo kombinacijo naslova IP s piÅ¡kotkom. V piÅ¡kotek `nette-debug` bomo shranili tajni Å¾eton, npr. `secret1234`, razvojni naÄin pa bo aktiviran za programerje s to kombinacijo IP in piÅ¡kotka.

```php
$this->configurator->setDebugMode('secret1234@23.75.345.200');
```

Razvojni naÄin lahko tudi popolnoma izklopimo, tudi za lokalni gostitelj:

```php
$this->configurator->setDebugMode(false);
```

Vrednost `true` vklopi naÄin za razvijalce, kar se na produkcijskem streÅ¾niku ne bi smelo zgoditi.


Orodje za razhroÅ¡Äevanje Tracy .[#toc-debugging-tool-tracy]
===========================================================

Za laÅ¾je razhroÅ¡Äevanje bomo vklopili odliÄno orodje [Tracy |tracy:]. V naÄinu za razvijalce vizualizira napake, v produkcijskem naÄinu pa napake beleÅ¾i v doloÄen imenik:

```php
$this->configurator->enableTracy($this->rootDir . '/log');
```


ZaÄasne datoteke .[#toc-temporary-files]
========================================

Nette uporablja predpomnilnik za vsebnik DI, RobotLoader, predloge itd. Zato je treba nastaviti pot do imenika, v katerem bo shranjen predpomnilnik:

```php
$this->configurator->setTempDirectory($this->rootDir . '/temp');
```

V operacijskem sistemu Linux ali macOS nastavite [dovoljenja za pisanje za |nette:troubleshooting#Setting directory permissions] imenike `log/` in `temp/`.


RobotLoader .[#toc-robotloader]
===============================

ObiÄajno bomo Å¾eleli samodejno naloÅ¾iti razrede z [RobotLoaderjem |robot-loader:], zato ga moramo zagnati in mu omogoÄiti, da naloÅ¾i razrede iz imenika, kjer se nahaja `Bootstrap.php` (tj. `__DIR__`), in vseh njegovih podimenikov:

```php
$this->configurator->createRobotLoader()
	->addDirectory(__DIR__)
	->register();
```

Druga moÅ¾nost je, da uporabimo samo samodejno nalaganje [Composer |best-practices:composer] PSR-4.


ÄŒasovni pas .[#toc-timezone]
============================

Configurator vam omogoÄa, da doloÄite Äasovni pas za svojo aplikacijo.

```php
$this->configurator->setTimeZone('Europe/Prague');
```


Konfiguracija zabojnika DI .[#toc-di-container-configuration]
=============================================================

Del zagonskega postopka je ustvarjanje vsebnika DI, tj. tovarne za predmete, ki je srce celotne aplikacije. To je pravzaprav razred PHP, ki ga ustvari Nette in je shranjen v imeniku predpomnilnika. Tovarna izdeluje kljuÄne objekte aplikacije, konfiguracijske datoteke pa ji dajejo navodila, kako naj jih ustvari in konfigurira, s Äimer vplivamo na obnaÅ¡anje celotne aplikacije.

Konfiguracijske datoteke so obiÄajno zapisane v [formatu NEON |neon:format]. [Kaj vse je mogoÄe konfigurirati |nette:configuring], si lahko preberete [tukaj |nette:configuring].

.[tip]
V razvojnem naÄinu se vsebnik samodejno posodobi vsakiÄ, ko spremenite kodo ali konfiguracijske datoteke. V produkcijskem naÄinu se ustvari samo enkrat, spremembe datotek pa se ne preverjajo, da bi poveÄali zmogljivost.

Konfiguracijske datoteke se naloÅ¾ijo z uporabo `addConfig()`:

```php
$this->configurator->addConfig($this->rootDir . '/config/common.neon');
```

Metodo `addConfig()` lahko za dodajanje veÄ datotek pokliÄete veÄkrat.

```php
$configDir = $this->rootDir . '/config';
$this->configurator->addConfig($configDir . '/common.neon');
$this->configurator->addConfig($configDir . '/services.neon');
if (PHP_SAPI === 'cli') {
	$this->configurator->addConfig($configDir . '/cli.php');
}
```

Ime `cli.php` ni tiskarska napaka, konfiguracijo lahko zapiÅ¡ete tudi v datoteko PHP, ki jo vrne kot polje.

Druga moÅ¾nost je, da z [razdelkom`includes`  |dependency-injection:configuration#including files] naloÅ¾imo veÄ konfiguracijskih datotek.

ÄŒe se v konfiguracijskih datotekah pojavijo elementi z enakimi kljuÄi, se bodo [prepisali ali zdruÅ¾ili |dependency-injection:configuration#Merging] v primeru polj. Kasneje vkljuÄena datoteka ima viÅ¡jo prioriteto kot prejÅ¡nja. Datoteka, v kateri je naveden razdelek `includes`, ima viÅ¡jo prednost kot datoteke, ki so vanjo vkljuÄene.


StatiÄni parametri .[#toc-static-parameters]
--------------------------------------------

Parametre, ki se uporabljajo v konfiguracijskih datotekah, je mogoÄe opredeliti [v razdelku `parameters` |dependency-injection:configuration#parameters] in jih tudi posredovati (ali prepisati) z metodo `addStaticParameters()` (ima vzdevek `addParameters()`). Pomembno je, da razliÄne vrednosti parametrov povzroÄijo generiranje dodatnih vsebnikov DI, tj. dodatnih razredov.

```php
$this->configurator->addStaticParameters([
	'projectId' => 23,
]);
```

V konfiguracijskih datotekah lahko zapiÅ¡emo obiÄajni zapis `%projectId%` za dostop do parametra z imenom `projectId`.


DinamiÄni parametri .[#toc-dynamic-parameters]
----------------------------------------------

Kontejnerju lahko dodamo tudi dinamiÄne parametre, katerih razliÄne vrednosti za razliko od statiÄnih parametrov ne bodo povzroÄile generiranja novih DI kontejnerjev.

```php
$this->configurator->addDynamicParameters([
	'remoteIp' => $_SERVER['REMOTE_ADDR'],
]);
```

Spremenljivke okolja bi lahko preprosto dali na voljo z dinamiÄnimi parametri. Do njih lahko dostopamo prek spletne strani `%env.variable%` v konfiguracijskih datotekah.

```php
$this->configurator->addDynamicParameters([
	'env' => getenv(),
]);
```


Privzete parametre .[#toc-default-parameters]
---------------------------------------------

V konfiguracijskih datotekah lahko uporabite naslednje statiÄne parametre:

- `%appDir%` je absolutna pot do imenika datoteke `Bootstrap.php`.
- `%wwwDir%` je absolutna pot do imenika, ki vsebuje vstopno datoteko `index.php`
- `%tempDir%` je absolutna pot do imenika za zaÄasne datoteke
- `%vendorDir%` je absolutna pot do imenika, v katerega Composer namesti knjiÅ¾nice
- `%rootDir%` je absolutna pot do korenskega imenika projekta
- `%debugMode%` oznaÄuje, ali je aplikacija v naÄinu odpravljanja napak
- `%consoleMode%` oznaÄuje, ali je bila zahteva poslana prek ukazne vrstice


UvoÅ¾ene storitve .[#toc-imported-services]
------------------------------------------

Zdaj se bomo poglobili. ÄŒeprav je namen vsebnika DI ustvarjanje objektov, se lahko izjemoma pojavi potreba po vstavitvi obstojeÄega objekta v vsebnik. To storimo tako, da definiramo storitev z atributom `imported: true`.

```neon
services:
	myservice:
		type: App\Model\MyCustomService
		imported: true
```

Ustvarite nov primerek in ga vstavite v bootstrap:

```php
$this->configurator->addServices([
	'myservice' => new App\Model\MyCustomService('foobar'),
]);
```


RazliÄna okolja .[#toc-different-environments]
==============================================

Ne oklevajte, Äe Å¾elite razred `Bootstrap` prilagoditi svojim potrebam. Metodi `bootWebApplication()` lahko dodate parametre za razlikovanje med spletnimi projekti. Lahko pa dodate tudi druge metode, na primer `bootTestEnvironment()` za inicializacijo okolja za teste enote, `bootConsoleApplication()` za skripte, ki se kliÄejo iz ukazne vrstice, in tako naprej.

```php
public function bootTestEnvironment(): Nette\DI\Container
{
	Tester\Environment::setup(); // Inicializacija Nette Testerja
	$this->setupContainer();
	return $this->configurator->createContainer();
}

public function bootConsoleApplication(): Nette\DI\Container
{
	$this->configurator->setDebugMode(false);
	$this->initializeEnvironment();
	$this->setupContainer();
	return $this->configurator->createContainer();
}
```
