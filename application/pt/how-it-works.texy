Como funcionam as aplicaÃ§Ãµes?
*****************************

<div class=perex>

VocÃª estÃ¡ lendo o documento fundamental da documentaÃ§Ã£o do Nette. AprenderÃ¡ todo o princÃ­pio de funcionamento das aplicaÃ§Ãµes web. Bem do A ao Z, desde o momento do nascimento atÃ© o Ãºltimo suspiro do script PHP. ApÃ³s a leitura, vocÃª saberÃ¡:

- como tudo funciona
- o que Ã© Bootstrap, Presenter e contÃªiner DI
- como Ã© a estrutura de diretÃ³rios

</div>


Estrutura de diretÃ³rios
=======================

Abra o exemplo do esqueleto de aplicaÃ§Ã£o web chamado [WebProject|https://github.com/nette/web-project] e, enquanto lÃª, vocÃª pode olhar para os arquivos sobre os quais estamos falando.

A estrutura de diretÃ³rios se parece com algo assim:

/--pre
<b>web-project/</b>
â”œâ”€â”€ <b>app/</b>                      â† diretÃ³rio com a aplicaÃ§Ã£o
â”‚   â”œâ”€â”€ <b>Core/</b>                 â† classes bÃ¡sicas necessÃ¡rias para o funcionamento
â”‚   â”‚   â””â”€â”€ <b>RouterFactory.php</b> â† configuraÃ§Ã£o de endereÃ§os URL
â”‚   â”œâ”€â”€ <b>Presentation/</b>         â† presenters, templates & cia.
â”‚   â”‚   â”œâ”€â”€ <b>@layout.latte</b>     â† template de layout
â”‚   â”‚   â””â”€â”€ <b>Home/</b>             â† diretÃ³rio do presenter Home
â”‚   â”‚       â”œâ”€â”€ <b>HomePresenter.php</b> â† classe do presenter Home
â”‚   â”‚       â””â”€â”€ <b>default.latte</b> â† template da aÃ§Ã£o default
â”‚   â””â”€â”€ <b>Bootstrap.php</b>         â† classe de inicializaÃ§Ã£o Bootstrap
â”œâ”€â”€ <b>bin/</b>                      â† scripts executados a partir da linha de comando
â”œâ”€â”€ <b>config/</b>                   â† arquivos de configuraÃ§Ã£o
â”‚   â”œâ”€â”€ <b>common.neon</b>
â”‚   â””â”€â”€ <b>services.neon</b>
â”œâ”€â”€ <b>log/</b>                      â† erros registrados
â”œâ”€â”€ <b>temp/</b>                     â† arquivos temporÃ¡rios, cache, â€¦
â”œâ”€â”€ <b>vendor/</b>                   â† bibliotecas instaladas pelo Composer
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ <b>autoload.php</b>          â† autoloading de todos os pacotes instalados
â”œâ”€â”€ <b>www/</b>                      â† diretÃ³rio pÃºblico ou document-root do projeto
â”‚   â”œâ”€â”€ <b>.htaccess</b>             â† regras mod_rewrite
â”‚   â””â”€â”€ <b>index.php</b>             â† arquivo inicial pelo qual a aplicaÃ§Ã£o Ã© iniciada
â””â”€â”€ <b>.htaccess</b>                 â† proÃ­be o acesso a todos os diretÃ³rios exceto www
\--

VocÃª pode alterar a estrutura de diretÃ³rios de qualquer forma, renomear ou mover pastas, Ã© totalmente flexÃ­vel. AlÃ©m disso, o Nette possui uma autodeteÃ§Ã£o inteligente e reconhece automaticamente a localizaÃ§Ã£o da aplicaÃ§Ã£o, incluindo sua base de URL.

Para aplicaÃ§Ãµes um pouco maiores, podemos [dividir as pastas com presenters e templates em subdiretÃ³rios |directory-structure#Presentery a Å¡ablony] e as classes em namespaces, que chamamos de mÃ³dulos.

O diretÃ³rio `www/` representa o chamado diretÃ³rio pÃºblico ou document-root do projeto. VocÃª pode renomeÃ¡-lo sem a necessidade de configurar mais nada no lado da aplicaÃ§Ã£o. Apenas Ã© necessÃ¡rio [configurar a hospedagem |nette:troubleshooting#Jak zmÄ›nit Äi ostranit z URL adresÃ¡Å™ www] para que o document-root aponte para este diretÃ³rio.

VocÃª tambÃ©m pode baixar o WebProject diretamente, incluindo o Nette, usando o [Composer |best-practices:composer]:

```shell
composer create-project nette/web-project
```

No Linux ou macOS, defina as [permissÃµes de escrita |nette:troubleshooting#NastavenÃ­ prÃ¡v adresÃ¡Å™Å¯] para as pastas `log/` e `temp/`.

A aplicaÃ§Ã£o WebProject estÃ¡ pronta para ser executada, nÃ£o Ã© necessÃ¡rio configurar absolutamente nada e vocÃª pode exibi-la imediatamente no navegador acessando a pasta `www/`.


RequisiÃ§Ã£o HTTP
===============

Tudo comeÃ§a no momento em que o usuÃ¡rio abre a pÃ¡gina no navegador. Ou seja, quando o navegador bate na porta do servidor com uma requisiÃ§Ã£o HTTP. A requisiÃ§Ã£o Ã© direcionada para um Ãºnico arquivo PHP, localizado no diretÃ³rio pÃºblico `www/`, que Ã© `index.php`. Digamos que seja uma requisiÃ§Ã£o para o endereÃ§o `https://example.com/product/123`. GraÃ§as Ã  [configuraÃ§Ã£o adequada do servidor|nette:troubleshooting#Jak nastavit server pro hezkÃ¡ URL?], atÃ© mesmo esta URL Ã© mapeada para o arquivo `index.php` e ele Ã© executado.

Sua tarefa Ã©:

1) inicializar o ambiente
2) obter a fÃ¡brica
3) iniciar a aplicaÃ§Ã£o Nette, que tratarÃ¡ da requisiÃ§Ã£o

Que fÃ¡brica? NÃ£o estamos fabricando tratores, mas sim pÃ¡ginas web! Aguarde, isso serÃ¡ explicado em breve.

Com as palavras "inicializaÃ§Ã£o do ambiente", queremos dizer, por exemplo, que o [Tracy|tracy:] Ã© ativado, que Ã© uma ferramenta incrÃ­vel para registrar ou visualizar erros. No servidor de produÃ§Ã£o, ele registra os erros, no de desenvolvimento, ele os exibe diretamente. Portanto, a inicializaÃ§Ã£o tambÃ©m inclui a decisÃ£o sobre se a web estÃ¡ sendo executada no modo de produÃ§Ã£o ou de desenvolvimento. Para isso, o Nette usa uma [autodeteÃ§Ã£o inteligente|bootstrap#vyvojarsky-vs-produkcni-rezim]: se vocÃª executar a web em localhost, ela serÃ¡ executada no modo de desenvolvimento. Assim, vocÃª nÃ£o precisa configurar nada e a aplicaÃ§Ã£o estÃ¡ imediatamente pronta tanto para o desenvolvimento quanto para a implantaÃ§Ã£o em produÃ§Ã£o. Esses passos sÃ£o realizados e detalhadamente descritos no capÃ­tulo sobre a [classe Bootstrap|bootstrap].

O terceiro ponto (sim, pulamos o segundo, mas voltaremos a ele) Ã© iniciar a aplicaÃ§Ã£o. O tratamento de requisiÃ§Ãµes HTTP no Nette Ã© responsabilidade da classe `Nette\Application\Application` (doravante `Application`), entÃ£o quando dizemos iniciar a aplicaÃ§Ã£o, queremos dizer especificamente chamar o mÃ©todo com o nome apropriado `run()` no objeto desta classe.

O Nette Ã© um mentor que o guia para escrever aplicaÃ§Ãµes limpas de acordo com metodologias comprovadas. E uma das mais comprovadas Ã© chamada de **injeÃ§Ã£o de dependÃªncia**, abreviada como DI. Neste momento, nÃ£o queremos sobrecarregÃ¡-lo com a explicaÃ§Ã£o da DI, para isso existe um [capÃ­tulo separado|dependency-injection:introduction], o resultado essencial Ã© que os objetos chave geralmente serÃ£o criados para nÃ³s por uma fÃ¡brica de objetos, chamada de **contÃªiner DI** (abreviado como DIC). Sim, essa Ã© a fÃ¡brica da qual falamos hÃ¡ pouco. E ela tambÃ©m nos fabricarÃ¡ o objeto `Application`, por isso precisamos primeiro do contÃªiner. Obtemo-lo usando a classe `Configurator` e deixamos que ele fabrique o objeto `Application`, chamamos o mÃ©todo `run()` nele e assim a aplicaÃ§Ã£o Nette Ã© iniciada. Ã‰ exatamente isso que acontece no arquivo [index.php|bootstrap#index.php].


Nette Application
=================

A classe Application tem uma Ãºnica tarefa: responder a uma requisiÃ§Ã£o HTTP.

AplicaÃ§Ãµes escritas em Nette sÃ£o divididas em muitos chamados presenters (em outros frameworks, vocÃª pode encontrar o termo controller, Ã© a mesma coisa), que sÃ£o classes, cada uma representando uma pÃ¡gina especÃ­fica do site: por exemplo, a pÃ¡gina inicial; um produto em uma loja virtual; um formulÃ¡rio de login; um feed de sitemap, etc. Uma aplicaÃ§Ã£o pode ter de um a milhares de presenters.

A Application comeÃ§a pedindo ao chamado router para decidir a qual dos presenters a requisiÃ§Ã£o atual deve ser passada para tratamento. O router decide de quem Ã© a responsabilidade. Ele olha para a URL de entrada `https://example.com/product/123` e, com base em como estÃ¡ configurado, decide que este Ã© o trabalho, por exemplo, do **presenter** `Product`, do qual ele desejarÃ¡ como **aÃ§Ã£o** a exibiÃ§Ã£o (`show`) do produto com `id: 123`. Ã‰ um bom costume escrever o par presenter + aÃ§Ã£o separados por dois pontos como `Product:show`.

Portanto, o router transformou a URL no par `Presenter:action` + parÃ¢metros, no nosso caso `Product:show` + `id: 123`. Como tal router se parece, vocÃª pode ver no arquivo `app/Core/RouterFactory.php` e o descrevemos detalhadamente no capÃ­tulo [Roteamento].

Vamos continuar. A Application jÃ¡ conhece o nome do presenter e pode prosseguir. Criando o objeto da classe `ProductPresenter`, que Ã© o cÃ³digo do presenter `Product`. Mais precisamente, ele pede ao contÃªiner DI para fabricar o presenter, porque fabricar Ã© a funÃ§Ã£o dele.

O presenter pode parecer assim:

```php
class ProductPresenter extends Nette\Application\UI\Presenter
{
	public function __construct(
		private ProductRepository $repository,
	) {
	}

	public function renderShow(int $id): void
	{
		// obtemos dados do model e passamos para o template
		$this->template->product = $this->repository->getProduct($id);
	}
}
```

O tratamento da requisiÃ§Ã£o Ã© assumido pelo presenter. E a tarefa Ã© clara: execute a aÃ§Ã£o `show` com `id: 123`. O que, na linguagem dos presenters, significa que o mÃ©todo `renderShow()` Ã© chamado e recebe `123` no parÃ¢metro `$id`.

Um presenter pode atender a vÃ¡rias aÃ§Ãµes, ou seja, ter vÃ¡rios mÃ©todos `render<Action>()`. Mas recomendamos projetar presenters com uma ou o mÃ­nimo possÃ­vel de aÃ§Ãµes.

EntÃ£o, o mÃ©todo `renderShow(123)` foi chamado, cujo cÃ³digo Ã© um exemplo fictÃ­cio, mas vocÃª pode ver nele como os dados sÃ£o passados para o template, ou seja, escrevendo em `$this->template`.

Posteriormente, o presenter retorna uma resposta. Esta pode ser uma pÃ¡gina HTML, uma imagem, um documento XML, o envio de um arquivo do disco, JSON ou talvez um redirecionamento para outra pÃ¡gina. O importante Ã© que, se nÃ£o dissermos explicitamente como ele deve responder (o que Ã© o caso de `ProductPresenter`), a resposta serÃ¡ a renderizaÃ§Ã£o de um template com uma pÃ¡gina HTML. Por quÃª? Porque em 99% dos casos queremos renderizar um template, entÃ£o o presenter considera esse comportamento como padrÃ£o e quer facilitar nosso trabalho. Esse Ã© o propÃ³sito do Nette.

Nem precisamos indicar qual template renderizar, ele deduzirÃ¡ o caminho por si sÃ³. No caso da aÃ§Ã£o `show`, ele simplesmente tentarÃ¡ carregar o template `show.latte` no diretÃ³rio com a classe `ProductPresenter`. Ele tambÃ©m tentarÃ¡ localizar o layout no arquivo `@layout.latte` (mais detalhes sobre [localizaÃ§Ã£o de templates|templates#hledani-sablon]).

E entÃ£o ele renderiza os templates. Com isso, a tarefa do presenter e de toda a aplicaÃ§Ã£o estÃ¡ concluÃ­da e o trabalho estÃ¡ finalizado. Se o template nÃ£o existisse, seria retornada uma pÃ¡gina com erro 404. VocÃª pode ler mais sobre presenters na pÃ¡gina [Presenters|presenters].

[* request-flow.svg *]

Para ter certeza, vamos tentar recapitular todo o processo com uma URL ligeiramente diferente:

1) A URL serÃ¡ `https://example.com`
2) Inicializamos a aplicaÃ§Ã£o, o contÃªiner Ã© criado e `Application::run()` Ã© iniciado
3) O router decodifica a URL como o par `Home:default`
4) O objeto da classe `HomePresenter` Ã© criado
5) O mÃ©todo `renderDefault()` Ã© chamado (se existir)
6) O template, por exemplo, `default.latte` com o layout, por exemplo, `@layout.latte` Ã© renderizado


Talvez vocÃª tenha encontrado muitos termos novos agora, mas acreditamos que eles fazem sentido. Criar aplicaÃ§Ãµes no Nette Ã© uma brisa tremenda.


Templates
=========

JÃ¡ que falamos de templates, no Nette usa-se o sistema de templates [Latte |latte:]. Ã‰ por isso que as extensÃµes `.latte` nos templates. O Latte Ã© usado, por um lado, porque Ã© o sistema de templates mais seguro para PHP e, ao mesmo tempo, o sistema mais intuitivo. VocÃª nÃ£o precisa aprender muito de novo, basta o conhecimento de PHP e algumas tags. VocÃª aprenderÃ¡ tudo na [documentaÃ§Ã£o |templates].

No template, [links sÃ£o criados |creating-links] para outros presenters & aÃ§Ãµes assim:

```latte
<a n:href="Product:show $productId">detalhe do produto</a>
```

Simplesmente, em vez da URL real, vocÃª escreve o par conhecido `Presenter:action` e especifica quaisquer parÃ¢metros. O truque estÃ¡ no `n:href`, que diz que este atributo serÃ¡ processado pelo Nette. E ele gera:

```latte
<a href="/product/456">detalhe do produto</a>
```

A geraÃ§Ã£o de URLs Ã© responsabilidade do jÃ¡ mencionado router. De fato, os routers no Nette sÃ£o excepcionais porque podem realizar nÃ£o apenas transformaÃ§Ãµes de URL para o par presenter:action, mas tambÃ©m o inverso, ou seja, gerar uma URL a partir do nome do presenter + aÃ§Ã£o + parÃ¢metros.
GraÃ§as a isso, no Nette, vocÃª pode alterar completamente as formas das URLs em toda a aplicaÃ§Ã£o finalizada, sem alterar um Ãºnico caractere no template ou presenter. Apenas modificando o router.
TambÃ©m graÃ§as a isso funciona a chamada canonizaÃ§Ã£o, que Ã© outra caracterÃ­stica Ãºnica do Nette, que contribui para um melhor SEO (otimizaÃ§Ã£o para motores de busca) ao impedir automaticamente a existÃªncia de conteÃºdo duplicado em URLs diferentes.
Muitos programadores consideram isso surpreendente.


Componentes interativos
=======================

Sobre os presenters, precisamos contar mais uma coisa: eles tÃªm um sistema de componentes embutido. Algo semelhante pode ser familiar aos veteranos do Delphi ou ASP.NET Web Forms, algo remotamente parecido Ã© a base do React ou Vue.js. No mundo dos frameworks PHP, Ã© uma caracterÃ­stica absolutamente Ãºnica.

Componentes sÃ£o unidades reutilizÃ¡veis independentes que inserimos nas pÃ¡ginas (ou seja, presenters). Podem ser [formulÃ¡rios |forms:in-presenter], [datagrids |https://componette.org/contributte/datagrid/], menus, enquetes de votaÃ§Ã£o, na verdade, qualquer coisa que faÃ§a sentido usar repetidamente. Podemos criar nossos prÃ³prios componentes ou usar alguns da [enorme oferta |https://componette.org] de componentes open source.

Os componentes influenciam fundamentalmente a abordagem para a criaÃ§Ã£o de aplicaÃ§Ãµes. Eles abrirÃ£o novas possibilidades para vocÃª compor pÃ¡ginas a partir de unidades prÃ©-preparadas. E, alÃ©m disso, eles tÃªm algo em comum com [Hollywood|components#Hollywood style].


ContÃªiner DI e configuraÃ§Ã£o
===========================

O contÃªiner DI, ou fÃ¡brica de objetos, Ã© o coraÃ§Ã£o de toda a aplicaÃ§Ã£o.

NÃ£o se preocupe, nÃ£o Ã© nenhuma caixa preta mÃ¡gica, como poderia parecer das linhas anteriores. Na verdade, Ã© uma classe PHP bastante chata, que o Nette gera e salva no diretÃ³rio de cache. Ela tem muitos mÃ©todos nomeados como `createServiceAbcd()` e cada um deles sabe como fabricar e retornar algum objeto. Sim, tambÃ©m existe o mÃ©todo `createServiceApplication()`, que fabrica `Nette\Application\Application`, que precisÃ¡vamos no arquivo `index.php` para iniciar a aplicaÃ§Ã£o. E existem mÃ©todos que fabricam os presenters individuais. E assim por diante.

Objetos que o contÃªiner DI cria sÃ£o, por algum motivo, chamados de serviÃ§os.

O que Ã© realmente especial sobre esta classe Ã© que vocÃª nÃ£o a programa, mas sim o framework. Ele realmente gera o cÃ³digo PHP e o salva no disco. VocÃª apenas dÃ¡ instruÃ§Ãµes sobre quais objetos o contÃªiner deve saber fabricar e como exatamente. E essas instruÃ§Ãµes sÃ£o escritas nos [arquivos de configuraÃ§Ã£o|bootstrap#konfigurace-di-kontejneru], para os quais se usa o formato [NEON|neon:format] e, portanto, tambÃ©m tÃªm a extensÃ£o `.neon`.

Os arquivos de configuraÃ§Ã£o servem puramente para instruir o contÃªiner DI. EntÃ£o, por exemplo, se eu especificar na seÃ§Ã£o [session|http:configuration#Session] a opÃ§Ã£o `expiration: 14 days`, o contÃªiner DI, ao criar o objeto `Nette\Http\Session` representando a sessÃ£o, chamarÃ¡ seu mÃ©todo `setExpiration('14 days')` e assim a configuraÃ§Ã£o se tornarÃ¡ realidade.

HÃ¡ um capÃ­tulo inteiro preparado para vocÃª descrevendo tudo o que pode ser [configurado |nette:configuring] e como [definir seus prÃ³prios serviÃ§os |dependency-injection:services].

Assim que vocÃª se aprofundar um pouco na criaÃ§Ã£o de serviÃ§os, encontrarÃ¡ a palavra [autowiring |dependency-injection:autowiring]. Esta Ã© uma funcionalidade que simplificarÃ¡ sua vida de maneira incrÃ­vel. Ela pode passar automaticamente objetos para onde vocÃª precisa deles (por exemplo, nos construtores de suas classes), sem que vocÃª precise fazer nada. VocÃª descobrirÃ¡ que o contÃªiner DI no Nette Ã© um pequeno milagre.


Para onde ir agora?
===================

Percorremos os princÃ­pios bÃ¡sicos das aplicaÃ§Ãµes no Nette. AtÃ© agora, muito superficialmente, mas em breve vocÃª se aprofundarÃ¡ e, com o tempo, criarÃ¡ aplicaÃ§Ãµes web maravilhosas. Para onde continuar agora? VocÃª jÃ¡ experimentou o tutorial [Escrevendo a primeira aplicaÃ§Ã£o|quickstart:]?

AlÃ©m do que foi descrito acima, o Nette possui todo um arsenal de [classes Ãºteis|utils:], uma [camada de banco de dados|database:], etc. Tente apenas clicar pela documentaÃ§Ã£o. Ou pelo [blog|https://blog.nette.org]. VocÃª descobrirÃ¡ muitas coisas interessantes.

Que o framework lhe traga muita alegria ğŸ’™
