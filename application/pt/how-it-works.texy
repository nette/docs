Como funcionam as aplicaÃ§Ãµes?
*****************************
<div class=perex>


Atualmente vocÃª estÃ¡ lendo o documento bÃ¡sico da documentaÃ§Ã£o Nette. VocÃª aprenderÃ¡ todo o princÃ­pio das aplicaÃ§Ãµes web. Nice de A a Z, desde o momento do nascimento atÃ© o Ãºltimo suspiro do script PHP. ApÃ³s a leitura, vocÃª saberÃ¡:

- como tudo isso funciona
- o que Ã© Bootstrap, Apresentador e Recipiente DI
- como Ã© a estrutura do diretÃ³rio

</div>


Estrutura do diretÃ³rio .[#toc-directory-structure]
==================================================

Abra um exemplo de esqueleto de uma aplicaÃ§Ã£o web chamada [WebProject |https://github.com/nette/web-project] e vocÃª pode assistir aos arquivos que estÃ£o sendo escritos.

A estrutura do diretÃ³rio Ã© algo parecido com isto:

/--pre
<b>web-project/</b>
â”œâ”€â”€ <b>app/</b>                      â† directory with application
â”‚   â”œâ”€â”€ <b>Presenters/</b>           â† presenter classes
â”‚   â”‚   â”œâ”€â”€ <b>HomepagePresenter.php</b>  â† Homepage presenter class
â”‚   â”‚   â””â”€â”€ <b>templates/</b>        â† templates directory
â”‚   â”‚       â”œâ”€â”€ <b>@layout.latte</b> â† template of shared layout
â”‚   â”‚       â””â”€â”€ <b>Homepage/</b>     â† templates for Homepage presenter
â”‚   â”‚           â””â”€â”€ <b>default.latte</b>  â† template for action `default`
â”‚   â”œâ”€â”€ <b>Router/</b>               â† configuration of URL addresses
â”‚   â””â”€â”€ <b>Bootstrap.php</b>         â† booting class Bootstrap
â”œâ”€â”€ <b>bin/</b>                      â† scripts for the command line
â”œâ”€â”€ <b>config/</b>                   â† configuration files
â”‚   â”œâ”€â”€ <b>common.neon</b>
â”‚   â””â”€â”€ <b>local.neon</b>
â”œâ”€â”€ <b>log/</b>                      â† error logs
â”œâ”€â”€ <b>temp/</b>                     â† temporary files, cache, â€¦
â”œâ”€â”€ <b>vendor/</b>                   â† libraries installed by Composer
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ <b>autoload.php</b>          â† autoloading of libs installed by Composer
â”œâ”€â”€ <b>www/</b>                      â† public directory, document root of project
â”‚   â”œâ”€â”€ <b>.htaccess</b>             â† mod_rewrite rules etc
â”‚   â””â”€â”€ <b>index.php</b>             â† initial file that launches the application
â””â”€â”€ <b>.htaccess</b>                 â† prohibits access to all directories except www
\--

VocÃª pode mudar a estrutura do diretÃ³rio de qualquer forma, renomear ou mover pastas e depois basta editar os caminhos para `log/` e `temp/` no arquivo `Bootstrap.php` e o caminho para este arquivo em `composer.json` na seÃ§Ã£o `autoload`. Nada mais, nenhuma reconfiguraÃ§Ã£o complicada, nenhuma mudanÃ§a constante. A Nette tem uma [autodetecÃ§Ã£o inteligente |bootstrap#development-vs-production-mode].

Para aplicaÃ§Ãµes um pouco maiores, podemos dividir pastas com apresentadores e modelos em subdiretÃ³rios (em disco) e em namespaces (em cÃ³digo), que chamamos de [mÃ³dulos |modules].

O diretÃ³rio `www/` Ã© o diretÃ³rio pÃºblico ou a base de documentos do projeto. VocÃª pode renomeÃ¡-lo sem ter que definir nada mais no lado da aplicaÃ§Ã£o. Basta [configurar a hospedagem |nette:troubleshooting#How to change or remove www directory from URL] para que a raÃ­z do documento vÃ¡ para este diretÃ³rio.

VocÃª tambÃ©m pode baixar o WebProject diretamente, incluindo a Nette, usando o [Composer |best-practices:composer]:

```shell
composer create-project nette/web-project
```

No Linux ou macOS, defina as [permissÃµes de escrita |nette:troubleshooting#Setting directory permissions] para os diretÃ³rios `log/` e `temp/`.

O aplicativo WebProject estÃ¡ pronto para rodar, nÃ£o hÃ¡ necessidade de configurar mais nada e vocÃª pode vÃª-lo diretamente no navegador acessando a pasta `www/`.


SolicitaÃ§Ã£o HTTP .[#toc-http-request]
=====================================

Tudo comeÃ§a quando um usuÃ¡rio abre a pÃ¡gina em um navegador e o navegador bate no servidor com uma solicitaÃ§Ã£o HTTP. A requisiÃ§Ã£o vai para um arquivo PHP localizado no diretÃ³rio pÃºblico `www/`, que Ã© `index.php`. Vamos supor que esta seja uma solicitaÃ§Ã£o para `https://example.com/product/123` e serÃ¡ executada.

Sua tarefa Ã©:

1) inicializar o meio ambiente
2) obter a fÃ¡brica
3) lanÃ§ar a aplicaÃ§Ã£o Nette que trata do pedido

Que tipo de fÃ¡brica? NÃ³s nÃ£o produzimos tratores, mas websites! Espere, isso serÃ¡ explicado imediatamente.

Por "inicializar o ambiente" queremos dizer, por exemplo, que [Tracy |tracy:] Ã© ativado, o que Ã© uma ferramenta incrÃ­vel para registrar ou visualizar erros. Ele registra os erros no servidor de produÃ§Ã£o e os exibe diretamente no servidor de desenvolvimento. Portanto, a inicializaÃ§Ã£o tambÃ©m precisa decidir se o site estÃ¡ rodando em modo de produÃ§Ã£o ou de desenvolvimento. Para isso, a Nette usa autodetecÃ§Ã£o: se vocÃª executar o site no localhost, ele roda em modo desenvolvedor. VocÃª nÃ£o precisa configurar nada e o aplicativo estÃ¡ pronto tanto para o desenvolvimento quanto para a implantaÃ§Ã£o em produÃ§Ã£o. Estas etapas sÃ£o executadas e descritas em detalhes no capÃ­tulo sobre a [classe Bootstrap |bootstrap].

O terceiro ponto (sim, pulamos o segundo, mas voltaremos a ele) Ã© iniciar a aplicaÃ§Ã£o. O tratamento dos pedidos HTTP em Nette Ã© feito pela classe `Nette\Application\Application` (doravante denominada `Application`), portanto, quando dizemos "executar uma aplicaÃ§Ã£o", queremos chamar um mÃ©todo com o nome `run()` sobre um objeto desta classe.

Nette Ã© um mentor que orienta vocÃª a escrever aplicaÃ§Ãµes limpas atravÃ©s de metodologias comprovadas. E a mais comprovada Ã© chamada de **injeÃ§Ã£o de dependÃªncia***, abreviada DI. No momento nÃ£o queremos sobrecarregÃ¡-lo com a explicaÃ§Ã£o de DI, jÃ¡ que existe um [capÃ­tulo separado |dependency-injection:introduction], o importante aqui Ã© que os objetos chave serÃ£o normalmente criados por uma fÃ¡brica para objetos chamados **container de DI** (abreviado DIC). Sim, esta Ã© a fÃ¡brica que foi mencionada hÃ¡ um tempo atrÃ¡s. E tambÃ©m cria o objeto `Application` para nÃ³s, portanto precisamos primeiro de um container. NÃ³s o obtemos usando a classe `Configurator` e o deixamos produzir o objeto `Application`, chamamos o mÃ©todo `run()` e isto inicia a aplicaÃ§Ã£o Nette. Isto Ã© exatamente o que acontece no arquivo [index.php |bootstrap#index.php].


AplicaÃ§Ã£o Nette .[#toc-nette-application]
=========================================

A classe Application tem uma Ãºnica tarefa: responder a uma solicitaÃ§Ã£o HTTP.

As aplicaÃ§Ãµes escritas em Nette sÃ£o divididas em muitos dos chamados apresentadores (em outras estruturas vocÃª pode encontrar o termo controlador, que Ã© o mesmo), que sÃ£o classes que representam uma pÃ¡gina especÃ­fica do site: por exemplo, pÃ¡gina inicial; produto na loja virtual; formulÃ¡rio de login; feed do mapa do site, etc. A aplicaÃ§Ã£o pode ter de um a milhares de apresentadores.

A aplicaÃ§Ã£o comeÃ§a pedindo ao chamado roteador que decida qual dos apresentadores deve passar o atual pedido de processamento. O roteador decide de quem Ã© a responsabilidade. Ele analisa a URL de entrada `https://example.com/product/123`, que quer `show` um produto com `id: 123` como uma aÃ§Ã£o. Ã‰ um bom hÃ¡bito escrever um par de apresentador + aÃ§Ã£o separado por dois pontos como `Product:show`.

Assim, o roteador transformou a URL em um par `Presenter:action` + parÃ¢metros, em nosso caso `Product:show` + `id: 123`. VocÃª pode ver como Ã© um roteador no arquivo `app/Router/RouterFactory.php` e nÃ³s o descreveremos em detalhes no capÃ­tulo [Roteamento |Routing].

Vamos em frente. O pedido jÃ¡ conhece o nome do apresentador e pode continuar. Ao criar um objeto `ProductPresenter`, que Ã© o cÃ³digo do apresentador `Product`. Mais precisamente, pede ao contÃªiner DI para criar o apresentador, pois a produÃ§Ã£o de objetos Ã© sua funÃ§Ã£o.

O apresentador pode se parecer com isto:

```php
class ProductPresenter extends Nette\Application\UI\Presenter
{
	public function __construct(
		private ProductRepository $repository,
	) {
	}

	public function renderShow(int $id): void
	{
		// we obtain data from the model and pass it to the template
		$this->template->product = $this->repository->getProduct($id);
	}
}
```

O pedido Ã© tratado pelo apresentador. E a tarefa Ã© clara: fazer aÃ§Ã£o `show` com `id: 123`. O que na linguagem dos apresentadores significa que o mÃ©todo `renderShow()` Ã© chamado e no parÃ¢metro `$id` recebe `123`.

Um apresentador pode lidar com mÃºltiplas aÃ§Ãµes, ou seja, ter mÃºltiplos mÃ©todos `render<Action>()`. Mas recomendamos projetar apresentadores com uma ou o menor nÃºmero possÃ­vel de aÃ§Ãµes.

EntÃ£o, o mÃ©todo `renderShow(123)` foi chamado, cujo cÃ³digo Ã© um exemplo fictÃ­cio, mas vocÃª pode ver nele como os dados sÃ£o passados para o modelo, ou seja, escrevendo para `$this->template`.

Posteriormente, o apresentador retorna a resposta. Pode ser uma pÃ¡gina HTML, uma imagem, um documento XML, o envio de um arquivo do disco, JSON ou o redirecionamento para outra pÃ¡gina. Ã‰ importante ressaltar que se nÃ£o dissermos explicitamente como responder (que Ã© o caso de `ProductPresenter`), a resposta serÃ¡ renderizar o template com uma pÃ¡gina HTML. Por quÃª? Bem, porque em 99% dos casos queremos desenhar um template, entÃ£o o apresentador toma este comportamento como padrÃ£o e quer tornar nosso trabalho mais fÃ¡cil. Esse Ã© o ponto de vista da Nette.

NÃ£o temos nem mesmo que declarar qual modelo desenhar, ele deriva o caminho para ele de acordo com uma lÃ³gica simples. No caso do apresentador `Product` e da aÃ§Ã£o `show`, ele tenta ver se um destes arquivos de modelo existe em relaÃ§Ã£o ao diretÃ³rio onde se encontra a classe `ProductPresenter`:

- `templates/Product/show.latte`
- `templates/Product.show.latte`

Ele tambÃ©m tentarÃ¡ encontrar o layout no arquivo `@layout.latte` e depois renderiza o modelo. Agora a tarefa do apresentador e de todo o pedido estÃ¡ concluÃ­da. Se o modelo nÃ£o existir, uma pÃ¡gina com erro 404 serÃ¡ devolvida. VocÃª pode ler mais sobre os apresentadores na pÃ¡gina [Apresentadores |Presenters].

[* request-flow.svg *]

SÃ³ para ter certeza, vamos tentar recapitular todo o processo com uma URL ligeiramente diferente:

1) a URL serÃ¡ `https://example.com`
2) iniciamos a aplicaÃ§Ã£o, criamos um container e executamos `Application::run()`
3) o roteador decodifica a URL como um par `Homepage:default`
4) um objeto `HomepagePresenter` Ã© criado
5) mÃ©todo `renderDefault()` Ã© chamado (se existir)
6) um modelo `templates/Homepage/default.latte` com um layout `templates/@layout.latte` Ã© apresentado


VocÃª pode ter se deparado com muitos conceitos novos agora, mas acreditamos que eles fazem sentido. Criar aplicaÃ§Ãµes em Nette Ã© uma brisa.


Modelos .[#toc-templates]
=========================

Quando se trata dos modelos, a Nette utiliza o sistema de modelos [Latte |latte:]. Ã‰ por isso que os arquivos com os gabaritos terminam com `.latte`. O Latte Ã© usado porque Ã© o sistema de modelos mais seguro para PHP e, ao mesmo tempo, o sistema mais intuitivo. VocÃª nÃ£o precisa aprender muito de novo, vocÃª sÃ³ precisa conhecer PHP e algumas tags de Latte. VocÃª descobrirÃ¡ tudo [na documentaÃ§Ã£o |latte:].

No modelo, [criamos um link |creating-links] para outros apresentadores e aÃ§Ãµes da seguinte forma:

```latte
<a n:href="Product:show $productId">product detail</a>
```

Basta escrever o familiar par `Presenter:action` ao invÃ©s da URL real e incluir quaisquer parÃ¢metros. O truque Ã© `n:href`, que diz que este atributo serÃ¡ processado pela Nette. E ele serÃ¡ gerado:

```latte
<a href="/product/456">product detail</a>
```

O roteador mencionado anteriormente estÃ¡ encarregado de gerar a URL. De fato, os roteadores em Nette sÃ£o Ãºnicos na medida em que podem realizar nÃ£o apenas transformaÃ§Ãµes de uma URL para um par de apresentador:aÃ§Ã£o, mas tambÃ©m vice-versa gerar uma URL a partir do nome do apresentador + aÃ§Ã£o + parÃ¢metros.
GraÃ§as a isto, em Nette vocÃª pode alterar completamente a forma da URL em toda a aplicaÃ§Ã£o finalizada sem alterar um Ãºnico caractere no modelo ou apresentador apenas modificando o roteador.
E graÃ§as a isto, o chamado trabalho de canonizaÃ§Ã£o, que Ã© outra caracterÃ­stica Ãºnica da Nette, que melhora o SEO (otimizaÃ§Ã£o da capacidade de busca na internet), evitando automaticamente a existÃªncia de conteÃºdo duplicado em diferentes URLs.
Muitos programadores acham isso surpreendente.


Componentes interativos .[#toc-interactive-components]
======================================================

Temos mais uma coisa a lhe dizer sobre os apresentadores: eles tÃªm um sistema de componentes embutido. Os mais antigos de vocÃªs podem se lembrar de algo semelhante dos formulÃ¡rios Delphi ou ASP.NET Web Forms. O React ou Vue.js Ã© construÃ­do sobre algo remotamente semelhante. No mundo das estruturas PHP, esta Ã© uma caracterÃ­stica completamente Ãºnica.

Os componentes sÃ£o unidades reutilizÃ¡veis separadas que colocamos em pÃ¡ginas (ou seja, apresentadores). Eles podem ser [formas |forms:in-presenter], [datagrids |https://componette.org/contributte/datagrid/], menus, enquetes, na verdade, qualquer coisa que faÃ§a sentido usar repetidamente. Podemos criar nossos prÃ³prios componentes ou usar alguns dos [enormes |https://componette.org] componentes de cÃ³digo aberto.

Os componentes mudam fundamentalmente a abordagem para o desenvolvimento de aplicaÃ§Ãµes. Eles abrirÃ£o novas possibilidades de composiÃ§Ã£o de pÃ¡ginas a partir de unidades prÃ©-definidas. E eles tÃªm algo em comum com [Hollywood |components#Hollywood style].


DI Container e ConfiguraÃ§Ã£o .[#toc-di-container-and-configuration]
==================================================================

O recipiente DI (fÃ¡brica para objetos) Ã© o coraÃ§Ã£o de toda a aplicaÃ§Ã£o.

NÃ£o se preocupe, nÃ£o Ã© uma caixa preta mÃ¡gica, como pode parecer das palavras anteriores. Na verdade, Ã© uma classe PHP bastante enfadonha gerada pela Nette e armazenada em um diretÃ³rio cache. Ela tem muitos mÃ©todos nomeados como `createServiceAbcd()` e cada um deles cria e devolve um objeto. Sim, hÃ¡ tambÃ©m um mÃ©todo `createServiceApplication()` que produzirÃ¡ `Nette\Application\Application`, que precisÃ¡vamos no arquivo `index.php` para executar a aplicaÃ§Ã£o. E hÃ¡ mÃ©todos para a produÃ§Ã£o de apresentadores individuais. E assim por diante.

Os objetos que o container DI cria sÃ£o chamados de serviÃ§os por alguma razÃ£o.

O que Ã© realmente especial sobre esta classe Ã© que ela nÃ£o Ã© programada por vocÃª, mas pela estrutura. Ela realmente gera o cÃ³digo PHP e o salva em disco. VocÃª apenas dÃ¡ instruÃ§Ãµes sobre quais objetos o recipiente deve ser capaz de produzir e como exatamente. E estas instruÃ§Ãµes sÃ£o escritas em [arquivos de configuraÃ§Ã£o |bootstrap#DI Container Configuration] no [formato NEON |neon:format] e, portanto, tÃªm a extensÃ£o `.neon`.

Os arquivos de configuraÃ§Ã£o sÃ£o usados puramente para instruir o recipiente DI. Assim, por exemplo, se eu especificar a opÃ§Ã£o `expiration: 14 days` na seÃ§Ã£o [sessÃ£o |http:configuration#Session], o recipiente DI ao criar o objeto `Nette\Http\Session` que representa a sessÃ£o chamarÃ¡ seu mÃ©todo `setExpiration('14 days')`, e assim a configuraÃ§Ã£o se tornarÃ¡ uma realidade.

HÃ¡ um capÃ­tulo inteiro pronto para vocÃª, descrevendo o que pode ser [configurado |nette:configuring] e como [definir seus prÃ³prios serviÃ§os |dependency-injection:services].

Uma vez que vocÃª entre na criaÃ§Ã£o de serviÃ§os, vocÃª se depararÃ¡ com a palavra [autoconexÃ£o |dependency-injection:autowiring]. Este Ã© um gadget que tornarÃ¡ sua vida incrivelmente mais fÃ¡cil. Ele pode passar objetos automaticamente onde vocÃª precisar (nos construtores de suas aulas, por exemplo) sem ter que fazer nada. VocÃª descobrirÃ¡ que o recipiente DI em Nette Ã© um pequeno milagre.


E agora? .[#toc-what-next]
==========================

Passamos pelos princÃ­pios bÃ¡sicos das aplicaÃ§Ãµes em Nette. AtÃ© agora, muito superficialmente, mas em breve vocÃª mergulharÃ¡ nas profundezas e eventualmente criarÃ¡ aplicaÃ§Ãµes maravilhosas na web. Onde continuar? VocÃª jÃ¡ tentou o tutorial [Criar sua primeira aplicaÃ§Ã£o |quickstart:getting-started]?

AlÃ©m do acima exposto, Nette possui todo um arsenal de [classes Ãºteis |utils:], [camada de banco de dados |database:], etc. Tente de propÃ³sito apenas clicar na documentaÃ§Ã£o. Ou visite o [blog |https://blog.nette.org]. VocÃª descobrirÃ¡ um monte de coisas interessantes.

Deixe que a estrutura lhe traga muita alegria ğŸ’™
