Â¿CÃ³mo funcionan las aplicaciones?
*********************************

<div class=perex>

EstÃ¡ leyendo el documento fundamental de la documentaciÃ³n de Nette. AprenderÃ¡ todo el principio de funcionamiento de las aplicaciones web. De la A a la Z, desde el momento del nacimiento hasta el Ãºltimo suspiro del script PHP. DespuÃ©s de leerlo, sabrÃ¡:

- cÃ³mo funciona todo
- quÃ© son Bootstrap, Presenter y el contenedor DI
- cÃ³mo es la estructura de directorios

</div>


Estructura de directorios
=========================

Abra el ejemplo del esqueleto de una aplicaciÃ³n web llamado [WebProject|https://github.com/nette/web-project] y mientras lee, puede mirar los archivos de los que se habla.

La estructura de directorios tiene este aspecto:

/--pre
<b>web-project/</b>
â”œâ”€â”€ <b>app/</b>                      â† directorio con la aplicaciÃ³n
â”‚   â”œâ”€â”€ <b>Core/</b>                 â† clases bÃ¡sicas necesarias para el funcionamiento
â”‚   â”‚   â””â”€â”€ <b>RouterFactory.php</b> â† configuraciÃ³n de direcciones URL
â”‚   â”œâ”€â”€ <b>Presentation/</b>         â† presenters, plantillas, etc.
â”‚   â”‚   â”œâ”€â”€ <b>@layout.latte</b>     â† plantilla de layout
â”‚   â”‚   â””â”€â”€ <b>Home/</b>             â† directorio del presenter Home
â”‚   â”‚       â”œâ”€â”€ <b>HomePresenter.php</b> â† clase del presenter Home
â”‚   â”‚       â””â”€â”€ <b>default.latte</b> â† plantilla de la acciÃ³n default
â”‚   â””â”€â”€ <b>Bootstrap.php</b>         â† clase de arranque Bootstrap
â”œâ”€â”€ <b>bin/</b>                      â† scripts ejecutados desde la lÃ­nea de comandos
â”œâ”€â”€ <b>config/</b>                   â† archivos de configuraciÃ³n
â”‚   â”œâ”€â”€ <b>common.neon</b>
â”‚   â””â”€â”€ <b>services.neon</b>
â”œâ”€â”€ <b>log/</b>                      â† errores registrados
â”œâ”€â”€ <b>temp/</b>                     â† archivos temporales, cachÃ©, etc.
â”œâ”€â”€ <b>vendor/</b>                   â† librerÃ­as instaladas por Composer
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ <b>autoload.php</b>          â† autoloading de todos los paquetes instalados
â”œâ”€â”€ <b>www/</b>                      â† directorio pÃºblico o document-root del proyecto
â”‚   â”œâ”€â”€ <b>.htaccess</b>             â† reglas mod_rewrite
â”‚   â””â”€â”€ <b>index.php</b>             â† archivo inicial con el que se inicia la aplicaciÃ³n
â””â”€â”€ <b>.htaccess</b>                 â† prohÃ­be el acceso a todos los directorios excepto www
\--

Puede cambiar la estructura de directorios como desee, renombrar o mover carpetas, es completamente flexible. Nette, ademÃ¡s, dispone de una autodetecciÃ³n inteligente y reconoce automÃ¡ticamente la ubicaciÃ³n de la aplicaciÃ³n, incluida su base de URL.

En aplicaciones un poco mÃ¡s grandes, podemos [dividir las carpetas con presenters y plantillas en subdirectorios |directory-structure#Presenters y plantillas] y las clases en espacios de nombres, que llamamos mÃ³dulos.

El directorio `www/` representa el llamado directorio pÃºblico o document-root del proyecto. Puede renombrarlo sin necesidad de configurar nada mÃ¡s en el lado de la aplicaciÃ³n. Solo es necesario [configurar el hosting |nette:troubleshooting#CÃ³mo cambiar o eliminar el directorio www de la URL] para que el document-root apunte a este directorio.

TambiÃ©n puede descargar WebProject directamente incluyendo Nette usando [Composer |best-practices:composer]:

```shell
composer create-project nette/web-project
```

En Linux o macOS, establezca [permisos de escritura |nette:troubleshooting#ConfiguraciÃ³n de permisos de directorio] para los directorios `log/` y `temp/`.

La aplicaciÃ³n WebProject estÃ¡ lista para ejecutarse, no es necesario configurar absolutamente nada y puede mostrarla directamente en el navegador accediendo a la carpeta `www/`.


PeticiÃ³n HTTP
=============

Todo comienza en el momento en que el usuario abre una pÃ¡gina en el navegador. Es decir, cuando el navegador llama al servidor con una peticiÃ³n HTTP. La peticiÃ³n apunta a un Ãºnico archivo PHP, que se encuentra en el directorio pÃºblico `www/`, y este es `index.php`. Supongamos que se trata de una peticiÃ³n a la direcciÃ³n `https://example.com/product/123`. Gracias a la [configuraciÃ³n adecuada del servidor |nette:troubleshooting#CÃ³mo configurar el servidor para URLs amigables], incluso esta URL se mapea al archivo `index.php` y este se ejecuta.

Su tarea es:

1) inicializar el entorno
2) obtener la fÃ¡brica
3) iniciar la aplicaciÃ³n Nette, que gestionarÃ¡ la peticiÃ³n

Â¿QuÃ© fÃ¡brica? Â¡No fabricamos tractores, sino pÃ¡ginas web! Espere, se explicarÃ¡ de inmediato.

Con las palabras "inicializaciÃ³n del entorno" nos referimos, por ejemplo, a que se activa [Tracy|tracy:], que es una herramienta increÃ­ble para el registro o la visualizaciÃ³n de errores. En el servidor de producciÃ³n, registra los errores, en el de desarrollo los muestra directamente. Por lo tanto, la inicializaciÃ³n tambiÃ©n incluye la decisiÃ³n de si el sitio web se ejecuta en modo de producciÃ³n o de desarrollo. Para esto, Nette utiliza una [autodetecciÃ³n inteligente |bootstrap#Modo de desarrollo vs producciÃ³n]: si ejecuta el sitio web en localhost, se ejecuta en modo de desarrollo. Por lo tanto, no necesita configurar nada y la aplicaciÃ³n estÃ¡ lista tanto para el desarrollo como para la implementaciÃ³n en producciÃ³n. Estos pasos se realizan y se describen detalladamente en el capÃ­tulo sobre la [clase Bootstrap|bootstrap].

El tercer punto (sÃ­, saltamos el segundo, pero volveremos a Ã©l) es el inicio de la aplicaciÃ³n. La gestiÃ³n de las peticiones HTTP en Nette estÃ¡ a cargo de la clase `Nette\Application\Application` (en adelante `Application`), por lo que cuando decimos iniciar la aplicaciÃ³n, nos referimos especÃ­ficamente a llamar al mÃ©todo con el nombre apropiado `run()` en el objeto de esta clase.

Nette es un mentor que le guÃ­a para escribir aplicaciones limpias segÃºn metodologÃ­as probadas. Y una de las mÃ¡s probadas se llama **inyecciÃ³n de dependencias**, abreviada como DI. En este momento no queremos cargarle con la explicaciÃ³n de DI, para eso estÃ¡ [un capÃ­tulo aparte|dependency-injection:introduction], lo importante es la consecuencia de que los objetos clave generalmente nos los crearÃ¡ una fÃ¡brica de objetos, que se llama **contenedor DI** (abreviado como DIC). SÃ­, esa es la fÃ¡brica de la que hablamos hace un momento. Y tambiÃ©n nos fabricarÃ¡ el objeto `Application`, por eso necesitamos primero el contenedor. Lo obtenemos usando la clase `Configurator` y le pedimos que fabrique el objeto `Application`, llamamos al mÃ©todo `run()` en Ã©l y asÃ­ se inicia la aplicaciÃ³n Nette. Exactamente esto sucede en el archivo [index.php |bootstrap#index.php].


Nette Application
=================

La clase Application tiene una Ãºnica tarea: responder a la peticiÃ³n HTTP.

Las aplicaciones escritas en Nette se dividen en muchos llamados presenters (en otros frameworks puede encontrar el tÃ©rmino controller, es lo mismo), que son clases, cada una de las cuales representa alguna pÃ¡gina especÃ­fica del sitio web: p. ej., la pÃ¡gina de inicio; un producto en una tienda electrÃ³nica; un formulario de inicio de sesiÃ³n; un feed sitemap, etc. Una aplicaciÃ³n puede tener desde uno hasta miles de presenters.

Application comienza pidiendo al llamado router que decida a cuÃ¡l de los presenters pasar la peticiÃ³n actual para su gestiÃ³n. El router decide de quiÃ©n es la responsabilidad. Mira la URL de entrada `https://example.com/product/123` y, basÃ¡ndose en cÃ³mo estÃ¡ configurado, decide que este es trabajo, por ejemplo, para el **presenter** `Product`, al que le pedirÃ¡ como **acciÃ³n** la visualizaciÃ³n (`show`) del producto con `id: 123`. Es una buena costumbre escribir el par presenter + acciÃ³n separado por dos puntos como `Product:show`.

Por lo tanto, el router transformÃ³ la URL en el par `Presenter:action` + parÃ¡metros, en nuestro caso `Product:show` + `id: 123`. Puede ver cÃ³mo es un router de este tipo en el archivo `app/Core/RouterFactory.php` y lo describimos detalladamente en el capÃ­tulo [Enrutamiento |Routing].

Sigamos. Application ya conoce el nombre del presenter y puede continuar. Creando el objeto de la clase `ProductPresenter`, que es el cÃ³digo del presenter `Product`. MÃ¡s precisamente, pide al contenedor DI que fabrique el presenter, porque para eso estÃ¡ Ã©l.

El presenter puede verse asÃ­:

```php
class ProductPresenter extends Nette\Application\UI\Presenter
{
	public function __construct(
		private ProductRepository $repository,
	) {
	}

	public function renderShow(int $id): void
	{
		// obtenemos datos del modelo y los pasamos a la plantilla
		$this->template->product = $this->repository->getProduct($id);
	}
}
```

La gestiÃ³n de la peticiÃ³n la asume el presenter. Y la tarea es clara: realiza la acciÃ³n `show` con `id: 123`. Lo que en el lenguaje de los presenters significa que se llama al mÃ©todo `renderShow()` y en el parÃ¡metro `$id` recibe `123`.

Un presenter puede manejar mÃºltiples acciones, es decir, tener mÃºltiples mÃ©todos `render<Action>()`. Pero recomendamos diseÃ±ar presenters con una o la menor cantidad posible de acciones.

Entonces, se llamÃ³ al mÃ©todo `renderShow(123)`, cuyo cÃ³digo es un ejemplo ficticio, pero puede ver en Ã©l cÃ³mo se pasan los datos a la plantilla, es decir, escribiendo en `$this->template`.

Posteriormente, el presenter devuelve una respuesta. Esta puede ser una pÃ¡gina HTML, una imagen, un documento XML, el envÃ­o de un archivo desde el disco, JSON o incluso una redirecciÃ³n a otra pÃ¡gina. Es importante que si no decimos explÃ­citamente cÃ³mo debe responder (que es el caso de `ProductPresenter`), la respuesta serÃ¡ la renderizaciÃ³n de una plantilla con una pÃ¡gina HTML. Â¿Por quÃ©? Porque en el 99% de los casos queremos renderizar una plantilla, por lo que el presenter toma este comportamiento como predeterminado y quiere facilitarnos el trabajo. Ese es el propÃ³sito de Nette.

Ni siquiera tenemos que indicar quÃ© plantilla renderizar, Ã©l mismo deduce la ruta hacia ella. En el caso de la acciÃ³n `show`, simplemente intenta cargar la plantilla `show.latte` en el directorio con la clase `ProductPresenter`. TambiÃ©n intentarÃ¡ localizar el layout en el archivo `@layout.latte` (mÃ¡s detalles sobre la [bÃºsqueda de plantillas |templates#BÃºsqueda de plantillas]).

Y posteriormente renderiza las plantillas. Con esto, la tarea del presenter y de toda la aplicaciÃ³n estÃ¡ completa y la obra estÃ¡ terminada. Si la plantilla no existiera, se devolverÃ­a una pÃ¡gina con error 404. Puede leer mÃ¡s sobre los presenters en la pÃ¡gina [Presenters|presenters].

[* request-flow.svg *]

Por si acaso, intentemos recapitular todo el proceso con una URL ligeramente diferente:

1) La URL serÃ¡ `https://example.com`
2) Arrancamos la aplicaciÃ³n, se crea el contenedor y se ejecuta `Application::run()`
3) El router decodifica la URL como el par `Home:default`
4) Se crea el objeto de la clase `HomePresenter`
5) Se llama al mÃ©todo `renderDefault()` (si existe)
6) Se renderiza la plantilla, p. ej., `default.latte` con el layout, p. ej., `@layout.latte`


Puede que ahora se haya encontrado con muchos conceptos nuevos, pero creemos que tienen sentido. Crear aplicaciones en Nette es increÃ­blemente fÃ¡cil.


Plantillas
==========

Ya que hablamos de plantillas, en Nette se utiliza el sistema de plantillas [Latte |latte:]. Por eso esas extensiones `.latte` en las plantillas. Latte se utiliza, por un lado, porque es el sistema de plantillas mÃ¡s seguro para PHP y, al mismo tiempo, el sistema mÃ¡s intuitivo. No necesita aprender mucho nuevo, le basta con conocer PHP y algunas etiquetas. Todo lo aprenderÃ¡ [en la documentaciÃ³n |templates].

En la plantilla, se [crean enlaces |creating-links] a otros presenters y acciones de esta manera:

```latte
<a n:href="Product:show $productId">detalle del producto</a>
```

Simplemente, en lugar de la URL real, escribe el par conocido `Presenter:action` e indica los parÃ¡metros necesarios. El truco estÃ¡ en `n:href`, que indica que este atributo serÃ¡ procesado por Nette. Y generarÃ¡:

```latte
<a href="/product/456">detalle del producto</a>
```

La generaciÃ³n de URL estÃ¡ a cargo del router mencionado anteriormente. Es decir, los routers en Nette son excepcionales porque pueden realizar no solo transformaciones de URL al par presenter:action, sino tambiÃ©n al revÃ©s, es decir, generar una URL a partir del nombre del presenter + acciÃ³n + parÃ¡metros. Gracias a esto, en Nette puede cambiar completamente las formas de las URL en toda la aplicaciÃ³n terminada, sin cambiar un solo carÃ¡cter en la plantilla o el presenter. Simplemente modificando el router. TambiÃ©n gracias a esto funciona la llamada canonizaciÃ³n, que es otra caracterÃ­stica Ãºnica de Nette que contribuye a un mejor SEO (optimizaciÃ³n para motores de bÃºsqueda) al evitar automÃ¡ticamente la existencia de contenido duplicado en diferentes URL. Muchos programadores lo consideran asombroso.


Componentes interactivos
========================

Sobre los presenters debemos revelarle una cosa mÃ¡s: tienen incorporado un sistema de componentes. Algo similar pueden recordar los veteranos de Delphi o ASP.NET Web Forms, algo remotamente similar es la base de React o Vue.js. En el mundo de los frameworks PHP, es una caracterÃ­stica absolutamente Ãºnica.

Los componentes son unidades reutilizables independientes que insertamos en las pÃ¡ginas (es decir, presenters). Pueden ser [formularios |forms:in-presenter], [datagrids |https://componette.org/contributte/datagrid/], menÃºs, encuestas de votaciÃ³n, en realidad cualquier cosa que tenga sentido usar repetidamente. Podemos crear nuestros propios componentes o usar algunos de la [enorme oferta |https://componette.org] de componentes de cÃ³digo abierto.

Los componentes influyen fundamentalmente en el enfoque para la creaciÃ³n de aplicaciones. Le abrirÃ¡n nuevas posibilidades de componer pÃ¡ginas a partir de unidades prefabricadas. Y ademÃ¡s tienen algo en comÃºn con [Hollywood |components#Estilo Hollywood].


Contenedor DI y configuraciÃ³n
=============================

El contenedor DI o fÃ¡brica de objetos es el corazÃ³n de toda la aplicaciÃ³n.

No se preocupe, no es ninguna caja negra mÃ¡gica, como podrÃ­a parecer por las lÃ­neas anteriores. En realidad, es una clase PHP bastante aburrida, que Nette genera y guarda en el directorio de cachÃ©. Tiene muchos mÃ©todos llamados como `createServiceAbcd()` y cada uno de ellos sabe cÃ³mo fabricar y devolver algÃºn objeto. SÃ­, tambiÃ©n estÃ¡ el mÃ©todo `createServiceApplication()`, que fabrica `Nette\Application\Application`, que necesitÃ¡bamos en el archivo `index.php` para iniciar la aplicaciÃ³n. Y hay mÃ©todos que fabrican los presenters individuales. Y asÃ­ sucesivamente.

A los objetos que crea el contenedor DI, por alguna razÃ³n, se les llama servicios.

Lo que es realmente especial de esta clase es que no la programa usted, sino el framework. Ã‰l realmente genera el cÃ³digo PHP y lo guarda en el disco. Usted solo da instrucciones sobre quÃ© objetos debe saber fabricar el contenedor y cÃ³mo exactamente. Y estas instrucciones estÃ¡n escritas en [archivos de configuraciÃ³n |bootstrap#ConfiguraciÃ³n del contenedor DI], para los cuales se utiliza el formato [NEON|neon:format] y, por lo tanto, tambiÃ©n tienen la extensiÃ³n `.neon`.

Los archivos de configuraciÃ³n sirven puramente para instruir al contenedor DI. AsÃ­ que, por ejemplo, si indico en la secciÃ³n [session |http:configuration#SesiÃ³n] la opciÃ³n `expiration: 14 days`, el contenedor DI al crear el objeto `Nette\Http\Session` que representa la sesiÃ³n, llamarÃ¡ a su mÃ©todo `setExpiration('14 days')` y asÃ­ la configuraciÃ³n se harÃ¡ realidad.

Hay un capÃ­tulo completo preparado para usted que describe quÃ© se puede [configurar |nette:configuring] y cÃ³mo [definir servicios propios |dependency-injection:services].

Una vez que se adentre un poco en la creaciÃ³n de servicios, se encontrarÃ¡ con la palabra [autowiring |dependency-injection:autowiring]. Esta es una caracterÃ­stica que le simplificarÃ¡ la vida de manera increÃ­ble. Sabe cÃ³mo pasar automÃ¡ticamente objetos donde los necesita (por ejemplo, en los constructores de sus clases), sin que tenga que hacer nada. DescubrirÃ¡ que el contenedor DI en Nette es un pequeÃ±o milagro.


Â¿A dÃ³nde ir ahora?
==================

Hemos repasado los principios bÃ¡sicos de las aplicaciones en Nette. Hasta ahora muy superficialmente, pero pronto profundizarÃ¡ y con el tiempo crearÃ¡ maravillosas aplicaciones web. Â¿A dÃ³nde continuar ahora? Â¿Ya ha probado el tutorial [Escribiendo la primera aplicaciÃ³n|quickstart:]?

AdemÃ¡s de lo descrito anteriormente, Nette dispone de todo un arsenal de [clases Ãºtiles|utils:], [capa de base de datos|database:], etc. Intente simplemente hacer clic en la documentaciÃ³n. O en el [blog|https://blog.nette.org]. DescubrirÃ¡ muchas cosas interesantes.

Que el framework le traiga mucha alegrÃ­a ğŸ’™
