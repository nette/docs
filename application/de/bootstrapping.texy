Bootstrapping
*************

<div class=perex>

Bootstrapping ist der Prozess der Initialisierung der Anwendungsumgebung, der Erstellung eines Dependency Injection (DI) Containers und des Startens der Anwendung. Wir werden besprechen:

- wie die Bootstrap-Klasse die Umgebung initialisiert
- wie Anwendungen mit NEON-Dateien konfiguriert werden
- wie zwischen Produktions- und Entwicklungsmodus unterschieden wird
- wie der DI-Container erstellt und konfiguriert wird

</div>


Anwendungen, egal ob Webanwendungen oder von der Kommandozeile gestartete Skripte, beginnen ihre AusfÃ¼hrung mit einer Form der Initialisierung der Umgebung. FrÃ¼her war dafÃ¼r eine Datei wie `include.inc.php` verantwortlich, die von der initialen Datei eingebunden wurde. In modernen Nette-Anwendungen wurde dies durch die Klasse `Bootstrap` ersetzt, die Sie als Teil der Anwendung in der Datei `app/Bootstrap.php` finden. Sie kÃ¶nnte zum Beispiel so aussehen:

```php
use Nette\Bootstrap\Configurator;

class Bootstrap
{
	private Configurator $configurator;
	private string $rootDir;

	public function __construct()
	{
		$this->rootDir = dirname(__DIR__);
		// Der Configurator ist fÃ¼r die Einstellung der Anwendungsumgebung und der Dienste verantwortlich.
		$this->configurator = new Configurator;
		// Legt das Verzeichnis fÃ¼r temporÃ¤re Dateien fest, die von Nette generiert werden (z. B. kompilierte Templates)
		$this->configurator->setTempDirectory($this->rootDir . '/temp');
	}

	public function bootWebApplication(): Nette\DI\Container
	{
		$this->initializeEnvironment();
		$this->setupContainer();
		return $this->configurator->createContainer();
	}

	private function initializeEnvironment(): void
	{
		// Nette ist schlau und der Entwicklungsmodus wird automatisch aktiviert,
		// oder Sie kÃ¶nnen ihn fÃ¼r eine bestimmte IP-Adresse aktivieren, indem Sie die folgende Zeile auskommentieren:
		// $this->configurator->setDebugMode('secret@23.75.345.200');

		// Aktiviert Tracy: das ultimative "Schweizer Taschenmesser" fÃ¼r das Debugging.
		$this->configurator->enableTracy($this->rootDir . '/log');

		// RobotLoader: lÃ¤dt automatisch alle Klassen im ausgewÃ¤hlten Verzeichnis
		$this->configurator->createRobotLoader()
			->addDirectory(__DIR__)
			->register();
	}

	private function setupContainer(): void
	{
		// LÃ¤dt Konfigurationsdateien
		$this->configurator->addConfig($this->rootDir . '/config/common.neon');
	}
}
```


index.php
=========

Die initiale Datei fÃ¼r Webanwendungen ist `index.php`, die sich im [Ã¶ffentlichen Verzeichnis |directory-structure#Ã–ffentliches Verzeichnis www] `www/` befindet. Diese lÃ¤sst die Umgebung von der Bootstrap-Klasse initialisieren und den DI-Container erstellen. Danach holt sie sich den Dienst `Application` daraus, der die Webanwendung startet:

```php
$bootstrap = new App\Bootstrap;
// Initialisierung der Umgebung + Erstellung des DI-Containers
$container = $bootstrap->bootWebApplication();
// Der DI-Container erstellt das Objekt Nette\Application\Application
$application = $container->getByType(Nette\Application\Application::class);
// Start der Nette-Anwendung und Verarbeitung der eingehenden Anfrage
$application->run();
```

Wie man sieht, hilft die Klasse [api:Nette\Bootstrap\Configurator] bei der Einstellung der Umgebung und der Erstellung des Dependency Injection (DI) Containers, die wir uns nun genauer ansehen werden.


Entwicklungs- vs. Produktionsmodus
==================================

Nette verhÃ¤lt sich unterschiedlich, je nachdem, ob es auf einem Entwicklungs- oder Produktionsserver lÃ¤uft:

ðŸ› ï¸  Entwicklungsmodus (Development):
	- Zeigt die Tracy Debugbar mit nÃ¼tzlichen Informationen an (SQL-Abfragen, AusfÃ¼hrungszeit, verwendeter Speicher)
	- Zeigt im Fehlerfall eine detaillierte Fehlerseite mit Funktionsaufrufen und Variableninhalten an
	- Erneuert automatisch den Cache bei Ã„nderungen an Latte-Templates, Konfigurationsdateien usw.


ðŸš€  Produktionsmodus (Production):
	- Zeigt keine Debugging-Informationen an, alle Fehler werden im Log protokolliert
	- Zeigt im Fehlerfall den ErrorPresenter oder eine allgemeine "Server Error"-Seite an
	- Der Cache wird niemals automatisch erneuert!
	- Optimiert fÃ¼r Geschwindigkeit und Sicherheit


Die Moduswahl erfolgt durch Auto-Detektion, sodass normalerweise nichts konfiguriert oder manuell umgeschaltet werden muss:

- Entwicklungsmodus: auf Localhost (IP-Adresse `127.0.0.1` oder `::1`), wenn kein Proxy vorhanden ist (d. h. dessen HTTP-Header)
- Produktionsmodus: Ã¼berall sonst

Wenn wir den Entwicklungsmodus auch in anderen FÃ¤llen aktivieren mÃ¶chten, z. B. fÃ¼r Programmierer, die von einer bestimmten IP-Adresse zugreifen, verwenden wir `setDebugMode()`:

```php
$this->configurator->setDebugMode('23.75.345.200'); // es kann auch ein Array von IP-Adressen angegeben werden
```

Wir empfehlen dringend, die IP-Adresse mit einem Cookie zu kombinieren. Wir speichern einen geheimen Token, z. B. `secret1234`, im Cookie `nette-debug` und aktivieren auf diese Weise den Entwicklungsmodus fÃ¼r Programmierer, die von einer bestimmten IP-Adresse zugreifen und gleichzeitig den erwÃ¤hnten Token im Cookie haben:

```php
$this->configurator->setDebugMode('secret1234@23.75.345.200');
```

Wir kÃ¶nnen den Entwicklungsmodus auch vollstÃ¤ndig deaktivieren, sogar fÃ¼r Localhost:

```php
$this->configurator->setDebugMode(false);
```

Achtung, der Wert `true` schaltet den Entwicklungsmodus fest ein, was auf einem Produktionsserver niemals passieren darf.


Debugging-Tool Tracy
====================

FÃ¼r einfaches Debugging aktivieren wir noch das groÃŸartige Werkzeug [Tracy |tracy:]. Im Entwicklungsmodus visualisiert es Fehler und im Produktionsmodus protokolliert es Fehler in das angegebene Verzeichnis:

```php
$this->configurator->enableTracy($this->rootDir . '/log');
```


TemporÃ¤re Dateien
=================

Nette verwendet einen Cache fÃ¼r den DI-Container, RobotLoader, Templates usw. Daher ist es notwendig, den Pfad zum Verzeichnis festzulegen, in dem der Cache gespeichert wird:

```php
$this->configurator->setTempDirectory($this->rootDir . '/temp');
```

Unter Linux oder macOS setzen Sie fÃ¼r die Verzeichnisse `log/` und `temp/` [Schreibrechte |nette:troubleshooting#Einstellung der Verzeichnisberechtigungen].


RobotLoader
===========

In der Regel mÃ¶chten wir Klassen automatisch mit dem [RobotLoader |robot-loader:] laden, also mÃ¼ssen wir ihn starten und ihn Klassen aus dem Verzeichnis laden lassen, in dem sich `Bootstrap.php` befindet (d. h. `__DIR__`), sowie aus allen Unterverzeichnissen:

```php
$this->configurator->createRobotLoader()
	->addDirectory(__DIR__)
	->register();
```

Ein alternativer Ansatz besteht darin, Klassen nur Ã¼ber [Composer |best-practices:composer] unter Einhaltung von PSR-4 laden zu lassen.


Zeitzone
========

Ãœber den Konfigurator kÃ¶nnen Sie die Standard-Zeitzone einstellen.

```php
$this->configurator->setTimeZone('Europe/Prague');
```


Konfiguration des DI-Containers
===============================

Ein Teil des Boot-Prozesses ist die Erstellung des DI-Containers, auch Objektfabrik genannt, der das Herz der gesamten Anwendung ist. Es handelt sich tatsÃ¤chlich um eine PHP-Klasse, die von Nette generiert und im Cache-Verzeichnis gespeichert wird. Die Fabrik erstellt die SchlÃ¼sselobjekte der Anwendung, und mithilfe von Konfigurationsdateien weisen wir sie an, wie sie diese erstellen und einstellen soll, wodurch wir das Verhalten der gesamten Anwendung beeinflussen.

Konfigurationsdateien werden normalerweise im [NEON |neon:format]-Format geschrieben. In einem separaten Kapitel erfahren Sie, [was alles konfiguriert werden kann |nette:configuring].

.[tip]
Im Entwicklungsmodus wird der Container bei jeder Ã„nderung des Codes oder der Konfigurationsdateien automatisch aktualisiert. Im Produktionsmodus wird er nur einmal generiert, und Ã„nderungen werden zur Maximierung der Leistung nicht Ã¼berprÃ¼ft.

Konfigurationsdateien laden wir mit `addConfig()`:

```php
$this->configurator->addConfig($this->rootDir . '/config/common.neon');
```

Wenn wir mehrere Konfigurationsdateien hinzufÃ¼gen mÃ¶chten, kÃ¶nnen wir die Funktion `addConfig()` mehrmals aufrufen.

```php
$configDir = $this->rootDir . '/config';
$this->configurator->addConfig($configDir . '/common.neon');
$this->configurator->addConfig($configDir . '/services.neon');
if (PHP_SAPI === 'cli') {
	$this->configurator->addConfig($configDir . '/cli.php');
}
```

Der Name `cli.php` ist kein Tippfehler; die Konfiguration kann auch in einer PHP-Datei geschrieben sein, die sie als Array zurÃ¼ckgibt.

Wir kÃ¶nnen auch weitere Konfigurationsdateien im [Abschnitt `includes` |dependency-injection:configuration#Dateien einbinden] hinzufÃ¼gen.

Wenn in den Konfigurationsdateien Elemente mit denselben SchlÃ¼sseln erscheinen, werden sie Ã¼berschrieben oder im Falle von [Arrays zusammengefÃ¼hrt |dependency-injection:configuration#ZusammenfÃ¼hren]. Die spÃ¤ter eingebundene Datei hat eine hÃ¶here PrioritÃ¤t als die vorherige. Die Datei, in der der Abschnitt `includes` aufgefÃ¼hrt ist, hat eine hÃ¶here PrioritÃ¤t als die darin eingebundenen Dateien.


Statische Parameter
-------------------

Parameter, die in Konfigurationsdateien verwendet werden, kÃ¶nnen [im Abschnitt `parameters` |dependency-injection:configuration#Parameter] definiert und auch Ã¼ber die Methode `addStaticParameters()` (hat den Alias `addParameters()`) Ã¼bergeben (oder Ã¼berschrieben) werden. Wichtig ist, dass unterschiedliche Werte der Parameter die Generierung zusÃ¤tzlicher DI-Container, also zusÃ¤tzlicher Klassen, verursachen.

```php
$this->configurator->addStaticParameters([
	'projectId' => 23,
]);
```

Auf den Parameter `projectId` kann in der Konfiguration mit der Ã¼blichen Schreibweise `%projectId%` verwiesen werden.


Dynamische Parameter
--------------------

Wir kÃ¶nnen dem Container auch dynamische Parameter hinzufÃ¼gen, deren unterschiedliche Werte im Gegensatz zu statischen Parametern nicht die Generierung neuer DI-Container verursachen.

```php
$this->configurator->addDynamicParameters([
	'remoteIp' => $_SERVER['REMOTE_ADDR'],
]);
```

So kÃ¶nnen wir einfach z. B. Umgebungsvariablen hinzufÃ¼gen, auf die dann in der Konfiguration mit der Schreibweise `%env.variable%` verwiesen werden kann.

```php
$this->configurator->addDynamicParameters([
	'env' => getenv(),
]);
```


Standardparameter
-----------------

In Konfigurationsdateien kÃ¶nnen Sie diese statischen Parameter verwenden:

- `%appDir%` ist der absolute Pfad zum Verzeichnis mit der Datei `Bootstrap.php`
- `%wwwDir%` ist der absolute Pfad zum Verzeichnis mit der Eingabedatei `index.php`
- `%tempDir%` ist der absolute Pfad zum Verzeichnis fÃ¼r temporÃ¤re Dateien
- `%vendorDir%` ist der absolute Pfad zum Verzeichnis, in dem Composer Bibliotheken installiert
- `%rootDir%` ist der absolute Pfad zum Stammverzeichnis des Projekts
- `%debugMode%` gibt an, ob sich die Anwendung im Debugging-Modus befindet
- `%consoleMode%` gibt an, ob die Anfrage Ã¼ber die Kommandozeile kam


Importierte Dienste
-------------------

Jetzt gehen wir tiefer. Obwohl der Zweck des DI-Containers darin besteht, Objekte zu erstellen, kann es ausnahmsweise notwendig sein, ein vorhandenes Objekt in den Container einzufÃ¼gen. Dies tun wir, indem wir den Dienst mit dem Flag `imported: true` definieren.

```neon
services:
	myservice:
		type: App\Model\MyCustomService
		imported: true
```

Und im Bootstrap fÃ¼gen wir das Objekt in den Container ein:

```php
$this->configurator->addServices([
	'myservice' => new App\Model\MyCustomService('foobar'),
]);
```


Unterschiedliche Umgebungen
===========================

Scheuen Sie sich nicht, die Bootstrap-Klasse an Ihre BedÃ¼rfnisse anzupassen. Sie kÃ¶nnen der Methode `bootWebApplication()` Parameter hinzufÃ¼gen, um Webprojekte zu unterscheiden. Oder wir kÃ¶nnen weitere Methoden hinzufÃ¼gen, zum Beispiel `bootTestEnvironment()`, die die Umgebung fÃ¼r Unit-Tests initialisiert, `bootConsoleApplication()` fÃ¼r Skripte, die von der Kommandozeile aufgerufen werden, usw.

```php
public function bootTestEnvironment(): Nette\DI\Container
{
	Tester\Environment::setup(); // Initialisierung von Nette Tester
	$this->setupContainer();
	return $this->configurator->createContainer();
}

public function bootConsoleApplication(): Nette\DI\Container
{
	$this->configurator->setDebugMode(false);
	$this->initializeEnvironment();
	$this->setupContainer();
	return $this->configurator->createContainer();
}
```
