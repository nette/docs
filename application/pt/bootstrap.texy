Bootstrap
*********

<div class=perex>

Bootstrap Ã© o cÃ³digo de inicializaÃ§Ã£o que inicializa o ambiente, cria o contÃªiner de injeÃ§Ã£o de dependÃªncia (DI) e inicia a aplicaÃ§Ã£o. Vamos discutir:

- como Ã© configurado usando arquivos NEON
- como distinguir entre modo de produÃ§Ã£o e desenvolvimento
- como criar um contÃªiner DI

</div>


AplicaÃ§Ãµes, sejam elas web ou scripts executados a partir da linha de comando, comeÃ§am sua execuÃ§Ã£o com alguma forma de inicializaÃ§Ã£o do ambiente. Antigamente, isso era responsabilidade de um arquivo chamado, por exemplo, `include.inc.php`, que o arquivo inicial incluÃ­a.
Em aplicaÃ§Ãµes Nette modernas, ele foi substituÃ­do pela classe `Bootstrap`, que, como parte da aplicaÃ§Ã£o, pode ser encontrada no arquivo `app/Bootstrap.php`. Pode parecer, por exemplo, assim:

```php
use Nette\Bootstrap\Configurator;

class Bootstrap
{
	private Configurator $configurator;
	private string $rootDir;

	public function __construct()
	{
		$this->rootDir = dirname(__DIR__);
		// O Configurator Ã© responsÃ¡vel por configurar o ambiente da aplicaÃ§Ã£o e os serviÃ§os.
		$this->configurator = new Configurator;
		// Define o diretÃ³rio para arquivos temporÃ¡rios gerados pelo Nette (por exemplo, templates compilados)
		$this->configurator->setTempDirectory($this->rootDir . '/temp');
	}

	public function bootWebApplication(): Nette\DI\Container
	{
		$this->initializeEnvironment();
		$this->setupContainer();
		return $this->configurator->createContainer();
	}

	private function initializeEnvironment(): void
	{
		// O Nette Ã© inteligente e o modo de desenvolvimento Ã© ativado automaticamente,
		// ou vocÃª pode habilitÃ¡-lo para um endereÃ§o IP especÃ­fico descomentando a linha seguinte:
		// $this->configurator->setDebugMode('secret@23.75.345.200');

		// Ativa o Tracy: o "canivete suÃ­Ã§o" definitivo para depuraÃ§Ã£o.
		$this->configurator->enableTracy($this->rootDir . '/log');

		// RobotLoader: carrega automaticamente todas as classes no diretÃ³rio selecionado
		$this->configurator->createRobotLoader()
			->addDirectory(__DIR__)
			->register();
	}

	private function setupContainer(): void
	{
		// Carrega os arquivos de configuraÃ§Ã£o
		$this->configurator->addConfig($this->rootDir . '/config/common.neon');
	}
}
```


index.php
=========

O arquivo inicial no caso de aplicaÃ§Ãµes web Ã© `index.php`, localizado no [diretÃ³rio pÃºblico |directory-structure#verejny-adresar-www] `www/`. Ele solicita Ã  classe Bootstrap que inicialize o ambiente e crie o contÃªiner DI. Em seguida, obtÃ©m o serviÃ§o `Application` dele, que inicia a aplicaÃ§Ã£o web:

```php
$bootstrap = new App\Bootstrap;
// InicializaÃ§Ã£o do ambiente + criaÃ§Ã£o do contÃªiner DI
$container = $bootstrap->bootWebApplication();
// O contÃªiner DI cria o objeto Nette\Application\Application
$application = $container->getByType(Nette\Application\Application::class);
// Inicia a aplicaÃ§Ã£o Nette e processa a requisiÃ§Ã£o recebida
$application->run();
```

Como pode ser visto, a classe [api:Nette\Bootstrap\Configurator] ajuda na configuraÃ§Ã£o do ambiente e na criaÃ§Ã£o do contÃªiner de injeÃ§Ã£o de dependÃªncia (DI), que agora apresentaremos em mais detalhes.


Modo de desenvolvimento vs produÃ§Ã£o
===================================

O Nette se comporta de maneira diferente dependendo se estÃ¡ sendo executado em um servidor de desenvolvimento ou de produÃ§Ã£o:

ğŸ› ï¸  Modo de desenvolvimento (Development):
	- Exibe a barra de depuraÃ§Ã£o do Tracy com informaÃ§Ãµes Ãºteis (consultas SQL, tempo de execuÃ§Ã£o, memÃ³ria usada)
	- Em caso de erro, exibe uma pÃ¡gina de erro detalhada com a pilha de chamadas de funÃ§Ãµes e o conteÃºdo das variÃ¡veis
	- Atualiza automaticamente o cache quando os templates Latte sÃ£o alterados, os arquivos de configuraÃ§Ã£o sÃ£o modificados, etc.


ğŸš€  Modo de produÃ§Ã£o (Production):
	- NÃ£o exibe nenhuma informaÃ§Ã£o de depuraÃ§Ã£o, todos os erros sÃ£o registrados no log
	- Em caso de erro, exibe o ErrorPresenter ou uma pÃ¡gina genÃ©rica "Server Error"
	- O cache nunca Ã© atualizado automaticamente!
	- Otimizado para velocidade e seguranÃ§a


A seleÃ§Ã£o do modo Ã© feita por autodeteÃ§Ã£o, portanto, geralmente nÃ£o Ã© necessÃ¡rio configurar nada ou alternar manualmente:

- modo de desenvolvimento: em localhost (endereÃ§o IP `127.0.0.1` ou `::1`) se nÃ£o houver proxy presente (ou seja, seu cabeÃ§alho HTTP)
- modo de produÃ§Ã£o: em todos os outros lugares

Se quisermos habilitar o modo de desenvolvimento em outros casos, por exemplo, para programadores acessando de um endereÃ§o IP especÃ­fico, usamos `setDebugMode()`:

```php
$this->configurator->setDebugMode('23.75.345.200'); // tambÃ©m pode ser fornecido um array de endereÃ§os IP
```

Recomendamos fortemente combinar o endereÃ§o IP com um cookie. Armazenamos um token secreto no cookie `nette-debug`, por exemplo, `secret1234`, e desta forma ativamos o modo de desenvolvimento para programadores acessando de um endereÃ§o IP especÃ­fico e que tambÃ©m possuem o token mencionado no cookie:

```php
$this->configurator->setDebugMode('secret1234@23.75.345.200');
```

TambÃ©m podemos desativar completamente o modo de desenvolvimento, mesmo para localhost:

```php
$this->configurator->setDebugMode(false);
```

AtenÃ§Ã£o, o valor `true` ativa o modo de desenvolvimento permanentemente, o que nunca deve acontecer em um servidor de produÃ§Ã£o.


Ferramenta de depuraÃ§Ã£o Tracy
=============================

Para facilitar a depuraÃ§Ã£o, ativamos tambÃ©m a excelente ferramenta [Tracy |tracy:]. No modo de desenvolvimento, ela visualiza os erros e, no modo de produÃ§Ã£o, registra os erros no diretÃ³rio especificado:

```php
$this->configurator->enableTracy($this->rootDir . '/log');
```


Arquivos temporÃ¡rios
====================

O Nette utiliza cache para o contÃªiner DI, RobotLoader, templates, etc. Portanto, Ã© necessÃ¡rio definir o caminho para o diretÃ³rio onde o cache serÃ¡ armazenado:

```php
$this->configurator->setTempDirectory($this->rootDir . '/temp');
```

No Linux ou macOS, defina as [permissÃµes de escrita |nette:troubleshooting#NastavenÃ­ prÃ¡v adresÃ¡Å™Å¯] para os diretÃ³rios `log/` e `temp/`.


RobotLoader
===========

Geralmente, queremos carregar classes automaticamente usando o [RobotLoader |robot-loader:], entÃ£o precisamos iniciÃ¡-lo e deixÃ¡-lo carregar classes do diretÃ³rio onde `Bootstrap.php` estÃ¡ localizado (ou seja, `__DIR__`), e de todos os subdiretÃ³rios:

```php
$this->configurator->createRobotLoader()
	->addDirectory(__DIR__)
	->register();
```

Uma abordagem alternativa Ã© deixar as classes serem carregadas apenas atravÃ©s do [Composer |best-practices:composer] seguindo o PSR-4.


Fuso horÃ¡rio
============

AtravÃ©s do configurator, vocÃª pode definir o fuso horÃ¡rio padrÃ£o.

```php
$this->configurator->setTimeZone('Europe/Lisbon');
```


ConfiguraÃ§Ã£o do contÃªiner DI
============================

Parte do processo de inicializaÃ§Ã£o Ã© a criaÃ§Ã£o do contÃªiner DI, ou seja, a fÃ¡brica de objetos, que Ã© o coraÃ§Ã£o de toda a aplicaÃ§Ã£o. Na verdade, Ã© uma classe PHP gerada pelo Nette e armazenada no diretÃ³rio de cache. A fÃ¡brica produz os objetos chave da aplicaÃ§Ã£o e, por meio de arquivos de configuraÃ§Ã£o, a instruÃ­mos sobre como criÃ¡-los e configurÃ¡-los, influenciando assim o comportamento de toda a aplicaÃ§Ã£o.

Os arquivos de configuraÃ§Ã£o sÃ£o geralmente escritos no formato [NEON |neon:format]. Em um capÃ­tulo separado, vocÃª aprenderÃ¡ [o que pode ser configurado |nette:configuring].

.[tip]
No modo de desenvolvimento, o contÃªiner Ã© atualizado automaticamente a cada alteraÃ§Ã£o no cÃ³digo ou nos arquivos de configuraÃ§Ã£o. No modo de produÃ§Ã£o, ele Ã© gerado apenas uma vez e as alteraÃ§Ãµes nÃ£o sÃ£o verificadas para maximizar o desempenho.

Carregamos os arquivos de configuraÃ§Ã£o usando `addConfig()`:

```php
$this->configurator->addConfig($this->rootDir . '/config/common.neon');
```

Se quisermos adicionar mais arquivos de configuraÃ§Ã£o, podemos chamar a funÃ§Ã£o `addConfig()` vÃ¡rias vezes.

```php
$configDir = $this->rootDir . '/config';
$this->configurator->addConfig($configDir . '/common.neon');
$this->configurator->addConfig($configDir . '/services.neon');
if (PHP_SAPI === 'cli') {
	$this->configurator->addConfig($configDir . '/cli.php');
}
```

O nome `cli.php` nÃ£o Ã© um erro de digitaÃ§Ã£o, a configuraÃ§Ã£o tambÃ©m pode ser escrita em um arquivo PHP, que a retorna como um array.

TambÃ©m podemos adicionar outros arquivos de configuraÃ§Ã£o na [seÃ§Ã£o `includes` |dependency-injection:configuration#VklÃ¡dÃ¡nÃ­ souborÅ¯].

Se elementos com as mesmas chaves aparecerem nos arquivos de configuraÃ§Ã£o, eles serÃ£o sobrescritos ou, no caso de [arrays, mesclados |dependency-injection:configuration#SluÄovÃ¡nÃ­]. O arquivo incluÃ­do posteriormente tem prioridade maior que o anterior. O arquivo em que a seÃ§Ã£o `includes` Ã© listada tem prioridade maior do que os arquivos incluÃ­dos nele.


ParÃ¢metros estÃ¡ticos
--------------------

ParÃ¢metros usados nos arquivos de configuraÃ§Ã£o podem ser definidos [na seÃ§Ã£o `parameters`|dependency-injection:configuration#parametry] e tambÃ©m podem ser passados (ou sobrescritos) pelo mÃ©todo `addStaticParameters()` (tem o alias `addParameters()`). Ã‰ importante que diferentes valores de parÃ¢metros causem a geraÃ§Ã£o de contÃªineres DI adicionais, ou seja, classes adicionais.

```php
$this->configurator->addStaticParameters([
	'projectId' => 23,
]);
```

O parÃ¢metro `projectId` pode ser referenciado na configuraÃ§Ã£o usando a notaÃ§Ã£o usual `%projectId%`.


ParÃ¢metros dinÃ¢micos
--------------------

TambÃ©m podemos adicionar parÃ¢metros dinÃ¢micos ao contÃªiner, cujos diferentes valores, ao contrÃ¡rio dos parÃ¢metros estÃ¡ticos, nÃ£o causam a geraÃ§Ã£o de novos contÃªineres DI.

```php
$this->configurator->addDynamicParameters([
	'remoteIp' => $_SERVER['REMOTE_ADDR'],
]);
```

Assim, podemos adicionar facilmente, por exemplo, variÃ¡veis de ambiente, que podem ser referenciadas na configuraÃ§Ã£o usando a notaÃ§Ã£o `%env.variable%`.

```php
$this->configurator->addDynamicParameters([
	'env' => getenv(),
]);
```


ParÃ¢metros padrÃ£o
-----------------

Nos arquivos de configuraÃ§Ã£o, vocÃª pode usar estes parÃ¢metros estÃ¡ticos:

- `%appDir%` Ã© o caminho absoluto para o diretÃ³rio com o arquivo `Bootstrap.php`
- `%wwwDir%` Ã© o caminho absoluto para o diretÃ³rio com o arquivo de entrada `index.php`
- `%tempDir%` Ã© o caminho absoluto para o diretÃ³rio de arquivos temporÃ¡rios
- `%vendorDir%` Ã© o caminho absoluto para o diretÃ³rio onde o Composer instala as bibliotecas
- `%rootDir%` Ã© o caminho absoluto para o diretÃ³rio raiz do projeto
- `%debugMode%` indica se a aplicaÃ§Ã£o estÃ¡ em modo de depuraÃ§Ã£o
- `%consoleMode%` indica se a requisiÃ§Ã£o veio da linha de comando


ServiÃ§os importados
-------------------

Agora estamos indo mais a fundo. Embora o propÃ³sito do contÃªiner DI seja criar objetos, excepcionalmente pode surgir a necessidade de inserir um objeto existente no contÃªiner. Fazemos isso definindo o serviÃ§o com o sinalizador `imported: true`.

```neon
services:
	myservice:
		type: App\Model\MyCustomService
		imported: true
```

E no bootstrap, inserimos o objeto no contÃªiner:

```php
$this->configurator->addServices([
	'myservice' => new App\Model\MyCustomService('foobar'),
]);
```


Ambiente diferente
==================

NÃ£o hesite em modificar a classe Bootstrap de acordo com suas necessidades. VocÃª pode adicionar parÃ¢metros ao mÃ©todo `bootWebApplication()` para distinguir projetos web. Ou podemos adicionar outros mÃ©todos, como `bootTestEnvironment()`, que inicializa o ambiente para testes unitÃ¡rios, `bootConsoleApplication()` para scripts chamados da linha de comando, etc.

```php
public function bootTestEnvironment(): Nette\DI\Container
{
	Tester\Environment::setup(); // inicializaÃ§Ã£o do Nette Tester
	$this->setupContainer();
	return $this->configurator->createContainer();
}

public function bootConsoleApplication(): Nette\DI\Container
{
	$this->configurator->setDebugMode(false);
	$this->initializeEnvironment();
	$this->setupContainer();
	return $this->configurator->createContainer();
}
```
