Bootstrap
*********

<div class=perex>

Bootstrap to kod startowy, ktÃ³ry inicjalizuje Å›rodowisko, tworzy kontener dependency injection (DI) i uruchamia aplikacjÄ™. Powiemy sobie:

- jak konfigurowaÄ‡ za pomocÄ… plikÃ³w NEON
- jak rozrÃ³Å¼niÄ‡ tryb produkcyjny i deweloperski
- jak utworzyÄ‡ kontener DI

</div>


Aplikacje, czy to webowe, czy skrypty uruchamiane z wiersza poleceÅ„, rozpoczynajÄ… swoje dziaÅ‚anie od pewnej formy inicjalizacji Å›rodowiska. W dawnych czasach odpowiadaÅ‚ za to plik o nazwie np. `include.inc.php`, ktÃ³ry byÅ‚ doÅ‚Ä…czany przez plik poczÄ…tkowy.
W nowoczesnych aplikacjach Nette zastÄ…piÅ‚a go klasa `Bootstrap`, ktÃ³rÄ… jako czÄ™Å›Ä‡ aplikacji znajdziesz w pliku `app/Bootstrap.php`. MoÅ¼e wyglÄ…daÄ‡ na przykÅ‚ad tak:

```php
use Nette\Bootstrap\Configurator;

class Bootstrap
{
	private Configurator $configurator;
	private string $rootDir;

	public function __construct()
	{
		$this->rootDir = dirname(__DIR__);
		// Konfigurator jest odpowiedzialny za ustawienie Å›rodowiska aplikacji i usÅ‚ug.
		$this->configurator = new Configurator;
		// Ustawia katalog dla plikÃ³w tymczasowych generowanych przez Nette (np. skompilowane szablony)
		$this->configurator->setTempDirectory($this->rootDir . '/temp');
	}

	public function bootWebApplication(): Nette\DI\Container
	{
		$this->initializeEnvironment();
		$this->setupContainer();
		return $this->configurator->createContainer();
	}

	private function initializeEnvironment(): void
	{
		// Nette jest sprytne i tryb deweloperski wÅ‚Ä…cza siÄ™ automatycznie,
		// lub moÅ¼esz go wÅ‚Ä…czyÄ‡ dla konkretnego adresu IP, odkomentowujÄ…c poniÅ¼szÄ… liniÄ™:
		// $this->configurator->setDebugMode('secret@23.75.345.200');

		// Aktywuje Tracy: ostateczny "szwajcarski scyzoryk" do debugowania.
		$this->configurator->enableTracy($this->rootDir . '/log');

		// RobotLoader: automatycznie Å‚aduje wszystkie klasy w wybranym katalogu
		$this->configurator->createRobotLoader()
			->addDirectory(__DIR__)
			->register();
	}

	private function setupContainer(): void
	{
		// Åaduje pliki konfiguracyjne
		$this->configurator->addConfig($this->rootDir . '/config/common.neon');
	}
}
```


index.php
=========

Plikiem poczÄ…tkowym w przypadku aplikacji webowych jest `index.php`, ktÃ³ry znajduje siÄ™ w [katalogu publicznym |directory-structure#verejny-adresar-www] `www/`. Ten plik zleca klasie Bootstrap inicjalizacjÄ™ Å›rodowiska i utworzenie kontenera DI. NastÄ™pnie pobiera z niego usÅ‚ugÄ™ `Application`, ktÃ³ra uruchamia aplikacjÄ™ webowÄ…:

```php
$bootstrap = new App\Bootstrap;
// Inicjalizacja Å›rodowiska + utworzenie kontenera DI
$container = $bootstrap->bootWebApplication();
// Kontener DI tworzy obiekt Nette\Application\Application
$application = $container->getByType(Nette\Application\Application::class);
// Uruchomienie aplikacji Nette i przetworzenie przychodzÄ…cego Å¼Ä…dania
$application->run();
```

Jak widaÄ‡, w ustawieniu Å›rodowiska i tworzeniu kontenera dependency injection (DI) pomaga klasa [api:Nette\Bootstrap\Configurator], ktÃ³rÄ… teraz bliÅ¼ej przedstawimy.


Tryb deweloperski vs produkcyjny
================================

Nette zachowuje siÄ™ rÃ³Å¼nie w zaleÅ¼noÅ›ci od tego, czy dziaÅ‚a na serwerze deweloperskim czy produkcyjnym:

ğŸ› ï¸  Tryb deweloperski (Development):
	- WyÅ›wietla debugbar Tracy z uÅ¼ytecznymi informacjami (zapytania SQL, czas wykonania, uÅ¼yta pamiÄ™Ä‡)
	- W przypadku bÅ‚Ä™du wyÅ›wietla szczegÃ³Å‚owÄ… stronÄ™ bÅ‚Ä™du z wywoÅ‚aniami funkcji i zawartoÅ›ciÄ… zmiennych
	- Automatycznie odÅ›wieÅ¼a cache przy zmianie szablonÃ³w Latte, modyfikacji plikÃ³w konfiguracyjnych itp.


ğŸš€  Tryb produkcyjny (Production):
	- Nie wyÅ›wietla Å¼adnych informacji debugowych, wszystkie bÅ‚Ä™dy zapisuje do logu
	- W przypadku bÅ‚Ä™du wyÅ›wietla ErrorPresenter lub ogÃ³lnÄ… stronÄ™ "Server Error"
	- Cache nigdy nie jest automatycznie odÅ›wieÅ¼any!
	- Zoptymalizowany pod kÄ…tem szybkoÅ›ci i bezpieczeÅ„stwa


WybÃ³r trybu odbywa siÄ™ przez autowykrywanie, wiÄ™c zazwyczaj nie trzeba niczego konfigurowaÄ‡ ani rÄ™cznie przeÅ‚Ä…czaÄ‡:

- tryb deweloperski: na localhost (adres IP `127.0.0.1` lub `::1`) jeÅ›li nie ma proxy (tj. jego nagÅ‚Ã³wka HTTP)
- tryb produkcyjny: wszÄ™dzie indziej

JeÅ›li chcemy wÅ‚Ä…czyÄ‡ tryb deweloperski rÃ³wnieÅ¼ w innych przypadkach, na przykÅ‚ad dla programistÃ³w Å‚Ä…czÄ…cych siÄ™ z konkretnego adresu IP, uÅ¼yjemy `setDebugMode()`:

```php
$this->configurator->setDebugMode('23.75.345.200'); // moÅ¼na podaÄ‡ rÃ³wnieÅ¼ tablicÄ™ adresÃ³w IP
```

Zdecydowanie zalecamy Å‚Ä…czenie adresu IP z cookie. W cookie `nette-debug` zapisujemy tajny token, np. `secret1234`, i w ten sposÃ³b aktywujemy tryb deweloperski dla programistÃ³w Å‚Ä…czÄ…cych siÄ™ z konkretnego adresu IP i jednoczeÅ›nie posiadajÄ…cych w cookie wspomniany token:

```php
$this->configurator->setDebugMode('secret1234@23.75.345.200');
```

Tryb deweloperski moÅ¼emy rÃ³wnieÅ¼ caÅ‚kowicie wyÅ‚Ä…czyÄ‡, nawet dla localhost:

```php
$this->configurator->setDebugMode(false);
```

Uwaga, wartoÅ›Ä‡ `true` wÅ‚Ä…cza tryb deweloperski na staÅ‚e, co nigdy nie powinno mieÄ‡ miejsca na serwerze produkcyjnym.


NarzÄ™dzie debugujÄ…ce Tracy
==========================

Dla Å‚atwego debugowania wÅ‚Ä…czymy jeszcze Å›wietne narzÄ™dzie [Tracy |tracy:]. W trybie deweloperskim wizualizuje bÅ‚Ä™dy, a w trybie produkcyjnym loguje bÅ‚Ä™dy do podanego katalogu:

```php
$this->configurator->enableTracy($this->rootDir . '/log');
```


Pliki tymczasowe
================

Nette wykorzystuje cache dla kontenera DI, RobotLoadera, szablonÃ³w itp. Dlatego konieczne jest ustawienie Å›cieÅ¼ki do katalogu, w ktÃ³rym bÄ™dzie przechowywany cache:

```php
$this->configurator->setTempDirectory($this->rootDir . '/temp');
```

Na Linuksie lub macOS ustaw katalogom `log/` i `temp/` [uprawnienia do zapisu |nette:troubleshooting#NastavenÃ­ prÃ¡v adresÃ¡Å™Å¯].


RobotLoader
===========

Zazwyczaj bÄ™dziemy chcieli automatycznie Å‚adowaÄ‡ klasy za pomocÄ… [RobotLoader |robot-loader:], musimy go wiÄ™c uruchomiÄ‡ i pozwoliÄ‡ mu Å‚adowaÄ‡ klasy z katalogu, w ktÃ³rym znajduje siÄ™ `Bootstrap.php` (tj. `__DIR__`), oraz wszystkich podkatalogÃ³w:

```php
$this->configurator->createRobotLoader()
	->addDirectory(__DIR__)
	->register();
```

Alternatywnym podejÅ›ciem jest Å‚adowanie klas wyÅ‚Ä…cznie przez [Composer |best-practices:composer] przy zachowaniu PSR-4.


Timezone
========

Za pomocÄ… konfiguratora moÅ¼na ustawiÄ‡ domyÅ›lnÄ… strefÄ™ czasowÄ….

```php
$this->configurator->setTimeZone('Europe/Prague');
```


Konfiguracja kontenera DI
=========================

CzÄ™Å›ciÄ… procesu startowego jest utworzenie kontenera DI, czyli fabryki obiektÃ³w, ktÃ³ra jest sercem caÅ‚ej aplikacji. Jest to wÅ‚aÅ›ciwie klasa PHP, ktÃ³rÄ… generuje Nette i zapisuje w katalogu z cache. Fabryka tworzy kluczowe obiekty aplikacji, a za pomocÄ… plikÃ³w konfiguracyjnych instruujemy jÄ…, jak ma je tworzyÄ‡ i ustawiaÄ‡, co wpÅ‚ywa na zachowanie caÅ‚ej aplikacji.

Pliki konfiguracyjne zazwyczaj zapisuje siÄ™ w formacie [NEON |neon:format]. W osobnym rozdziale dowiesz siÄ™, [co moÅ¼na skonfigurowaÄ‡ |nette:configuring].

.[tip]
W trybie deweloperskim kontener automatycznie aktualizuje siÄ™ przy kaÅ¼dej zmianie kodu lub plikÃ³w konfiguracyjnych. W trybie produkcyjnym generowany jest tylko raz, a zmiany nie sÄ… sprawdzane w celu maksymalizacji wydajnoÅ›ci.

Pliki konfiguracyjne Å‚adujemy za pomocÄ… `addConfig()`:

```php
$this->configurator->addConfig($this->rootDir . '/config/common.neon');
```

JeÅ›li chcemy dodaÄ‡ wiÄ™cej plikÃ³w konfiguracyjnych, moÅ¼emy wywoÅ‚aÄ‡ funkcjÄ™ `addConfig()` wielokrotnie.

```php
$configDir = $this->rootDir . '/config';
$this->configurator->addConfig($configDir . '/common.neon');
$this->configurator->addConfig($configDir . '/services.neon');
if (PHP_SAPI === 'cli') {
	$this->configurator->addConfig($configDir . '/cli.php');
}
```

Nazwa `cli.php` nie jest pomyÅ‚kÄ…, konfiguracja moÅ¼e byÄ‡ zapisana rÃ³wnieÅ¼ w pliku PHP, ktÃ³ry zwraca jÄ… jako tablicÄ™.

MoÅ¼emy rÃ³wnieÅ¼ dodaÄ‡ inne pliki konfiguracyjne w [sekcji `includes` |dependency-injection:configuration#VklÃ¡dÃ¡nÃ­ souborÅ¯].

JeÅ›li w plikach konfiguracyjnych pojawiÄ… siÄ™ elementy o tych samych kluczach, zostanÄ… one nadpisane lub w przypadku [tablic poÅ‚Ä…czone |dependency-injection:configuration#SluÄovÃ¡nÃ­]. PÃ³Åºniej doÅ‚Ä…czony plik ma wyÅ¼szy priorytet niÅ¼ poprzedni. Plik, w ktÃ³rym znajduje siÄ™ sekcja `includes`, ma wyÅ¼szy priorytet niÅ¼ pliki w nim zawarte.


Parametry statyczne
-------------------

Parametry uÅ¼ywane w plikach konfiguracyjnych moÅ¼emy zdefiniowaÄ‡ [w sekcji `parameters`|dependency-injection:configuration#parametry], a takÅ¼e przekazywaÄ‡ (lub nadpisywaÄ‡) metodÄ… `addStaticParameters()` (ma alias `addParameters()`). WaÅ¼ne jest, Å¼e rÃ³Å¼ne wartoÅ›ci parametrÃ³w spowodujÄ… wygenerowanie kolejnych kontenerÃ³w DI, czyli kolejnych klas.

```php
$this->configurator->addStaticParameters([
	'projectId' => 23,
]);
```

Do parametru `projectId` moÅ¼na odwoÅ‚aÄ‡ siÄ™ w konfiguracji za pomocÄ… zwykÅ‚ego zapisu `%projectId%`.


Parametry dynamiczne
--------------------

Do kontenera moÅ¼emy dodaÄ‡ rÃ³wnieÅ¼ parametry dynamiczne, ktÃ³rych rÃ³Å¼ne wartoÅ›ci, w przeciwieÅ„stwie do parametrÃ³w statycznych, nie spowodujÄ… generowania nowych kontenerÃ³w DI.

```php
$this->configurator->addDynamicParameters([
	'remoteIp' => $_SERVER['REMOTE_ADDR'],
]);
```

W prosty sposÃ³b moÅ¼emy dodaÄ‡ np. zmienne Å›rodowiskowe, do ktÃ³rych moÅ¼na siÄ™ nastÄ™pnie odwoÅ‚aÄ‡ w konfiguracji za pomocÄ… zapisu `%env.variable%`.

```php
$this->configurator->addDynamicParameters([
	'env' => getenv(),
]);
```


Parametry domyÅ›lne
------------------

W plikach konfiguracyjnych moÅ¼na uÅ¼ywaÄ‡ nastÄ™pujÄ…cych parametrÃ³w statycznych:

- `%appDir%` to Å›cieÅ¼ka absolutna do katalogu z plikiem `Bootstrap.php`
- `%wwwDir%` to Å›cieÅ¼ka absolutna do katalogu z plikiem wejÅ›ciowym `index.php`
- `%tempDir%` to Å›cieÅ¼ka absolutna do katalogu dla plikÃ³w tymczasowych
- `%vendorDir%` to Å›cieÅ¼ka absolutna do katalogu, w ktÃ³rym Composer instaluje biblioteki
- `%rootDir%` to Å›cieÅ¼ka absolutna do katalogu gÅ‚Ã³wnego projektu
- `%debugMode%` wskazuje, czy aplikacja jest w trybie debugowania
- `%consoleMode%` wskazuje, czy Å¼Ä…danie przyszÅ‚o przez wiersz poleceÅ„


UsÅ‚ugi importowane
------------------

Teraz zagÅ‚Ä™biamy siÄ™ bardziej. ChociaÅ¼ celem kontenera DI jest tworzenie obiektÃ³w, wyjÄ…tkowo moÅ¼e zaistnieÄ‡ potrzeba wstawienia istniejÄ…cego obiektu do kontenera. Robimy to, definiujÄ…c usÅ‚ugÄ™ z flagÄ… `imported: true`.

```neon
services:
	myservice:
		type: App\Model\MyCustomService
		imported: true
```

A w bootstrapie wstawiamy obiekt do kontenera:

```php
$this->configurator->addServices([
	'myservice' => new App\Model\MyCustomService('foobar'),
]);
```


Odmienne Å›rodowisko
===================

Nie bÃ³j siÄ™ modyfikowaÄ‡ klasy Bootstrap wedÅ‚ug wÅ‚asnych potrzeb. Do metody `bootWebApplication()` moÅ¼esz dodaÄ‡ parametry do rozrÃ³Å¼niania projektÃ³w webowych. MoÅ¼emy teÅ¼ dodaÄ‡ inne metody, na przykÅ‚ad `bootTestEnvironment()`, ktÃ³ra inicjalizuje Å›rodowisko dla testÃ³w jednostkowych, `bootConsoleApplication()` dla skryptÃ³w wywoÅ‚ywanych z wiersza poleceÅ„ itp.

```php
public function bootTestEnvironment(): Nette\DI\Container
{
	Tester\Environment::setup(); // inicjalizacja Nette Testera
	$this->setupContainer();
	return $this->configurator->createContainer();
}

public function bootConsoleApplication(): Nette\DI\Container
{
	$this->configurator->setDebugMode(false);
	$this->initializeEnvironment();
	$this->setupContainer();
	return $this->configurator->createContainer();
}
```
